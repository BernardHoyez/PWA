<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARL - Générateur cartes offline</title>
    <style>
        /* Ton beau CSS d'origine – je le remets complet pour que tu n'aies rien à rajouter */
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333;}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;}
        .header{background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);color:white;padding:30px;text-align:center;}
        .header h1{font-size:2.5em;margin-bottom:10px;}
        .content{padding:30px;}
        .section{margin-bottom:30px;padding:25px;background:#f8fafc;border-radius:15px;border:2px solid #e2e8f0;}
        .section h2{color:#2563eb;margin-bottom:20px;font-size:1.5em;display:flex;align-items:center;gap:10px;}
        .input-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0;}
        input,select{width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:10px;font-size:1em;background:white;}
        .btn{padding:14px 25px;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .3s;margin:10px 5px 10px 0;}
        .btn-primary{background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);color:white;box-shadow:0 4px 15px rgba(37,99,235,0.4);}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(37,99,235,0.5);}
        .btn-success{background:#10b981;color:white;}
        #map{width:100%;height:420px;border-radius:15px;margin-top:20px;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
        .progress-container{display:none;margin-top:25px;padding:20px;background:#f0f9ff;border:2px solid #0ea5e9;border-radius:12px;}
        .progress-bar{height:36px;background:#e0e7ff;border-radius:18px;overflow:hidden;margin-bottom:12px;}
        .progress-fill{height:100%;background:linear-gradient(90deg,#2563eb,#3b82f6);width:0%;transition:width .4s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;}
        .folder-section{background:#fefce8;border:2px solid #f59e0b;border-radius:15px;padding:20px;margin:20px 0;}
        @media(max-width:768px){.input-row{grid-template-columns:1fr;}}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0/sql-wasm.min.js"></script>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ARL - Cartes offline</h1>
        <p>Générateur .sqlitedb 100 % compatible OSMand · Locus · Guru Maps</p>
    </div>
    
    <div class="content">
        <div class="section">
            <h2>Carte source</h2>
            <select id="tileSource" onchange="changeTileSource()">
                <option value="osm">OpenStreetMap</option>
                <option value="ign">IGN Plan v2 (France)</option>
            </select>
        </div>

        <div class="section">
            <h2>Centre de la zone</h2>
            <div class="input-row">
                <input type="number" id="lat" step="0.000001" value="49.515" placeholder="Latitude">
                <input type="number" id="lon" step="0.000001" value="0.107" placeholder="Longitude">
            </div>
            <button class="btn btn-primary" onclick="setCenterManual()">Appliquer</button>
            <button class="btn btn-primary" onclick="setCenterGPS()">Ma position GPS</button>
            <div id="map"></div>
        </div>

        <div class="section">
            <h2>Paramètres</h2>
            <label>Rayon : <strong id="radiusValue">5 km</strong></label><br>
            <input type="range" id="radius" min="1" max="20" value="5" step="0.5" oninput="updateRadius()" style="width:100%;margin:15px 0;">

            <div class="input-row">
                <div><label>Zoom min</label><input type="number" id="minZoom" value="11" min="8" max="17"></div>
                <div><label>Zoom max</label><input type="number" id="maxZoom" value="16" min="12" max="18"></div>
            </div>

            <!-- CHOIX DU DOSSIER PERSISTENT -->
            <div class="folder-section">
                <h3>Dossier de sauvegarde</h3>
                <button class="btn btn-primary" onclick="chooseFolder()" id="folderBtn">
                    Choisir le dossier de destination
                </button>
                <div id="folderStatus" style="margin-top:12px;font-size:0.95em;">
                    Aucune destination choisie → téléchargement classique
                </div>
            </div>

            <button class="btn btn-primary" onclick="generateMap()" style="width:100%;padding:18px;font-size:1.2em;">
                Générer la carte .sqlitedb
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
                <div style="text-align:center;" id="progressText">Préparation…</div>
            </div>
        </div>
    </div>
</div>

<script>
let map, marker, circle, centerLat = 49.515, centerLon = 0.107;
let tileLayer, source = 'osm';
let directoryHandle = null;  // ← ici le dossier persistant

// --- MAP ---
function initMap() {
    map = L.map('map').setView([centerLat, centerLon], 13);
    tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
    marker = L.marker([centerLat, centerLon], {draggable:true}).addTo(map);
    circle = L.circle([centerLat, centerLon], {radius:5000, color:'#2563eb', fillOpacity:0.15}).addTo(map);

    map.on('click', e=>{ centerLat=e.latlng.lat; centerLon=e.latlng.lng; updateCenter(); });
    marker.on('dragend', e=>{ const p=e.target.getLatLng(); centerLat=p.lat; centerLon=p.lng; updateCenter(); });
}
function changeTileSource() {
    source = document.getElementById('tileSource').value;
    map.removeLayer(tileLayer);
    tileLayer = L.tileLayer(source==='osm' 
        ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        : 'https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}',
        {attribution: source==='osm'?'© OSM':'© IGN', maxZoom: source==='ign'?18:19}
    ).addTo(map);
}
function updateCenter() {
    marker.setLatLng([centerLat, centerLon]);
    circle.setLatLng([centerLat, centerLon]);
    map.setView([centerLat, centerLon], map.getZoom());
    document.getElementById('lat').value = centerLat.toFixed(6);
    document.getElementById('lon').value = centerLon.toFixed(6);
}
function setCenterManual(){ centerLat=+document.getElementById('lat').value; centerLon=+document.getElementById('lon').value; updateCenter(); }
function setCenterGPS(){ navigator.geolocation.getCurrentPosition(p=>{centerLat=p.coords.latitude; centerLon=p.coords.longitude; updateCenter();}); }
function updateRadius(){ const r=document.getElementById('radius').value; document.getElementById('radiusValue').textContent=r+' km'; circle.setRadius(r*1000); }

// --- CHOIX DU DOSSIER PERSISTENT ---
async function chooseFolder() {
    try {
        directoryHandle = await window.showDirectoryPicker({
            mode: 'readwrite'
        });
        document.getElementById('folderBtn').textContent = 'Dossier choisi !';
        document.getElementById('folderBtn').classList.add('btn-success');
        document.getElementById('folderStatus').innerHTML = `<strong>${directoryHandle.name}</strong><br>Toutes les prochaines cartes seront sauvegardées ici automatiquement`;
    } catch (e) {
        if (e.name !== 'AbortError') alert('Erreur accès dossier : '+e.message);
    }
}

// --- CALCUL DES TUILES ---
function getBounds(lat, lon, km, z) {
    const deg = (km / 111) / Math.cos(lat * Math.PI / 180); // approximation rapide
    const minLat = lat - deg, maxLat = lat + deg;
    const minLon = lon - deg, maxLon = lon + deg;
    const lon2tile = (lon,z) => Math.floor((lon+180)/360 * (1<<z));
    const lat2tile = (lat,z) => Math.floor((1 - Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 * (1<<z));
    return {
        x1: lon2tile(minLon,z), x2: lon2tile(maxLon,z),
        y1: lat2tile(maxLat,z), y2: lat2tile(minLat,z)
    };
}

// --- GÉNÉRATION ---
async function generateMap() {
    const SQL = await initSqlJs({locateFile: f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0/${f}`});
    const db = new SQL.Database();

    // Structure 100 % compatible OSMand
    db.exec("PRAGMA application_id = 0x53514c54;"); // SQLT
    db.exec(`CREATE TABLE tiles(x INTEGER NOT NULL, y INTEGER NOT NULL, z INTEGER NOT NULL, s INTEGER NOT NULL DEFAULT 0, image BLOB NOT NULL, PRIMARY KEY(x,y,z,s))`);
    db.exec(`CREATE INDEX IND ON tiles(z,x,y)`);
