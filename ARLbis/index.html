<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Générateur SQLITEDB / MBTiles OSMAnd</title>

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

<style>
body { font-family: sans-serif; margin: 0; padding: 0; }
#map { height: 60vh; width: 100%; }
.controls { padding: 10px; background: #f0f0f0; }
label { display: block; margin-top: 10px; }
</style>
</head>
<body>

<h2 style="padding:10px">Créateur de tuiles (.sqlitedb / .mbtiles) format OSMAnd / BigPlanet</h2>

<div id="map"></div>

<div class="controls">
  <label>Fond de carte:
    <select id="basemap">
      <option value="osm">OSM</option>
      <option value="ign">IGNv2</option>
    </select>
  </label>

  <button id="gpsBtn">Centre = GPS</button>

  <label>Rayon (km): 
    <input type="range" id="radius" min="1" max="50" value="5" />
  </label>

  <label>Format de sortie:
    <select id="outputFormat">
      <option value="sqlitedb">OSMand (.sqlitedb)</option>
      <option value="mbtiles">MBTiles (.mbtiles)</option>
    </select>
  </label>

  <button id="generate">Générer</button>
  <div id="info"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://sql.js.org/dist/sql-wasm.js"></script>

<script>
/* ------------------- MAP -------------------- */

let map = L.map('map', { zoomControl: true }).setView([44, 6], 10);

const tileOSM = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png');
const tileIGN = L.tileLayer('https://wxs.ign.fr/essentiels/geoportail/tms/1.0.0/PLAN.IGNV2/{z}/{x}/{y}.png');

let currentLayer = tileOSM.addTo(map);

basemap.onchange = () => {
  map.removeLayer(currentLayer);
  currentLayer = (basemap.value === "osm") ? tileOSM : tileIGN;
  currentLayer.addTo(map);
};

// CERCLE
let circle = L.circle(map.getCenter(), { radius: 5000 }).addTo(map);

// MARQUEUR DE CENTRE
let centerMarker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
centerMarker.on("dragend", updateInfo);

// CHOIX DU CENTRE PAR CLIC CARTE
map.on("click", e => {
  map.setView(e.latlng);
  centerMarker.setLatLng(e.latlng);
  updateInfo();
});

// GPS
gpsBtn.onclick = () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const p = [pos.coords.latitude, pos.coords.longitude];
      map.setView(p, 14);
      centerMarker.setLatLng(p);
      updateInfo();
    });
  }
};

radius.oninput = updateInfo;
updateInfo();

function updateInfo() {
  const c = centerMarker.getLatLng();
  const r = radius.value;

  circle.setLatLng(c);
  circle.setRadius(r * 1000);

  info.innerText = `Centre: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)} | Rayon: ${r} km`;
}

/* ------------------- GENERATION -------------------- */

generate.onclick = () => generateTiles();

async function generateTiles() {

  const format = outputFormat.value;
  const center = centerMarker.getLatLng();
  const r = radius.value * 1000;

  const sql = await initSqlJs({ locateFile: f => `https://sql.js.org/dist/${f}` });
  const db = new sql.Database();

  /* TABLES POUR MBTILES */
  if (format === "mbtiles") {
      db.run(`
        CREATE TABLE metadata (name TEXT, value TEXT);
        CREATE TABLE tiles (zoom_level INTEGER, tile_column INTEGER, tile_row INTEGER, tile_data BLOB);
      `);
      db.run(`INSERT INTO metadata VALUES ('name','export');`);
  }

  /* TABLES POUR OSMAnd / BIGPLANET (.sqlitedb) */
  else if (format === "sqlitedb") {

      db.run(`
        CREATE TABLE android_metadata (locale TEXT);
      `);
      db.run(`INSERT INTO android_metadata VALUES ('fr_FR');`);

      db.run(`
        CREATE TABLE tiles (
          x INTEGER, 
          y INTEGER, 
          z INTEGER, 
          s INTEGER, 
          image BLOB, 
          PRIMARY KEY (x,y,z,s)
        );
      `);
  }

  const minZoom = 8;
  const maxZoom = 15;

  for (let z = minZoom; z <= maxZoom; z++) {

    let tileRadius = r / (40075000 * Math.cos(center.lat * Math.PI/180) / Math.pow(2, z)) / 256;

    for (let dx = -tileRadius; dx <= tileRadius; dx++) {
      for (let dy = -tileRadius; dy <= tileRadius; dy++) {

        let x = long2tile(center.lng, z) + dx;
        let y = lat2tile(center.lat, z) + dy;

        // URL des tuiles OSM
        let url = `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;

        try {
          let response = await fetch(url);
          if (!response.ok) continue;

          let blob = new Uint8Array(await response.arrayBuffer());

          if (format === "mbtiles") {
            let tmsY = (Math.pow(2, z) - 1) - y; // conversion TMS
            db.run(
              "INSERT INTO tiles (zoom_level, tile_column, tile_row, tile_data) VALUES (?, ?, ?, ?)",
              [z, x, tmsY, blob]
            );
          }

          if (format === "sqlitedb") {
            db.run(
              "INSERT OR REPLACE INTO tiles (x,y,z,s,image) VALUES (?,?,?,?,?)",
              [x, y, z, 0, blob]
            );
          }

        } catch(e) {}
      }
    }
  }

  // EXPORT
  const data = db.export();
  const buffer = new Blob([data]);

  const filename = (format === "mbtiles") ? "carte.mbtiles" : "carte.sqlitedb";

  const a = document.createElement("a");
  a.href = URL.createObjectURL(buffer);
  a.download = filename;
  a.click();
}

/* ---------------- UTILS ---------------- */

function long2tile(lon, zoom) {
  return (Math.floor((lon + 180) / 360 * Math.pow(2, zoom)));
}
function lat2tile(lat, zoom) {
  return (Math.floor(
    (1 - Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180)) / Math.PI) / 2 * Math.pow(2, zoom)
  ));
}

</script>

</body>
</html>
