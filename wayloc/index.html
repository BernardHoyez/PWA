<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>wayloc</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0f172a">

<link rel="manifest" href="./manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">

<style>
html,body { margin:0; height:100%; font-family:Arial; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  left:8px;
  right:8px;
  bottom:8px;
  background:white;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.35);
  z-index:1000;
  overflow:hidden;
}

.header {
  padding:8px;
  background:#e2e8f0;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}

.body { padding:8px; display:none; }
.panel.open .body { display:block; }

button {
  padding:10px;
  font-size:14px;
  flex:1;
}

.row { display:flex; gap:6px; margin-top:6px; }

#addBtn {
  font-size:18px;
  font-weight:bold;
}

.pointItem {
  font-size:13px;
  margin-top:4px;
  display:flex;
  justify-content:space-between;
}
</style>
</head>

<body>

<div class="panel open" id="panel">
  <div class="header" onclick="panel.classList.toggle('open')">
    wayloc ‚Äî points terrain
    <span>‚ñæ</span>
  </div>

  <div class="body">

    <div class="row">
      <button id="addBtn">üìç Ajouter point</button>
      <button id="gpsBtn">üß≠</button>
      <button id="gpxBtn">‚¨áÔ∏è GPX</button>
    </div>

    <div id="list"></div>

  </div>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>

<script>

// ---------- IGN PLAN V2 ----------

const ign = new ol.layer.Tile({
  source: new ol.source.WMTS({
    url: "https://data.geopf.fr/wmts",
    layer: "GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2",
    matrixSet: "PM",
    format: "image/png",
    style: "normal",
    tileGrid: new ol.tilegrid.WMTS({
      origin: [-20037508,20037508],
      resolutions: [
        156543.033928,78271.516964,39135.758482,19567.879241,
        9783.9396205,4891.96981025,2445.98490513,1222.99245256,
        611.496226281,305.748113141,152.87405657,76.4370282852,
        38.2185141426,19.1092570713,9.55462853565,4.77731426782,
        2.38865713391,1.19432856696,0.597164283478
      ],
      matrixIds: Array.from({length:19},(_,i)=>String(i))
    })
  })
});

const vSource = new ol.source.Vector();
const vLayer = new ol.layer.Vector({ source:vSource });

const map = new ol.Map({
  target:"map",
  layers:[ign,vLayer],
  view:new ol.View({
    center: ol.proj.fromLonLat([6.18,43.47]),
    zoom:14
  })
});

// ---------- WAYPOINTS ----------

let pts = [];

function addMarker(lon,lat,id){
  const f = new ol.Feature({
    geometry:new ol.geom.Point(
      ol.proj.fromLonLat([lon,lat])
    )
  });
  f.setId(id);
  vSource.addFeature(f);
}

function refreshList(){
  list.innerHTML="";
  pts.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="pointItem";
    d.innerHTML=
      `${i+1} ‚Äî ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}
       <button onclick="delPt(${i})">‚úñ</button>`;
    list.appendChild(d);
  });
}

function delPt(i){
  pts.splice(i,1);
  vSource.clear();
  pts.forEach((p,j)=>addMarker(p.lon,p.lat,j));
  refreshList();
}

// ---------- ADD POINT ----------

addBtn.onclick=()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    pts.push({
      lat,lon,
      t:new Date().toISOString()
    });

    addMarker(lon,lat,pts.length-1);

    map.getView().animate({
      center: ol.proj.fromLonLat([lon,lat]),
      zoom:16
    });

    refreshList();
  });
};

// ---------- GPS CENTER ----------

gpsBtn.onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    map.getView().animate({
      center: ol.proj.fromLonLat(
        [p.coords.longitude,p.coords.latitude]
      ),
      zoom:16
    });
  });
};

// ---------- GPX EXPORT ----------

gpxBtn.onclick=()=>{

let gpx=`<?xml version="1.0"?>
<gpx version="1.1" creator="wayloc">
`;

pts.forEach((p,i)=>{
gpx+=`
<wpt lat="${p.lat}" lon="${p.lon}">
<name>P${i+1}</name>
<time>${p.t}</time>
</wpt>`;
});

gpx+=`\n</gpx>`;

const blob=new Blob([gpx],{type:"application/gpx+xml"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="wayloc_points.gpx";
a.click();
};

// ---------- SW ----------

if("serviceWorker" in navigator){
 navigator.serviceWorker.register("./sw.js");
}

</script>
</body>
</html>
