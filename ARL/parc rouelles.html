<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>trace-Le Havre-9.57km-2025-11-30</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{margin:0;font-family:system-ui}
#map{height:100vh}
.controls{position:absolute;top:10px;left:10px;z-index:1000;background:white;padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);max-width:90vw}
.controls button{margin:5px;padding:12px 18px;border:none;border-radius:5px;cursor:pointer;background:#007bff;color:white;font-size:15px;font-weight:600;white-space:nowrap}
.controls button:hover{background:#0056b3}
.controls button:active{transform:scale(0.95)}
.stats{position:absolute;bottom:10px;left:10px;z-index:1000;background:white;padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:14px;max-width:90vw}
.stats h3{margin:0 0 10px 0;font-size:16px}
.stats p{margin:5px 0}
@media (max-width: 768px){
  .controls{padding:10px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
  .controls button{margin:0;padding:16px 24px;font-size:17px;min-width:140px;flex:1 1 calc(50% - 5px);font-weight:700}
  .stats{font-size:13px;padding:12px}
  .stats h3{font-size:15px}
}
@media print{.controls{display:none}.stats{bottom:auto;top:10px;right:10px;left:auto}}
</style>
</head><body>
<div id="map"></div>
<div class="controls">
<button onclick="download('gpx')">ğŸ“¥ GPX</button>
<button onclick="download('kml')">ğŸ“¥ KML</button>
<button onclick="download('geojson')">ğŸ“¥ GeoJSON</button>
<button onclick="share()">ğŸ”— Partager</button>
<button onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
<button onclick="exportPDF()">ğŸ“„ PDF</button>
</div>
<div class="stats">
<h3>ğŸ“Š Statistiques</h3>
<p><strong>Distance:</strong> 9.57 km</p>



</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/togpx@0.5.4/togpx.js"></script>
<script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>
<script>
const g = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[0.180738,49.535412,0],[0.180674,49.53549499999999,0],[0.180266,49.535412,0],[0.179515,49.535224,0],[0.178946,49.535043,0],[0.178581,49.535356,0],[0.178335,49.535301,0],[0.178367,49.53521000000001,0],[0.177863,49.534897,0],[0.177745,49.53476500000001,0],[0.178463,49.534549,0],[0.178163,49.53443800000001,0],[0.17797,49.53429199999999,0],[0.177906,49.53382499999999,0],[0.177948,49.53337999999999,0],[0.177948,49.53299000000001,0],[0.177863,49.532733,0],[0.177755,49.532294,0],[0.178367,49.532106,0],[0.179032,49.53135499999999,0],[0.17959,49.530429,0],[0.180116,49.52958,0],[0.180523,49.529107,0],[0.181006,49.52850099999999,0],[0.181231,49.528271,0],[0.181403,49.528146,0],[0.181575,49.527923,0],[0.18165,49.527784,0],[0.181596,49.527701,0],[0.181779,49.52715800000001,0],[0.181822,49.52672599999999,0],[0.181746,49.526476,0],[0.181607,49.52621799999999,0],[0.181371,49.526023,0],[0.181564,49.525821,0],[0.181714,49.525557,0],[0.181886,49.525362,0],[0.182036,49.525139,0],[0.182068,49.52499299999999,0],[0.1818,49.52505599999999,0],[0.181328,49.52521600000001,0],[0.181167,49.525299,0],[0.180663,49.52525099999999,0],[0.180341,49.52523,0],[0.180384,49.524722,0],[0.180373,49.52430400000001,0],[0.180416,49.52413,0],[0.180641,49.52402599999999,0],[0.18092,49.52396299999999,0],[0.181081,49.523684,0],[0.181189,49.523531,0],[0.181553,49.523483,0],[0.181993,49.523448,0],[0.182605,49.52358,0],[0.183184,49.523538,0],[0.183613,49.523399,0],[0.183946,49.523148,0],[0.184085,49.52294700000001,0],[0.184042,49.522689,0],[0.18459,49.522585,0],[0.184976,49.52241100000001,0],[0.185448,49.52202100000001,0],[0.185909,49.521673,0],[0.186371,49.521387,0],[0.186725,49.521178,0],[0.187154,49.520956,0],[0.187583,49.520712,0],[0.187583,49.52051000000001,0],[0.187465,49.520343,0],[0.187272,49.520155,0],[0.187089,49.520155,0],[0.186861,49.520181,0],[0.18673,49.520263,0],[0.186658,49.52031,0],[0.186574,49.520358,0],[0.186518,49.5204,0],[0.18647,49.52042500000001,0],[0.186403,49.52043799999999,0],[0.186304,49.520444,0],[0.186188,49.520487,0],[0.186135,49.520543,0],[0.185987,49.52065600000001,0],[0.185877,49.52075,0],[0.185746,49.520839,0],[0.185571,49.520926,0],[0.185322,49.521039,0],[0.185198,49.521095,0],[0.185005,49.521159,0],[0.184793,49.521209,0],[0.184477,49.52127900000001,0],[0.184287,49.52131399999999,0],[0.184136,49.521309,0],[0.184016,49.52134000000001,0],[0.183943,49.521369,0],[0.18386,49.521343,0],[0.183814,49.521267,0],[0.183696,49.52126,0],[0.183554,49.521286,0],[0.183522,49.521235,0],[0.183468,49.52111,0],[0.18349,49.520993,0],[0.183479,49.52087000000001,0],[0.183468,49.520793,0],[0.183458,49.520746,0],[0.183511,49.520648,0],[0.183447,49.520484,0],[0.183372,49.520348,0],[0.183286,49.520185,0],[0.183147,49.520011,0],[0.183023,49.519781,0],[0.182873,49.519621,0],[0.182814,49.519527,0],[0.18276,49.51945,0],[0.182664,49.519353,0],[0.182599,49.51923799999999,0],[0.182573,49.519032,0],[0.182594,49.51896600000001,0],[0.182422,49.51888100000001,0],[0.182111,49.518937,0],[0.181704,49.519027,0],[0.181028,49.519292,0],[0.180588,49.519473,0],[0.180459,49.519417,0],[0.180341,49.519299,0],[0.180244,49.519118,0],[0.179858,49.51916599999999,0],[0.179472,49.5192,0],[0.179257,49.519186,0],[0.179139,49.518901,0],[0.179687,49.518476,0],[0.179944,49.518121,0],[0.180384,49.517571,0],[0.180438,49.517195,0],[0.180352,49.516618,0],[0.18032,49.516172,0],[0.180223,49.515775,0],[0.180051,49.515525,0],[0.180035,49.515373,0],[0.179912,49.515206,0],[0.179864,49.515108,0],[0.17988,49.514896,0],[0.179703,49.514743,0],[0.179375,49.514618,0],[0.179177,49.514583,0],[0.178919,49.514572,0],[0.178796,49.51470499999999,0],[0.178678,49.515049,0],[0.17863,49.515248,0],[0.178689,49.515358,0],[0.179193,49.515226,0],[0.179461,49.515247,0],[0.179574,49.515366,0],[0.179628,49.515575,0],[0.179638,49.515732,0],[0.179649,49.51594,0],[0.179633,49.516149,0],[0.179622,49.51633,0],[0.179644,49.51663,0],[0.179644,49.516776,0],[0.179638,49.516981,0],[0.179628,49.517152,0],[0.179644,49.517288,0],[0.179536,49.517399,0],[0.179392,49.51758700000001,0],[0.179193,49.517768,0],[0.179043,49.517914,0],[0.178887,49.518046,0],[0.178775,49.518245,0],[0.178678,49.518454,0],[0.178592,49.5186,0],[0.17849,49.51876300000001,0],[0.178362,49.518882,0],[0.178297,49.518913,0],[0.178013,49.51878199999999,0],[0.177659,49.51866400000001,0],[0.177509,49.518629,0],[0.177442,49.518737,0],[0.177455,49.518956,0],[0.177444,49.51920500000001,0],[0.177391,49.519358,0],[0.177374,49.519521,0],[0.177412,49.51981,0],[0.177391,49.520061,0],[0.177155,49.520158,0],[0.176618,49.520193,0],[0.176221,49.52022099999999,0],[0.175813,49.520304,0],[0.175631,49.52053399999999,0],[0.175545,49.52066599999999,0],[0.175599,49.520986,0],[0.175577,49.521188,0],[0.175449,49.52155,0],[0.175309,49.521843,0],[0.174987,49.522072,0],[0.174934,49.522288,0],[0.17488,49.52244099999999,0],[0.17561,49.522386,0],[0.176167,49.52232300000001,0],[0.176747,49.522316,0],[0.176961,49.52230899999999,0],[0.177101,49.522344,0],[0.177251,49.522483,0],[0.177734,49.52263600000001,0],[0.17783,49.522887,0],[0.17768,49.522977,0],[0.177337,49.523137,0],[0.177026,49.52340199999999,0],[0.176833,49.523604,0],[0.176436,49.523646,0],[0.176103,49.523623,0],[0.175969,49.523525,0],[0.175883,49.523341,0],[0.175754,49.523194,0],[0.175454,49.523097,0],[0.175046,49.523048,0],[0.174869,49.523062,0],[0.174714,49.52307600000001,0],[0.174542,49.52300700000001,0],[0.174156,49.52286700000001,0],[0.173914,49.52283899999999,0],[0.173566,49.52278699999999,0],[0.173147,49.52274600000001,0],[0.172836,49.522704,0],[0.172455,49.52269700000001,0],[0.172348,49.522676,0],[0.172005,49.522721,0],[0.171549,49.522752,0],[0.171173,49.522784,0],[0.170782,49.52278699999999,0],[0.170556,49.522794,0],[0.170417,49.522732,0],[0.170229,49.522603,0],[0.169945,49.52251199999999,0],[0.169757,49.522446,0],[0.169435,49.52239700000001,0],[0.169221,49.522418,0],[0.168904,49.52253,0],[0.168797,49.522582,0],[0.168652,49.522617,0],[0.168094,49.522603,0],[0.167831,49.52258599999999,0],[0.16759,49.522606,0],[0.1673,49.522732,0],[0.167053,49.522836,0],[0.166742,49.522975,0],[0.166994,49.52296799999999,0],[0.167338,49.523,0],[0.167735,49.52308,0],[0.16803,49.523177,0],[0.168244,49.523278,0],[0.168496,49.52340300000001,0],[0.1687,49.52341400000001,0],[0.169253,49.523497,0],[0.169746,49.52361899999999,0],[0.170154,49.523706,0],[0.17069,49.523804,0],[0.171179,49.52389099999999,0],[0.171581,49.523943,0],[0.171849,49.523967,0],[0.17201,49.52405100000001,0],[0.17231,49.524204,0],[0.172525,49.52430100000001,0],[0.172369,49.524305,0],[0.172096,49.52427,0],[0.171914,49.524256,0],[0.171613,49.52420699999999,0],[0.171506,49.52419299999999,0],[0.171377,49.52416899999999,0],[0.171281,49.524423,0],[0.171195,49.524632,0],[0.171281,49.524722,0],[0.171425,49.52479199999999,0],[0.17142,49.524886,0],[0.171275,49.524928,0],[0.171162,49.525008,0],[0.171162,49.52507000000001,0],[0.171409,49.525161,0],[0.171554,49.525321,0],[0.171597,49.525404,0],[0.171844,49.525464,0],[0.172133,49.525509,0],[0.172504,49.52552299999999,0],[0.172847,49.52553699999999,0],[0.173244,49.52553699999999,0],[0.173587,49.52553,0],[0.173973,49.525554,0],[0.174118,49.525578,0],[0.174462,49.525648,0],[0.174676,49.5257,0],[0.17496,49.525711,0],[0.175282,49.525732,0],[0.175577,49.525725,0],[0.175862,49.525676,0],[0.176071,49.52561,0],[0.176264,49.52552299999999,0],[0.176318,49.525425,0],[0.176436,49.52540800000001,0],[0.176607,49.525509,0],[0.17672,49.525613,0],[0.176645,49.525742,0],[0.176377,49.525989,0],[0.176264,49.52614899999999,0],[0.176141,49.526302,0],[0.176092,49.526386,0],[0.175996,49.526466,0],[0.176055,49.52656,0],[0.176146,49.526612,0],[0.17628,49.526675,0],[0.176323,49.52670999999999,0],[0.176275,49.526745,0],[0.176082,49.52684199999999,0],[0.175915,49.526974,0],[0.175851,49.527061,0],[0.175792,49.527176,0],[0.175722,49.527288,0],[0.175738,49.527368,0],[0.175819,49.52748999999999,0],[0.175813,49.527618,0],[0.175733,49.52773999999999,0],[0.175556,49.52793499999999,0],[0.17532,49.528144,0],[0.175191,49.528304,0],[0.175009,49.52844,0],[0.174955,49.52853,0],[0.175116,49.528568,0],[0.175234,49.528506,0],[0.175384,49.528311,0],[0.175593,49.52821300000001,0],[0.175754,49.528255,0],[0.175797,49.52839099999999,0],[0.17576,49.528506,0],[0.175706,49.52873200000001,0],[0.175803,49.529031,0],[0.176103,49.529059,0],[0.176446,49.528927,0],[0.176919,49.528871,0],[0.177498,49.52865499999999,0],[0.177884,49.528377,0],[0.178206,49.52814,0],[0.178581,49.528001,0],[0.179129,49.527953,0],[0.179139,49.528071,0],[0.178989,49.52832799999999,0],[0.178839,49.528782,0],[0.178614,49.52901,0],[0.178474,49.529156,0],[0.178463,49.529469,0],[0.178732,49.529414,0],[0.179075,49.529379,0],[0.179172,49.529664,0],[0.179257,49.52986599999999,0],[0.179279,49.530075,0],[0.179032,49.53033900000001,0],[0.178946,49.53064599999999,0],[0.178882,49.530813,0],[0.178667,49.531028,0],[0.178421,49.53123699999999,0],[0.178249,49.531502,0],[0.178109,49.531766,0],[0.178163,49.532128,0],[0.17783,49.532191,0],[0.177605,49.532281,0],[0.177627,49.53241300000001,0],[0.177755,49.53284500000001,0],[0.177863,49.53311599999999,0],[0.177873,49.533499,0],[0.177798,49.533701,0],[0.177841,49.534035,0],[0.177884,49.534265,0],[0.177916,49.53445200000001,0],[0.178303,49.534557,0],[0.178024,49.534585,0],[0.177745,49.534682,0],[0.177594,49.53475899999999,0],[0.177659,49.534884,0],[0.178034,49.53512,0],[0.17826,49.53521800000001,0],[0.178217,49.535329,0],[0.178431,49.53542,0],[0.17871,49.535427,0],[0.17885,49.535239,0],[0.179054,49.535148,0],[0.179654,49.53532199999999,0],[0.180266,49.53548200000001,0],[0.180674,49.535594,0],[0.180867,49.535524,0],[0.18091,49.53538499999999,0]]},"properties":{},"id":"2tOqY"}]};

const map = L.map('map').fitBounds(L.geoJSON(g).getBounds());
L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}',{attribution:'&copy; IGN - Plan v2',maxZoom:19}).addTo(map);
L.geoJSON(g,{
  style:{color:'#c00',weight:6},
  filter: function(feature) {
    return feature.geometry.type !== 'Point';
  }
}).addTo(map);

function download(f){
  let data, ext, type;
  if(f==='gpx'){data=togpx(g);ext='gpx';type='application/gpx+xml';}
  if(f==='kml'){data=tokml(g);ext='kml';type='application/vnd.google-earth.kml+xml';}
  if(f==='geojson'){data=JSON.stringify(g,null,2);ext='geojson';type='application/geo+json';}
  
  const blob = new Blob([data],{type});
  
  // Essayer d'utiliser l'API File System Access (Chrome/Edge)
  if ('showSaveFilePicker' in window) {
    const opts = {
      suggestedName: 'trace-Le Havre-9.57km-2025-11-30.' + ext,
      types: [{
        description: ext.toUpperCase() + ' File',
        accept: {[type]: ['.' + ext]}
      }],
      startIn: 'documents'
    };
    
    window.showSaveFilePicker(opts).then(fileHandle => {
      return fileHandle.createWritable();
    }).then(writable => {
      writable.write(blob);
      return writable.close();
    }).catch(err => {
      // Si annulÃ© ou erreur, tÃ©lÃ©chargement classique
      if (err.name !== 'AbortError') {
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='trace-Le Havre-9.57km-2025-11-30.'+ext;
        a.click();
      }
    });
  } else {
    // TÃ©lÃ©chargement classique pour les navigateurs non compatibles
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='trace-Le Havre-9.57km-2025-11-30.'+ext;
    a.click();
  }
}

function share(){
  const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
  const file = new File([blob], 'trace-Le Havre-9.57km-2025-11-30.html', {type: 'text/html'});
  
  // Essayer d'utiliser l'API File System Access pour sauvegarder
  if ('showSaveFilePicker' in window) {
    const opts = {
      suggestedName: 'trace-Le Havre-9.57km-2025-11-30.html',
      types: [{
        description: 'HTML File',
        accept: {'text/html': ['.html']}
      }],
      startIn: 'documents'
    };
    
    window.showSaveFilePicker(opts).then(fileHandle => {
      return fileHandle.createWritable();
    }).then(writable => {
      writable.write(blob);
      return writable.close();
    }).then(() => {
      alert('Fichier HTML sauvegardÃ© avec succÃ¨s !');
    }).catch(err => {
      // Si annulÃ©, essayer Web Share API
      if (err.name === 'AbortError') {
        return;
      }
      // Fallback sur Web Share ou tÃ©lÃ©chargement
      if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
        navigator.share({files:[file],title:'trace-Le Havre-9.57km-2025-11-30',text:'DÃ©couvrez ma trace GPS'})
          .catch(err=>console.log('Partage annulÃ©'));
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'trace-Le Havre-9.57km-2025-11-30.html';
        a.click();
        URL.revokeObjectURL(url);
        alert('Fichier tÃ©lÃ©chargÃ©. Vous pouvez le partager par email ou autre moyen.');
      }
    });
  } else if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
    navigator.share({files:[file],title:'trace-Le Havre-9.57km-2025-11-30',text:'DÃ©couvrez ma trace GPS'})
      .catch(err=>console.log('Partage annulÃ©'));
  } else {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trace-Le Havre-9.57km-2025-11-30.html';
    a.click();
    URL.revokeObjectURL(url);
    alert('Fichier tÃ©lÃ©chargÃ©. Vous pouvez le partager par email ou autre moyen.');
  }
}

async function exportPDF(){
  const btn = event.target;
  btn.textContent = 'â³ GÃ©nÃ©ration...';
  btn.disabled = true;
  
  try{
    if (typeof window.jspdf === 'undefined') {
      throw new Error('jsPDF non chargÃ©');
    }
    
    // Attendre que toutes les tuiles soient chargÃ©es
    await new Promise(resolve => {
      let tilesLoading = 0;
      map.eachLayer(layer => {
        if (layer._tiles) {
          Object.keys(layer._tiles).forEach(key => {
            const tile = layer._tiles[key];
            if (!tile.complete) {
              tilesLoading++;
              tile.onload = () => {
                tilesLoading--;
                if (tilesLoading === 0) resolve();
              };
            }
          });
        }
      });
      if (tilesLoading === 0) resolve();
      // Timeout de sÃ©curitÃ© aprÃ¨s 5 secondes
      setTimeout(resolve, 5000);
    });
    
    // Petite pause supplÃ©mentaire pour Ãªtre sÃ»r
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const canvas = await html2canvas(document.body, {
      useCORS: true,
      allowTaint: false,
      logging: false,
      scale: 2,
      backgroundColor: '#ffffff'
    });
    
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    
    const orientation = canvas.width > canvas.height ? 'l' : 'p';
    const pdf = new jsPDF({
      orientation: orientation,
      unit: 'mm',
      format: 'a4'
    });
    
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * pageWidth) / canvas.width;
    
    let finalWidth = imgWidth;
    let finalHeight = imgHeight;
    if (imgHeight > pageHeight) {
      finalHeight = pageHeight;
      finalWidth = (canvas.width * pageHeight) / canvas.height;
    }
    
    pdf.addImage(imgData, 'JPEG', 0, 0, finalWidth, finalHeight);
    
    // Essayer de sauvegarder avec File System Access API
    if ('showSaveFilePicker' in window) {
      const pdfBlob = pdf.output('blob');
      const opts = {
        suggestedName: 'trace-Le Havre-9.57km-2025-11-30.pdf',
        types: [{
          description: 'PDF Document',
          accept: {'application/pdf': ['.pdf']}
        }],
        startIn: 'documents'
      };
      
      try {
        const fileHandle = await window.showSaveFilePicker(opts);
        const writable = await fileHandle.createWritable();
        await writable.write(pdfBlob);
        await writable.close();
        
        btn.textContent = 'âœ… PDF sauvegardÃ©';
      } catch(saveErr) {
        if (saveErr.name !== 'AbortError') {
          // Fallback sur tÃ©lÃ©chargement classique
          pdf.save('trace-Le Havre-9.57km-2025-11-30.pdf');
          btn.textContent = 'âœ… PDF crÃ©Ã©';
        } else {
          btn.textContent = 'ğŸ“„ PDF';
        }
      }
    } else {
      pdf.save('trace-Le Havre-9.57km-2025-11-30.pdf');
      btn.textContent = 'âœ… PDF crÃ©Ã©';
    }
    
    setTimeout(() => {
      btn.textContent = 'ğŸ“„ PDF';
    }, 2000);
  } catch(err){
    console.error('Erreur PDF:', err);
    try {
      const canvas = await html2canvas(document.body, {
        useCORS: true,
        allowTaint: false,
        logging: false,
        scale: 2
      });
      const imgData = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'trace-Le Havre-9.57km-2025-11-30.png';
      link.href = imgData;
      link.click();
      alert('Export PDF non disponible, image PNG gÃ©nÃ©rÃ©e Ã  la place.');
    } catch(err2) {
      alert('Erreur lors de la gÃ©nÃ©ration: ' + err2.message);
    }
    btn.textContent = 'ğŸ“„ PDF';
  } finally{
    btn.disabled = false;
  }
}
</script>
</body></html>