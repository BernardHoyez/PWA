
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditPOI - √âditeur de visites</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" href="icons/icon192.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 200px);
        }

        .left-panel {
            flex: 1;
            padding: 30px;
            border-right: 1px solid #e5e7eb;
        }

        .right-panel {
            width: 400px;
            padding: 30px;
            background: #f8fafc;
        }

        .visit-setup {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .poi-form {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .location-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .location-method {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .location-method:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .location-method.active {
            border-color: #2563eb;
            background: #dbeafe;
        }

        #map {
            height: 300px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .media-upload {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .media-item {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .media-item:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .media-preview {
            margin-top: 15px;
        }

        .media-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
        }

        .media-preview video, .media-preview audio {
            width: 100%;
            border-radius: 8px;
        }

        .poi-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .poi-list h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .poi-item {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: grab;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .poi-item:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .poi-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .poi-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .poi-item-title {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .poi-item-actions {
            display: flex;
            gap: 8px;
        }

        .poi-item-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .poi-item-btn:hover {
            background: #4b5563;
        }

        .poi-item-btn.edit {
            background: #2563eb;
        }

        .poi-item-btn.delete {
            background: #dc2626;
        }

        .poi-item-coords {
            font-size: 12px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .coordinates-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .right-panel {
                width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .location-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è EditPOI</h1>
            <p>Cr√©ateur et √©diteur de visites g√©olocalis√©es</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <!-- Configuration de la visite -->
                <div class="visit-setup" id="visit-setup">
                    <h2>üìã Configuration de la visite</h2>
                    <div class="input-group">
                        <label for="visit-title">Titre de la visite *</label>
                        <input type="text" id="visit-title" placeholder="Entrez le titre de votre visite..." required>
                    </div>
                    
                    <div class="input-group">
                        <label for="import-zip">Importer une visite existante (ZIP)</label>
                        <input type="file" id="import-zip" accept=".zip">
                    </div>
                    
                    <button class="btn" id="start-visit">Commencer la visite</button>
                </div>

                <!-- Formulaire POI -->
                <div class="poi-form hidden" id="poi-form">
                    <h2>üìç Ajouter un POI</h2>
                    
                    <div class="input-group">
                        <label for="poi-title">Titre du POI *</label>
                        <input type="text" id="poi-title" placeholder="Titre du point d'int√©r√™t..." required>
                    </div>

                    <div class="input-group">
                        <label for="poi-comment">Commentaire</label>
                        <textarea id="poi-comment" rows="3" placeholder="Description du POI..."></textarea>
                    </div>

                    <h3>üìç Localisation</h3>
                    <div class="location-methods">
                        <div class="location-method" data-method="exif">
                            <strong>üì∑ Image EXIF</strong>
                            <p>Extraire GPS de l'image</p>
                        </div>
                        <div class="location-method active" data-method="map">
                            <strong>üó∫Ô∏è Carte</strong>
                            <p>Pointer sur la carte</p>
                        </div>
                        <div class="location-method" data-method="manual">
                            <strong>‚úèÔ∏è Manuel</strong>
                            <p>Saisir coordonn√©es</p>
                        </div>
                    </div>

                    <div id="map"></div>
                    
                    <div class="coordinates-input hidden" id="manual-coords">
                        <div class="input-group">
                            <label for="poi-lat">Latitude</label>
                            <input type="number" id="poi-lat" step="any" placeholder="Ex: 48.8566">
                        </div>
                        <div class="input-group">
                            <label for="poi-lng">Longitude</label>
                            <input type="number" id="poi-lng" step="any" placeholder="Ex: 2.3522">
                        </div>
                    </div>

                    <h3>üé¨ M√©dias</h3>
                    <div class="media-upload">
                        <div class="media-item" id="image-upload">
                            <strong>üì∑ Image</strong>
                            <p>JPEG</p>
                            <input type="file" accept="image/jpeg" style="display: none;">
                            <div class="media-preview"></div>
                        </div>
                        <div class="media-item" id="audio-upload">
                            <strong>üéµ Audio</strong>
                            <p>MP3</p>
                            <input type="file" accept="audio/mp3" style="display: none;">
                            <div class="media-preview"></div>
                        </div>
                        <div class="media-item" id="video-upload">
                            <strong>üé¨ Vid√©o</strong>
                            <p>MP4</p>
                            <input type="file" accept="video/mp4" style="display: none;">
                            <div class="media-preview"></div>
                        </div>
                    </div>

                    <button class="btn" id="add-poi">Ajouter le POI</button>
                    <button class="btn btn-secondary" id="cancel-poi">Annuler</button>
                </div>

                <!-- Actions finales -->
                <div class="hidden" id="final-actions">
                    <button class="btn" id="new-poi">+ Nouveau POI</button>
                    <button class="btn btn-success" id="export-visit">üíæ Exporter la visite</button>
                    <button class="btn btn-secondary" id="new-visit">üÜï Nouvelle visite</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="poi-list">
                    <h3>üìç Points d'int√©r√™t (<span id="poi-count">0</span>)</h3>
                    <div id="poi-items"></div>
                    <div id="poi-empty" class="loading">
                        Aucun POI ajout√© pour le moment
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        class EditPOI {
            constructor() {
                this.visit = {
                    title: '',
                    pois: []
                };
                this.map = null;
                this.currentMarker = null;
                this.currentPOI = null;
                this.editingIndex = -1;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.registerServiceWorker();
            }

            setupEventListeners() {
                // Configuration visite
                document.getElementById('start-visit').addEventListener('click', () => this.startVisit());
                document.getElementById('import-zip').addEventListener('change', (e) => this.importZip(e));

                // M√©thodes de localisation
                document.querySelectorAll('.location-method').forEach(method => {
                    method.addEventListener('click', (e) => this.selectLocationMethod(e.target.closest('.location-method')));
                });

                // Formulaire POI
                document.getElementById('add-poi').addEventListener('click', () => this.addPOI());
                document.getElementById('cancel-poi').addEventListener('click', () => this.cancelPOI());

                // Upload m√©dias
                this.setupMediaUploads();

                // Actions finales
                document.getElementById('new-poi').addEventListener('click', () => this.newPOI());
                document.getElementById('export-visit').addEventListener('click', () => this.exportVisit());
                document.getElementById('new-visit').addEventListener('click', () => this.newVisit());

                // Coordonn√©es manuelles
                document.getElementById('poi-lat').addEventListener('input', () => this.updateManualCoords());
                document.getElementById('poi-lng').addEventListener('input', () => this.updateManualCoords());
            }

            setupMediaUploads() {
                const mediaItems = ['image-upload', 'audio-upload', 'video-upload'];
                mediaItems.forEach(itemId => {
                    const item = document.getElementById(itemId);
                    const input = item.querySelector('input');
                    
                    item.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => this.handleMediaUpload(e, itemId));
                });
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('sw.js');
                        console.log('Service Worker enregistr√©');
                    } catch (error) {
                        console.log('Erreur Service Worker:', error);
                    }
                }
            }

            startVisit() {
                const title = document.getElementById('visit-title').value.trim();
                if (!title) {
                    this.showMessage('Veuillez saisir un titre pour la visite', 'error');
                    return;
                }

                this.visit.title = title;
                document.getElementById('visit-setup').classList.add('hidden');
                document.getElementById('final-actions').classList.remove('hidden');
                
                this.newPOI();
                this.showMessage('Visite cr√©√©e ! Ajoutez maintenant vos POI.', 'success');
            }

            newPOI() {
                this.currentPOI = {
                    id: this.generateId(),
                    title: '',
                    lat: null,
                    lng: null,
                    comment: '',
                    image: null,
                    video: null,
                    audio: null
                };
                this.editingIndex = -1;
                this.showPOIForm();
                this.initMap();
            }

            showPOIForm() {
                document.getElementById('poi-form').classList.remove('hidden');
                document.getElementById('final-actions').classList.add('hidden');
                this.resetPOIForm();
            }

            resetPOIForm() {
                document.getElementById('poi-title').value = this.currentPOI?.title || '';
                document.getElementById('poi-comment').value = this.currentPOI?.comment || '';
                document.getElementById('poi-lat').value = this.currentPOI?.lat || '';
                document.getElementById('poi-lng').value = this.currentPOI?.lng || '';
                
                // Reset media previews
                document.querySelectorAll('.media-preview').forEach(preview => {
                    preview.innerHTML = '';
                });
            }

            initMap() {
                if (this.map) {
                    this.map.remove();
                }

                this.map = L.map('map').setView([48.8566, 2.3522], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                // Si on a d√©j√† des coordonn√©es, les afficher
                if (this.currentPOI?.lat && this.currentPOI?.lng) {
                    this.addMarker(this.currentPOI.lat, this.currentPOI.lng);
                    this.map.setView([this.currentPOI.lat, this.currentPOI.lng], 15);
                }

                this.map.on('click', (e) => {
                    if (document.querySelector('.location-method.active').dataset.method === 'map') {
                        this.addMarker(e.latlng.lat, e.latlng.lng);
                    }
                });
            }

            addMarker(lat, lng) {
                if (this.currentMarker) {
                    this.map.removeLayer(this.currentMarker);
                }
                
                this.currentMarker = L.marker([lat, lng]).addTo(this.map);
                
                // Mettre √† jour l'objet POI courant
                if (this.currentPOI) {
                    this.currentPOI.lat = lat;
                    this.currentPOI.lng = lng;
                }
            }

            selectLocationMethod(methodEl) {
                document.querySelectorAll('.location-method').forEach(m => m.classList.remove('active'));
                methodEl.classList.add('active');
                
                const method = methodEl.dataset.method;
                const manualCoords = document.getElementById('manual-coords');
                
                if (method === 'manual' || method === 'exif') {
                    manualCoords.classList.remove('hidden');
                } else {
                    manualCoords.classList.add('hidden');
                }
            }

            updateManualCoords() {
                const lat = parseFloat(document.getElementById('poi-lat').value);
                const lng = parseFloat(document.getElementById('poi-lng').value);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    // Mettre √† jour l'objet POI
                    this.currentPOI.lat = lat;
                    this.currentPOI.lng = lng;
                    
                    // Mettre √† jour la carte
                    this.addMarker(lat, lng);
                    this.map.setView([lat, lng], 15);
                }
            }

            async handleMediaUpload(event, uploadType) {
                const file = event.target.files[0];
                if (!file) return;

                const mediaType = uploadType.split('-')[0]; // image, audio, video
                this.currentPOI[mediaType] = {
                    file: file,
                    data: await this.fileToArrayBuffer(file)
                };

                // Afficher aper√ßu
                const preview = document.querySelector(`#${uploadType} .media-preview`);
                this.showMediaPreview(file, preview, mediaType);

                // Extraction EXIF pour les images
                if (mediaType === 'image' && 
                    document.querySelector('.location-method.active').dataset.method === 'exif') {
                    this.extractEXIFLocation(file);
                }
            }

            async fileToArrayBuffer(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsArrayBuffer(file);
                });
            }

            showMediaPreview(file, container, type) {
                const url = URL.createObjectURL(file);
                let element;

                switch (type) {
                    case 'image':
                        element = document.createElement('img');
                        element.src = url;
                        break;
                    case 'audio':
                        element = document.createElement('audio');
                        element.src = url;
                        element.controls = true;
                        break;
                    case 'video':
                        element = document.createElement('video');
                        element.src = url;
                        element.controls = true;
                        break;
                }

                container.innerHTML = '';
                container.appendChild(element);
            }

            async extractEXIFLocation(file) {
                try {
                    const arrayBuffer = await this.fileToArrayBuffer(file);
                    const dataView = new DataView(arrayBuffer);
                    
                    // V√©rifier la signature JPEG
                    if (dataView.getUint16(0) !== 0xFFD8) {
                        throw new Error('Ce n\'est pas un fichier JPEG valide');
                    }
                    
                    // Rechercher le segment EXIF
                    let offset = 2;
                    let marker, length;
                    
                    while (offset < dataView.byteLength) {
                        marker = dataView.getUint16(offset);
                        offset += 2;
                        
                        if (marker === 0xFFE1) { // Segment APP1 (EXIF)
                            length = dataView.getUint16(offset);
                            offset += 2;
                            
                            // V√©rifier la signature EXIF
                            if (dataView.getUint32(offset) === 0x45786966) { // "Exif"
                                offset += 6; // Skip "Exif\0\0"
                                
                                const gpsCoords = this.parseEXIFGPS(dataView, offset);
                                if (gpsCoords) {
                                    this.addMarker(gpsCoords.lat, gpsCoords.lng);
                                    this.map.setView([gpsCoords.lat, gpsCoords.lng], 15);
                                    this.showMessage(`Coordonn√©es GPS extraites: ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`, 'success');
                                    return;
                                }
                            }
                            break;
                        } else if (marker === 0xFFDA) { // Start of Scan
                            break;
                        } else if ((marker & 0xFF00) === 0xFF00) {
                            length = dataView.getUint16(offset);
                            offset += 2 + length - 2;
                        } else {
                            break;
                        }
                    }
                    
                    throw new Error('Aucune donn√©e GPS trouv√©e dans l\'image');
                    
                } catch (error) {
                    this.showMessage('Impossible d\'extraire les coordonn√©es GPS: ' + error.message, 'error');
                    // Retour √† la m√©thode carte en cas d'√©chec
                    document.querySelector('.location-method[data-method="map"]').click();
                }
            }

            parseEXIFGPS(dataView, exifOffset) {
                try {
                    // D√©terminer l'endianness
                    const endian = dataView.getUint16(exifOffset) === 0x4949; // "II" = little endian, "MM" = big endian
                    
                    // Offset vers l'IFD0
                    const ifd0Offset = this.readUint32(dataView, exifOffset + 4, endian);
                    
                    // Parcourir l'IFD0 pour trouver le GPS IFD
                    const gpsIFDOffset = this.findGPSIFD(dataView, exifOffset + ifd0Offset, exifOffset, endian);
                    
                    if (gpsIFDOffset) {
                        return this.parseGPSIFD(dataView, exifOffset + gpsIFDOffset, exifOffset, endian);
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Erreur parsing EXIF GPS:', error);
                    return null;
                }
            }

            findGPSIFD(dataView, ifdOffset, exifBase, endian) {
                const entryCount = this.readUint16(dataView, ifdOffset, endian);
                
                for (let i = 0; i < entryCount; i++) {
                    const entryOffset = ifdOffset + 2 + (i * 12);
                    const tag = this.readUint16(dataView, entryOffset, endian);
                    
                    if (tag === 0x8825) { // GPS IFD Pointer tag
                        return this.readUint32(dataView, entryOffset + 8, endian);
                    }
                }
                
                return null;
            }

            parseGPSIFD(dataView, gpsIFDOffset, exifBase, endian) {
                const entryCount = this.readUint16(dataView, gpsIFDOffset, endian);
                let gpsData = {};
                
                for (let i = 0; i < entryCount; i++) {
                    const entryOffset = gpsIFDOffset + 2 + (i * 12);
                    const tag = this.readUint16(dataView, entryOffset, endian);
                    const type = this.readUint16(dataView, entryOffset + 2, endian);
                    const count = this.readUint32(dataView, entryOffset + 4, endian);
                    const valueOffset = this.readUint32(dataView, entryOffset + 8, endian);
                    
                    switch (tag) {
                        case 0x0001: // GPSLatitudeRef
                            gpsData.latRef = String.fromCharCode(dataView.getUint8(entryOffset + 8));
                            break;
                        case 0x0002: // GPSLatitude
                            gpsData.lat = this.readGPSCoordinate(dataView, exifBase + valueOffset, endian);
                            break;
                        case 0x0003: // GPSLongitudeRef  
                            gpsData.lngRef = String.fromCharCode(dataView.getUint8(entryOffset + 8));
                            break;
                        case 0x0004: // GPSLongitude
                            gpsData.lng = this.readGPSCoordinate(dataView, exifBase + valueOffset, endian);
                            break;
                    }
                }
                
                // Convertir en coordonn√©es d√©cimales
                if (gpsData.lat && gpsData.lng && gpsData.latRef && gpsData.lngRef) {
                    let lat = gpsData.lat[0] + gpsData.lat[1]/60 + gpsData.lat[2]/3600;
                    let lng = gpsData.lng[0] + gpsData.lng[1]/60 + gpsData.lng[2]/3600;
                    
                    if (gpsData.latRef === 'S') lat = -lat;
                    if (gpsData.lngRef === 'W') lng = -lng;
                    
                    return { lat, lng };
                }
                
                return null;
            }

            readGPSCoordinate(dataView, offset, endian) {
                const coords = [];
                for (let i = 0; i < 3; i++) {
                    const numerator = this.readUint32(dataView, offset + (i * 8), endian);
                    const denominator = this.readUint32(dataView, offset + (i * 8) + 4, endian);
                    coords.push(numerator / denominator);
                }
                return coords;
            }

            readUint16(dataView, offset, littleEndian) {
                return dataView.getUint16(offset, littleEndian);
            }

            readUint32(dataView, offset, littleEndian) {
                return dataView.getUint32(offset, littleEndian);
            }

            addPOI() {
                const title = document.getElementById('poi-title').value.trim();
                if (!title) {
                    this.showMessage('Veuillez saisir un titre pour le POI', 'error');
                    return;
                }

                if (!this.currentPOI.lat || !this.currentPOI.lng) {
                    this.showMessage('Veuillez d√©finir une localisation pour le POI', 'error');
                    return;
                }

                this.currentPOI.title = title;
                this.currentPOI.comment = document.getElementById('poi-comment').value.trim();

                if (this.editingIndex >= 0) {
                    this.visit.pois[this.editingIndex] = this.currentPOI;
                    this.showMessage('POI modifi√© avec succ√®s', 'success');
                } else {
                    this.visit.pois.push(this.currentPOI);
                    this.showMessage('POI ajout√© avec succ√®s', 'success');
                }

                this.updatePOIList();
                this.hidePOIForm();
            }

            cancelPOI() {
                this.hidePOIForm();
            }

            hidePOIForm() {
                document.getElementById('poi-form').classList.add('hidden');
                document.getElementById('final-actions').classList.remove('hidden');
            }

            updatePOIList() {
                const container = document.getElementById('poi-items');
                const emptyMsg = document.getElementById('poi-empty');
                const countEl = document.getElementById('poi-count');
                
                countEl.textContent = this.visit.pois.length;
                
                if (this.visit.pois.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    container.innerHTML = '';
                    return;
                }
                
                emptyMsg.classList.add('hidden');
                container.innerHTML = '';

                this.visit.pois.forEach((poi, index) => {
                    const item = this.createPOIItem(poi, index);
                    container.appendChild(item);
                });

                this.setupDragAndDrop();
            }

            createPOIItem(poi, index) {
                const div = document.createElement('div');
                div.className = 'poi-item';
                div.draggable = true;
                div.dataset.index = index;
                
                div.innerHTML = `
                    <div class="poi-item-header">
                        <div class="poi-item-title">${poi.title}</div>
                        <div class="poi-item-actions">
                            <button class="poi-item-btn edit" onclick="editPOI.editPOI(${index})">‚úèÔ∏è</button>
                            <button class="poi-item-btn delete" onclick="editPOI.deletePOI(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="poi-item-coords">
                        üìç ${poi.lat.toFixed(6)}, ${poi.lng.toFixed(6)}
                    </div>
                `;
                
                return div;
            }

            editPOI(index) {
                this.currentPOI = { ...this.visit.pois[index] };
                this.editingIndex = index;
                this.showPOIForm();
                this.initMap();
            }

            deletePOI(index) {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer ce POI ?')) {
                    this.visit.pois.splice(index, 1);
                    this.updatePOIList();
                    this.showMessage('POI supprim√©', 'success');
                }
            }

            setupDragAndDrop() {
                const items = document.querySelectorAll('.poi-item');
                
                items.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.index);
                        item.classList.add('dragging');
                    });
                    
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const targetIndex = parseInt(item.dataset.index);
                        
                        if (draggedIndex !== targetIndex) {
                            this.reorderPOIs(draggedIndex, targetIndex);
                        }
                    });
                });
            }

            reorderPOIs(fromIndex, toIndex) {
                const poi = this.visit.pois.splice(fromIndex, 1)[0];
                this.visit.pois.splice(toIndex, 0, poi);
                this.updatePOIList();
                this.showMessage('Ordre des POI modifi√©', 'success');
            }

            async exportVisit() {
                if (this.visit.pois.length === 0) {
                    this.showMessage('Aucun POI √† exporter', 'error');
                    return;
                }

                const zip = new JSZip();
                
                // Cr√©er visit.json
                const visitData = {
                    title: this.visit.title,
                    pois: this.visit.pois.map(poi => ({
                        id: poi.id,
                        title: poi.title,
                        lat: poi.lat,
                        lng: poi.lng,
                        comment: poi.comment,
                        image: poi.image ? `data/${poi.id}/image.jpg` : null,
                        audio: poi.audio ? `data/${poi.id}/audio.mp3` : null,
                        video: poi.video ? `data/${poi.id}/video.mp4` : null
                    }))
                };
                
                zip.file('visit.json', JSON.stringify(visitData, null, 2));
                
                // Ajouter les fichiers m√©dias
                const dataFolder = zip.folder('data');
                
                for (const poi of this.visit.pois) {
                    const poiFolder = dataFolder.folder(poi.id);
                    
                    if (poi.image) {
                        poiFolder.file('image.jpg', poi.image.data);
                    }
                    if (poi.audio) {
                        poiFolder.file('audio.mp3', poi.audio.data);
                    }
                    if (poi.video) {
                        poiFolder.file('video.mp4', poi.video.data);
                    }
                }
                
                // G√©n√©rer et t√©l√©charger le ZIP
                try {
                    const content = await zip.generateAsync({ type: 'blob' });
                    const filename = this.sanitizeFilename(this.visit.title) + '.zip';
                    this.downloadFile(content, filename);
                    this.showMessage('Visite export√©e avec succ√®s !', 'success');
                } catch (error) {
                    this.showMessage('Erreur lors de l\'export : ' + error.message, 'error');
                }
            }

            async importZip(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const zip = new JSZip();
                    const zipContent = await zip.loadAsync(file);
                    
                    // Lire visit.json
                    const visitFile = zipContent.file('visit.json');
                    if (!visitFile) {
                        throw new Error('Fichier visit.json introuvable');
                    }
                    
                    const visitData = JSON.parse(await visitFile.async('string'));
                    
                    // Reconstituer la visite
                    this.visit = {
                        title: visitData.title,
                        pois: []
                    };
                    
                    document.getElementById('visit-title').value = visitData.title;
                    
                    // Charger les POI avec leurs m√©dias
                    for (const poiData of visitData.pois) {
                        const poi = {
                            id: poiData.id,
                            title: poiData.title,
                            lat: poiData.lat,
                            lng: poiData.lng,
                            comment: poiData.comment,
                            image: null,
                            audio: null,
                            video: null
                        };
                        
                        // Charger les fichiers m√©dias
                        if (poiData.image) {
                            const imageFile = zipContent.file(poiData.image);
                            if (imageFile) {
                                const imageData = await imageFile.async('arraybuffer');
                                poi.image = {
                                    data: imageData,
                                    file: new File([imageData], 'image.jpg', { type: 'image/jpeg' })
                                };
                            }
                        }
                        
                        if (poiData.audio) {
                            const audioFile = zipContent.file(poiData.audio);
                            if (audioFile) {
                                const audioData = await audioFile.async('arraybuffer');
                                poi.audio = {
                                    data: audioData,
                                    file: new File([audioData], 'audio.mp3', { type: 'audio/mp3' })
                                };
                            }
                        }
                        
                        if (poiData.video) {
                            const videoFile = zipContent.file(poiData.video);
                            if (videoFile) {
                                const videoData = await videoFile.async('arraybuffer');
                                poi.video = {
                                    data: videoData,
                                    file: new File([videoData], 'video.mp4', { type: 'video/mp4' })
                                };
                            }
                        }
                        
                        this.visit.pois.push(poi);
                    }
                    
                    // Mettre √† jour l'interface
                    this.updatePOIList();
                    document.getElementById('visit-setup').classList.add('hidden');
                    document.getElementById('final-actions').classList.remove('hidden');
                    
                    this.showMessage(`Visite "${visitData.title}" import√©e avec ${visitData.pois.length} POI`, 'success');
                    
                } catch (error) {
                    this.showMessage('Erreur lors de l\'import : ' + error.message, 'error');
                }
                
                // Reset input
                event.target.value = '';
            }

            newVisit() {
                if (confirm('√ätes-vous s√ªr de vouloir cr√©er une nouvelle visite ? Toutes les donn√©es non sauvegard√©es seront perdues.')) {
                    this.visit = { title: '', pois: [] };
                    document.getElementById('visit-title').value = '';
                    document.getElementById('visit-setup').classList.remove('hidden');
                    document.getElementById('poi-form').classList.add('hidden');
                    document.getElementById('final-actions').classList.add('hidden');
                    this.updatePOIList();
                    
                    if (this.map) {
                        this.map.remove();
                        this.map = null;
                    }
                }
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            sanitizeFilename(filename) {
                return filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            }

            downloadFile(content, filename) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showMessage(message, type = 'info') {
                // Supprimer les anciens messages
                document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());
                
                const div = document.createElement('div');
                div.className = type === 'error' ? 'error-message' : 'success-message';
                div.textContent = message;
                
                const container = document.querySelector('.left-panel');
                container.insertBefore(div, container.firstChild);
                
                // Auto-suppression apr√®s 5 secondes
                setTimeout(() => {
                    if (div.parentNode) {
                        div.parentNode.removeChild(div);
                    }
                }, 5000);
            }
        }

        // Instance globale
        let editPOI;

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            editPOI = new EditPOI();
        });

        // Gestion de l'installation PWA
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Cr√©er un bouton d'installation
            const installButton = document.createElement('button');
            installButton.className = 'btn';
            installButton.innerHTML = 'üì± Installer l\'app';
            installButton.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const result = await deferredPrompt.userChoice;
                    if (result.outcome === 'accepted') {
                        console.log('PWA install√©e');
                    }
                    deferredPrompt = null;
                    installButton.remove();
                }
            };
            
            document.querySelector('.header').appendChild(installButton);
        });
    </script>
</body>
</html>