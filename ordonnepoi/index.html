<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ordonnepoi — gestionnaire de POI</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2b6cb0" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;background:#f7fafc}
    header{display:flex;align-items:center;gap:1rem}
    h1{font-size:1.25rem;margin:0}
    button{padding:.5rem .75rem;margin:.25rem;border:1px solid #ccc;border-radius:6px;cursor:pointer}
    button.primary{background:#2b6cb0;color:#fff;border-color:#2b6cb0}
    .small{font-size:.85rem;color:#555}
    #poi-list{margin-top:1rem;display:grid;gap:.5rem}
    .poi{background:white;padding:.6rem;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.1)}
  </style>
</head>
<body>
  <header><h1>ordonnepoi — gestionnaire de POI</h1></header>
  <div>
    <input id="zipInput" type="file" accept=".zip" />
    <button id="sortLon">Classement en longitude</button>
    <button id="sortLat">Classement en latitude</button>
    <button id="toggleOrder">Inverser ordre</button>
    <button id="saveBtn" class="primary" disabled>Sauvegarder (zip)</button>
    <button id="exportKML" disabled>Exporter en KML</button>
  </div>
  <div id="status" class="small">Aucun fichier chargé.</div>
  <div id="poi-list"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    let visit=null, originalZip=null;
    const zipInput=document.getElementById('zipInput');
    const status=document.getElementById('status');
    const poiList=document.getElementById('poi-list');
    const saveBtn=document.getElementById('saveBtn');
    const exportKML=document.getElementById('exportKML');
    let currentAscLon=true, currentAscLat=true;
    zipInput.addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      const z=await JSZip.loadAsync(await f.arrayBuffer());
      const vfile=z.file('visit.json'); if(!vfile){alert('visit.json manquant');return;}
      visit=JSON.parse(await vfile.async('text')); originalZip=z;
      render(visit.pois);
      status.textContent=`${visit.title} — ${visit.pois.length} POI`;
      saveBtn.disabled=false; exportKML.disabled=false;
    });
    function render(pois){
      poiList.innerHTML=''; pois.forEach(p=>{
        const d=document.createElement('div'); d.className='poi';
        d.innerHTML=`<b>${p.title}</b><br><span class='small'>lat ${p.lat}, lon ${p.lon}</span><br>${p.comment||''}`;
        poiList.appendChild(d);
      });
    }
    function sortBy(key){
      if(!visit) return;
      const asc = (key==='lon'?currentAscLon:currentAscLat);
      visit.pois.sort((a,b)=>(asc?(a[key]-b[key]):(b[key]-a[key])));
      if(key==='lon') currentAscLon=!currentAscLon; else currentAscLat=!currentAscLat;
      render(visit.pois);
    }
    document.getElementById('sortLon').onclick=()=>sortBy('lon');
    document.getElementById('sortLat').onclick=()=>sortBy('lat');
    document.getElementById('toggleOrder').onclick=()=>{visit.pois.reverse();render(visit.pois);};
    saveBtn.onclick=async()=>{
      const out=new JSZip();
      out.file('visit.json',JSON.stringify(visit,null,2));
      originalZip.forEach((path,f)=>{if(path!=='visit.json'&&!f.dir)f.async('arraybuffer').then(b=>out.file(path,b));});
      const blob=await out.generateAsync({type:'blob'});
      saveAs(blob,(visit.title||'visit')+'_ordonnepoi.zip');
    };
    exportKML.onclick=()=>{
      if(!visit) return;
      let kml='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>\n';
      kml+=`<name>${visit.title}</name>\n`;
      visit.pois.forEach(p=>{
        kml+=`<Placemark><name>${p.title}</name><description>${p.comment||''}</description><Point><coordinates>${p.lon},${p.lat},0</coordinates></Point></Placemark>\n`;
      });
      kml+='</Document></kml>';
      const blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
      saveAs(blob,(visit.title||'visit')+'.kml');
    };
    if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}
  </script>
</body>
</html>