<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>visupoi</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b7a78">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <style>
    html,body,#app{height:100%;margin:0;font-family:system-ui,Arial}
    #top{display:flex;gap:8px;align-items:center;padding:8px;background:#f5f5f5;border-bottom:1px solid #ddd}
    #map{height:calc(100% - 56px)}
    #dropZone{flex:1;padding:8px;border:2px dashed #ccc;border-radius:6px;text-align:center}
    button{padding:8px;border-radius:6px;border:1px solid #888;background:white}
    .poi-list{max-height:220px;overflow:auto}
    .popup-media{max-width:260px}
    .poi-title{font-weight:700;margin-bottom:6px}
  </style>
</head>
<body>
  <div id="app">
    <div id="top">
      <div id="dropZone">Glisser-déposer ZIP ici ou <input id="fileInput" type="file" accept=".zip"/></div>
      <div>
        <button id="clearBtn">Effacer données locales</button>
        <button id="reopenBtn">Recharger POI</button>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ----------- IndexedDB wrapper minimal -----------
  const DB_NAME = 'visupoi-db';
  const DB_VERSION = 1;
  function openDB(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = e =>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains('pois')) db.createObjectStore('pois',{keyPath:'id'});
        if(!db.objectStoreNames.contains('media')) db.createObjectStore('media');
        if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta');
      }
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });
  }
  function idbPut(storeName, key, value){
    return openDB().then(db=>new Promise((res,rej)=>{
      const tx = db.transaction(storeName,'readwrite');
      const st = tx.objectStore(storeName);
      const r = st.put(value, key);
      tx.oncomplete = ()=>res(true);
      tx.onerror = ()=>rej(tx.error);
    }));
  }
  function idbGetAll(storeName){
    return openDB().then(db=>new Promise((res,rej)=>{
      const tx = db.transaction(storeName,'readonly');
      const st = tx.objectStore(storeName);
      const r = st.getAll();
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    }));
  }
  function idbGet(storeName,key){
    return openDB().then(db=>new Promise((res,rej)=>{
      const tx = db.transaction(storeName,'readonly');
      const st = tx.objectStore(storeName);
      const r = st.get(key);
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    }));
  }
  function idbDeleteDB(){
    return new Promise((res,rej)=>{
      const r = indexedDB.deleteDatabase(DB_NAME);
      r.onsuccess = ()=>res(true);
      r.onerror = ()=>rej(r.error);
    });
  }

  // ----------- Utility -----------
  function parseCoord(coordStr){
    // Example "50.04525N, 1.32983E"
    // Return {lat: float, lng: float}
    const parts = coordStr.split(',').map(s=>s.trim());
    if(parts.length<2) return null;
    function conv(s){
      const m = s.match(/^([0-9.+-]+)\s*([NnSsEeWw])$/);
      if(!m) return NaN;
      let v = parseFloat(m[1]);
      const dir = m[2].toUpperCase();
      if(dir==='S' || dir==='W') v = -v;
      return v;
    }
    const lat = conv(parts[0]);
    const lng = conv(parts[1]);
    if(isNaN(lat) || isNaN(lng)) return null;
    return {lat,lng};
  }

  // ----------- App state and map -----------
  let map, markersLayer;
  function initMap(){
    map = L.map('map',{preferCanvas:true}).setView([46,2],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap contributors'}).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  function markerColorFor(poi){
    const hasImg = !!poi.image;
    const hasVid = !!poi.video;
    const hasAud = !!poi.audio;
    if(hasImg && hasAud) return 'purple';
    if(hasVid) return 'red';
    if(hasImg) return 'blue';
    return 'gray';
  }

  function createMarkerIcon(color){
    // simple colored circle marker using DivIcon
    const html = `<div style="width:18px;height:18px;border-radius:50%;background:${color};box-shadow:0 0 0 2px white"></div>`;
    return L.divIcon({className:'',html,iconSize:[18,18],iconAnchor:[9,9]});
  }

  // ----------- Rendering POIs -----------
  async function loadPoisToMap(){
    markersLayer.clearLayers();
    const pois = await idbGetAll('pois');
    if(!pois || pois.length===0) return;
    // group by coords string
    const groups = new Map();
    for(const p of pois){
      const key = `${p.location}`; // exact string from visit.json
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(p);
    }
    const bounds = [];
    for(const [locStr, arr] of groups){
      const coord = parseCoord(locStr);
      if(!coord) continue;
      bounds.push([coord.lat,coord.lng]);
      const mainPoi = arr[0];
      const color = markerColorFor(mainPoi);
      const icon = createMarkerIcon(color);
      const marker = L.marker([coord.lat,coord.lng],{icon});
      marker.on('click', ()=>openPopupForGroup(arr, coord, marker));
      marker.addTo(markersLayer);
    }
    if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
  }

  function createMediaElement(poi, media){
    // media: {key, name, type}
    const url = `/media/${encodeURIComponent(media.key)}`;
    if(media.type.startsWith('image/')){
      return `<div class="popup-media"><img src="${url}" style="max-width:100%;height:auto;border-radius:4px"/></div>`;
    }
    if(media.type.startsWith('audio/')){
      return `<audio controls src="${url}" style="width:100%"></audio>`;
    }
    if(media.type.startsWith('video/')){
      return `<video controls src="${url}" style="max-width:100%;height:auto;border-radius:4px"></video>`;
    }
    return '';
  }

  async function openPopupForGroup(arr, coord, marker){
    if(arr.length===1){
      const p = arr[0];
      const popupHtml = await buildPopupHtml(p);
      marker.bindPopup(popupHtml,{maxWidth:320}).openPopup();
    } else {
      // show clickable list
      let html = `<div class='poi-list'>`;
      arr.forEach((p,i)=>{
        html += `<div><a href='#' data-id='${p.id}' class='open-poi'>${p.title}</a></div>`;
      });
      html += `</div>`;
      marker.bindPopup(html,{maxWidth:320}).openPopup();
      // attach listener after popup opens
      setTimeout(()=>{
        const els = document.querySelectorAll('.open-poi');
        els.forEach(el=>el.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const id = Number(ev.target.getAttribute('data-id'));
          const p = arr.find(x=>x.id===id);
          if(p){
            const popupHtml = await buildPopupHtml(p);
            marker.setPopupContent(popupHtml);
          }
        }));
      },50);
    }
  }

  async function buildPopupHtml(p){
    // get media list for this poi
    const mediaKeys = p._media || [];
    let html = `<div class='popup-body'>`;
    html += `<div class='poi-title'>${p.title}</div>`;
    html += `<div>Coords: ${p.location}</div>`;
    if(p.comment) html += `<div style='margin-top:6px'>${p.comment}</div>`;
    for(const m of mediaKeys){
      const media = await idbGet('media', m);
      if(!media) continue;
      html += `<div style='margin-top:6px'>${createMediaElement(p, media)}</div>`;
    }
    html += `</div>`;
    return html;
  }

  // ----------- ZIP processing -----------
  async function processZip(file){
    const zip = await JSZip.loadAsync(file);
    // find visit.json at root
    const visitFile = zip.file('visit.json') || zip.file('./visit.json');
    if(!visitFile) return alert('visit.json introuvable dans le ZIP');
    const visitText = await visitFile.async('string');
    let visit;
    try{ visit = JSON.parse(visitText); } catch(e){ return alert('visit.json invalide JSON'); }
    const pois = visit.pois || [];
    // store pois in DB, and store media files
    for(const poi of pois){
      // find files in data/<id>/
      const folder = `data/${poi.id}/`;
      const mediaKeys = [];
      for(const zfileName in zip.files){
        if(zfileName.startsWith(folder) && !zip.files[zfileName].dir){
          const f = zip.files[zfileName];
          const blob = await f.async('blob');
          const key = `${poi.id}/${zfileName.substring(folder.length)}`; // e.g. 1/photo.jpg
          // store blob + metadata in 'media' store with key = key
          const mediaRec = {key, name:zfileName.split('/').pop(), type:blob.type || guessMime(key), blob};
          await idbPut('media', key, mediaRec);
          mediaKeys.push(key);
        }
      }
      // attach media keys to poi object
      poi._media = mediaKeys;
      await idbPut('pois', poi.id, poi);
    }
    // store meta
    await idbPut('meta', 'visit_name', {name:visit.name||'visupoi'});
    alert('Import terminé : ' + pois.length + ' POI(s).');
    await loadPoisToMap();
  }

  function guessMime(name){
    name = name.toLowerCase();
    if(name.match(/\.(jpe?g|png|gif|webp|bmp)$/)) return 'image/*';
    if(name.match(/\.(mp3|wav|ogg|m4a)$/)) return 'audio/*';
    if(name.match(/\.(mp4|webm|ogg|mov)$/)) return 'video/*';
    return 'application/octet-stream';
  }

  // ----------- Drop & input handlers -----------
  function setupUpload(){
    const drop = document.getElementById('dropZone');
    const input = document.getElementById('fileInput');
    drop.addEventListener('dragover', e=>{e.preventDefault();drop.style.borderColor='#66a'});
    drop.addEventListener('dragleave', e=>{drop.style.borderColor='#ccc'});
    drop.addEventListener('drop', e=>{e.preventDefault();drop.style.borderColor='#ccc'; const f = e.dataTransfer.files[0]; if(f) processZip(f);});
    input.addEventListener('change', e=>{ const f = e.target.files[0]; if(f) processZip(f);});
  }

  // ----------- Buttons -----------
  document.addEventListener('DOMContentLoaded', async ()=>{
    initMap(); setupUpload();
    document.getElementById('clearBtn').addEventListener('click', async ()=>{ if(confirm('Effacer la base locale visupoi ?')){ await idbDeleteDB(); alert('Données effacées'); location.reload(); }});
    document.getElementById('reopenBtn').addEventListener('click', ()=>loadPoisToMap());

    // register service worker
    if('serviceWorker' in navigator){
      try{
        await navigator.serviceWorker.register('service-worker.js');
        console.log('Service worker enregistré');
      }catch(e){console.warn('Impossible d'enregistrer le service worker',e)}
    }

    // load existing pois if any
    await loadPoisToMap();
  });
  </script>
</body>
</html>

