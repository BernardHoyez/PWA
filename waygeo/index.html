<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>waygeo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#111827">

<link rel="manifest" href="./manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{height:100%}

.panel{
 position:absolute; left:8px; right:8px; bottom:8px;
 background:white; border-radius:12px;
 box-shadow:0 2px 10px rgba(0,0,0,.35);
 z-index:1000;
}

.header{
 padding:8px; background:#e5e7eb;
 font-weight:bold; cursor:pointer;
}

.body{padding:8px; display:none}
.panel.open .body{display:block}

.row{display:flex; gap:6px; margin-top:6px}
button{flex:1; padding:10px}

.pt{border-top:1px solid #ddd; padding-top:6px; margin-top:6px}
input,textarea{width:100%; padding:6px; margin-top:4px}
.mediaBtn{font-size:18px}
</style>
</head>

<body>

<div class="panel open" id="panel">
<div class="header" onclick="panel.classList.toggle('open')">
waygeo ‚Äî relev√©s terrain
</div>

<div class="body">

<div class="row">
<button id="addBtn">üìç Point</button>
<button id="gpsBtn">üß≠</button>
<button id="zipBtn">‚¨áÔ∏è ZIP</button>
</div>

<div id="pts"></div>

</div>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>

// ---------------- MAP IGN ----------------

const ign=new ol.layer.Tile({
 source:new ol.source.WMTS({
  url:"https://data.geopf.fr/wmts",
  layer:"GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2",
  matrixSet:"PM",
  format:"image/png",
  style:"normal",
  tileGrid:new ol.tilegrid.WMTS({
   origin:[-20037508,20037508],
   resolutions:[156543.033928,78271.516964,39135.758482,19567.879241,
   9783.9396205,4891.96981025,2445.98490513,1222.99245256,
   611.496226281,305.748113141,152.87405657,76.4370282852,
   38.2185141426,19.1092570713,9.55462853565,4.77731426782,
   2.38865713391,1.19432856696,0.597164283478],
   matrixIds:Array.from({length:19},(_,i)=>""+i)
  })
 })
});

const vsrc=new ol.source.Vector();
const vlay=new ol.layer.Vector({source:vsrc});

const map=new ol.Map({
 target:"map",
 layers:[ign,vlay],
 view:new ol.View({
  center:ol.proj.fromLonLat([6.18,43.47]),
  zoom:14
 })
});

// ---------------- DATA ----------------

let points=[];

function marker(lon,lat){
 vsrc.addFeature(new ol.Feature({
  geometry:new ol.geom.Point(
   ol.proj.fromLonLat([lon,lat])
  )
 }));
}

// ---------------- ADD POINT ----------------

addBtn.onclick=()=>{
 navigator.geolocation.getCurrentPosition(pos=>{
  const p={
   lat:pos.coords.latitude,
   lon:pos.coords.longitude,
   t:new Date().toISOString(),
   name:"",
   note:"",
   media:{}
  };
  points.push(p);
  marker(p.lon,p.lat);
  render();
 });
};

// ---------------- UI LIST ----------------

function render(){
 pts.innerHTML="";
 points.forEach((p,i)=>{
  const d=document.createElement("div");
  d.className="pt";
  d.innerHTML=`
  <b>P${i+1}</b> ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}
  <input placeholder="nom" value="${p.name}"
    onchange="points[${i}].name=this.value">
  <textarea rows=2 placeholder="note"
    onchange="points[${i}].note=this.value">${p.note}</textarea>

  <div class="row">
    <button class="mediaBtn" onclick="cap(${i},'img')">üì∑</button>
    <button class="mediaBtn" onclick="cap(${i},'aud')">üé§</button>
    <button class="mediaBtn" onclick="cap(${i},'vid')">üé¨</button>
  </div>
  `;
  pts.appendChild(d);
 });
}

// ---------------- MEDIA CAPTURE ----------------

function cap(i,type){
 const inp=document.createElement("input");
 inp.type="file";

 if(type==="img"){inp.accept="image/*"; inp.capture="environment";}
 if(type==="aud"){inp.accept="audio/*"; inp.capture="microphone";}
 if(type==="vid"){inp.accept="video/*"; inp.capture="environment";}

 inp.onchange=e=>{
  const f=e.target.files[0];
  if(f) points[i].media[type]=f;
 };
 inp.click();
}

// ---------------- GPS CENTER ----------------

gpsBtn.onclick=()=>{
 navigator.geolocation.getCurrentPosition(p=>{
  map.getView().animate({
   center:ol.proj.fromLonLat(
    [p.coords.longitude,p.coords.latitude]),
   zoom:16
  });
 });
};

// ---------------- EXPORT ZIP GPX ----------------

zipBtn.onclick=async()=>{

 const zip=new JSZip();

 let gpx=`<?xml version="1.0"?>
<gpx version="1.1" creator="waygeo">`;

 points.forEach((p,i)=>{
  gpx+=`
<wpt lat="${p.lat}" lon="${p.lon}">
<name>${p.name||"P"+(i+1)}</name>
<desc>${p.note||""}</desc>
<time>${p.t}</time>
</wpt>`;
 });

 gpx+="</gpx>";

 zip.file("points.gpx",gpx);

 for(let i=0;i<points.length;i++){
  const m=points[i].media;
  for(const k in m){
   zip.file(`P${i+1}_${k}_${m[k].name}`,m[k]);
  }
 }

 const blob=await zip.generateAsync({type:"blob"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="waygeo_export.zip";
 a.click();
};

// ---------------- SW ----------------

if("serviceWorker" in navigator){
 navigator.serviceWorker.register("./sw.js");
}

</script>
</body>
</html>
