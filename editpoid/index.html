<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditPOID - √âditeur de Visites</title>
    
    <!-- PWA Meta tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" href="icons/icon192.png">
    <link rel="apple-touch-icon" href="icons/icon192.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .editor-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .poi-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .coordinates-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #059669;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        #map {
            height: 300px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .media-preview {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            text-align: center;
        }
        
        .media-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
        }
        
        .media-preview video, .media-preview audio {
            max-width: 100%;
        }
        
        .poi-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s;
        }
        
        .poi-item:hover {
            border-color: #2563eb;
            transform: translateX(5px);
        }
        
        .poi-item.sortable-ghost {
            opacity: 0.5;
        }
        
        .poi-item h3 {
            color: #2563eb;
            margin-bottom: 5px;
        }
        
        .poi-actions {
            margin-top: 10px;
        }
        
        .poi-actions button {
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .hidden {
            display: none;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step-indicator .step-item {
            padding: 10px 20px;
            background: #e5e7eb;
            color: #6b7280;
            margin: 0 5px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .step-indicator .step-item.active {
            background: #2563eb;
            color: white;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .coordinates-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è EditPOID</h1>
            <p>√âditeur de visites avec points d'int√©r√™t</p>
        </div>
        
        <div class="step-indicator">
            <div class="step-item active" data-step="1">Configuration</div>
            <div class="step-item" data-step="2">√âdition POI</div>
            <div class="step-item" data-step="3">Validation</div>
        </div>
        
        <!-- √âtape 1: Configuration de la visite -->
        <div class="step active" id="step1">
            <div class="editor-panel">
                <h2>üìã Configuration de la visite</h2>
                
                <div class="form-group">
                    <label for="visitTitle">Titre de la visite *</label>
                    <input type="text" id="visitTitle" placeholder="Entrez le titre de votre visite" required>
                </div>
                
                <div class="form-group">
                    <label for="importVisit">Importer une visite existante (optionnel)</label>
                    <div class="file-input-wrapper">
                        <button class="btn btn-secondary">üìÅ Choisir un fichier ZIP</button>
                        <input type="file" id="importVisit" accept=".zip">
                    </div>
                </div>
                
                <button class="btn" onclick="startEditing()">‚ñ∂Ô∏è Commencer l'√©dition</button>
            </div>
        </div>
        
        <!-- √âtape 2: √âdition des POI -->
        <div class="step" id="step2">
            <div class="main-content">
                <div class="editor-panel">
                    <h2>üìç √âdition d'un POI</h2>
                    
                    <div class="form-group">
                        <label for="poiTitle">Titre du POI *</label>
                        <input type="text" id="poiTitle" placeholder="Entrez le titre du POI" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç Localisation *</label>
                        <div class="coordinates-group">
                            <div>
                                <label for="latitude">Latitude</label>
                                <input type="number" id="latitude" step="any" placeholder="0.000000">
                            </div>
                            <div>
                                <label for="longitude">Longitude</label>
                                <input type="number" id="longitude" step="any" placeholder="0.000000">
                            </div>
                        </div>
                        <div id="map"></div>
                        <small>Cliquez sur la carte pour d√©finir la position ou modifiez manuellement les coordonn√©es</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="poiComment">Commentaire (optionnel)</label>
                        <textarea id="poiComment" rows="3" placeholder="Ajoutez un commentaire..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üñºÔ∏è Image JPEG (optionnelle)</label>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary">üì∏ Choisir une image</button>
                            <input type="file" id="poiImage" accept="image/jpeg">
                        </div>
                        <div id="imagePreview" class="media-preview hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>üéµ Audio MP3 (optionnel)</label>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary">üé§ Choisir un audio</button>
                            <input type="file" id="poiAudio" accept="audio/mp3">
                        </div>
                        <div id="audioPreview" class="media-preview hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>üé• Vid√©o MP4 (optionnelle)</label>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary">üìπ Choisir une vid√©o</button>
                            <input type="file" id="poiVideo" accept="video/mp4">
                        </div>
                        <div id="videoPreview" class="media-preview hidden"></div>
                    </div>
                    
                    <button class="btn btn-success" onclick="savePOI()">üíæ Sauvegarder le POI</button>
                    <button class="btn btn-secondary" onclick="cancelPOI()">‚ùå Annuler</button>
                    <button class="btn" onclick="finishEditing()">‚úÖ Terminer l'√©dition</button>
                </div>
                
                <div class="poi-list">
                    <h3>üìã Liste des POI</h3>
                    <p><small>Glissez-d√©posez pour r√©organiser</small></p>
                    <div id="poiList"></div>
                    <button class="btn" onclick="addNewPOI()" style="width: 100%; margin-top: 20px;">‚ûï Nouveau POI</button>
                </div>
            </div>
        </div>
        
        <!-- √âtape 3: Validation -->
        <div class="step" id="step3">
            <div class="editor-panel">
                <h2>‚úÖ Validation de la visite</h2>
                <div id="visitSummary"></div>
                <button class="btn btn-success" onclick="exportVisit()">üì¶ Exporter la visite</button>
                <button class="btn btn-secondary" onclick="backToEditing()">‚óÄÔ∏è Retour √† l'√©dition</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts externes -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/exif-js@2.3.0/exif.js"></script>
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script>
        // Variables globales
        let visit = {
            title: '',
            pois: []
        };
        let currentPOI = null;
        let editingIndex = -1;
        let map = null;
        let marker = null;
        let sortable = null;
        
        // Gestion PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });
        
        function showStep(stepNumber) {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Cacher tous les indicateurs
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Afficher l'√©tape courante
            document.getElementById(`step${stepNumber}`).classList.add('active');
            document.querySelector(`.step-item[data-step="${stepNumber}"]`).classList.add('active');
        }
    </script>
</body>
</html> setupEventListeners() {
            // Gestion des fichiers
            document.getElementById('importVisit').addEventListener('change', handleImportVisit);
            document.getElementById('poiImage').addEventListener('change', handleImageUpload);
            document.getElementById('poiAudio').addEventListener('change', handleAudioUpload);
            document.getElementById('poiVideo').addEventListener('change', handleVideoUpload);
            
            // Gestion des coordonn√©es
            document.getElementById('latitude').addEventListener('input', updateMapFromCoordinates);
            document.getElementById('longitude').addEventListener('input', updateMapFromCoordinates);
        }
        
        function startEditing() {
            const title = document.getElementById('visitTitle').value.trim();
            if (!title) {
                alert('Veuillez entrer un titre pour la visite');
                return;
            }
            
            visit.title = title;
            showStep(2);
            initializeMap();
            initializeSortable();
            addNewPOI();
        }
        
        function initializeMap() {
            if (map) return;
            
            map = L.map('map').setView([48.8566, 2.3522], 13); // Paris par d√©faut
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);
                
                updateMarker(lat, lng);
            });
        }
        
        function initializeSortable() {
            const poiList = document.getElementById('poiList');
            sortable = Sortable.create(poiList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    // R√©organiser le tableau des POI
                    const item = visit.pois.splice(evt.oldIndex, 1)[0];
                    visit.pois.splice(evt.newIndex, 0, item);
                    updatePOIList();
                }
            });
        }
        
        function updateMarker(lat, lng) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], map.getZoom());
        }
        
        function updateMapFromCoordinates() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                updateMarker(lat, lng);
            }
        }
        
        function handleImportVisit(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            JSZip.loadAsync(file).then(function(zip) {
                zip.file('visit.json').async('string').then(function(content) {
                    const importedVisit = JSON.parse(content);
                    visit = importedVisit;
                    document.getElementById('visitTitle').value = visit.title;
                    
                    // Charger les fichiers m√©dia
                    const promises = [];
                    visit.pois.forEach((poi, index) => {
                        if (poi.image) {
                            promises.push(
                                zip.file(`data/${poi.image}`).async('blob').then(blob => {
                                    poi.imageBlob = blob;
                                })
                            );
                        }
                        if (poi.audio) {
                            promises.push(
                                zip.file(`data/${poi.audio}`).async('blob').then(blob => {
                                    poi.audioBlob = blob;
                                })
                            );
                        }
                        if (poi.video) {
                            promises.push(
                                zip.file(`data/${poi.video}`).async('blob').then(blob => {
                                    poi.videoBlob = blob;
                                })
                            );
                        }
                    });
                    
                    Promise.all(promises).then(() => {
                        alert('Visite import√©e avec succ√®s !');
                        updatePOIList();
                    });
                });
            }).catch(function(error) {
                alert('Erreur lors de l\'importation: ' + error.message);
            });
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // V√©rifier les donn√©es EXIF pour la g√©olocalisation
            EXIF.getData(file, function() {
                const lat = EXIF.getTag(this, 'GPSLatitude');
                const lon = EXIF.getTag(this, 'GPSLongitude');
                const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
                
                if (lat && lon) {
                    const latitude = convertDMSToDD(lat, latRef);
                    const longitude = convertDMSToDD(lon, lonRef);
                    
                    document.getElementById('latitude').value = latitude.toFixed(6);
                    document.getElementById('longitude').value = longitude.toFixed(6);
                    updateMarker(latitude, longitude);
                }
            });
            
            // Afficher l'aper√ßu
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Aper√ßu image">`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('audioPreview');
                preview.innerHTML = `<audio controls><source src="${e.target.result}" type="audio/mp3"></audio>`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('videoPreview');
                preview.innerHTML = `<video controls width="300"><source src="${e.target.result}" type="video/mp4"></video>`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function convertDMSToDD(dms, ref) {
            let dd = dms[0] + dms[1]/60 + dms[2]/3600;
            if (ref === 'S' || ref === 'W') dd = dd * -1;
            return dd;
        }
        
        function addNewPOI() {
            clearPOIForm();
            editingIndex = -1;
            currentPOI = null;
        }
        
        function clearPOIForm() {
            document.getElementById('poiTitle').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('poiComment').value = '';
            document.getElementById('poiImage').value = '';
            document.getElementById('poiAudio').value = '';
            document.getElementById('poiVideo').value = '';
            
            // Cacher les aper√ßus
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('audioPreview').classList.add('hidden');
            document.getElementById('videoPreview').classList.add('hidden');
            
            // Supprimer le marqueur
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
        }
        
        function savePOI() {
            const title = document.getElementById('poiTitle').value.trim();
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            
            if (!title) {
                alert('Le titre du POI est obligatoire');
                return;
            }
            
            if (isNaN(latitude) || isNaN(longitude)) {
                alert('La localisation est obligatoire');
                return;
            }
            
            const poi = {
                id: editingIndex >= 0 ? visit.pois[editingIndex].id : Date.now(),
                title: title,
                latitude: latitude,
                longitude: longitude,
                comment: document.getElementById('poiComment').value.trim(),
                image: null,
                audio: null,
                video: null,
                imageBlob: null,
                audioBlob: null,
                videoBlob: null
            };
            
            // G√©rer les fichiers
            const imageFile = document.getElementById('poiImage').files[0];
            const audioFile = document.getElementById('poiAudio').files[0];
            const videoFile = document.getElementById('poiVideo').files[0];
            
            if (imageFile) {
                poi.image = `image_${poi.id}.jpg`;
                poi.imageBlob = imageFile;
            }
            
            if (audioFile) {
                poi.audio = `audio_${poi.id}.mp3`;
                poi.audioBlob = audioFile;
            }
            
            if (videoFile) {
                poi.video = `video_${poi.id}.mp4`;
                poi.videoBlob = videoFile;
            }
            
            if (editingIndex >= 0) {
                visit.pois[editingIndex] = poi;
            } else {
                visit.pois.push(poi);
            }
            
            updatePOIList();
            clearPOIForm();
            alert('POI sauvegard√© avec succ√®s !');
        }
        
        function cancelPOI() {
            clearPOIForm();
        }
        
        function updatePOIList() {
            const listElement = document.getElementById('poiList');
            listElement.innerHTML = '';
            
            visit.pois.forEach((poi, index) => {
                const poiElement = document.createElement('div');
                poiElement.className = 'poi-item';
                poiElement.innerHTML = `
                    <h3>${poi.title}</h3>
                    <p><small>üìç ${poi.latitude.toFixed(6)}, ${poi.longitude.toFixed(6)}</small></p>
                    ${poi.comment ? `<p><small>üí¨ ${poi.comment.substring(0, 50)}...</small></p>` : ''}
                    <div class="poi-actions">
                        <button class="btn btn-secondary" onclick="editPOI(${index})">‚úèÔ∏è Modifier</button>
                        <button class="btn btn-danger" onclick="deletePOI(${index})">üóëÔ∏è Supprimer</button>
                    </div>
                `;
                listElement.appendChild(poiElement);
            });
        }
        
        function editPOI(index) {
            const poi = visit.pois[index];
            editingIndex = index;
            
            document.getElementById('poiTitle').value = poi.title;
            document.getElementById('latitude').value = poi.latitude;
            document.getElementById('longitude').value = poi.longitude;
            document.getElementById('poiComment').value = poi.comment || '';
            
            updateMarker(poi.latitude, poi.longitude);
            
            // Afficher les aper√ßus si les fichiers existent
            if (poi.imageBlob) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Aper√ßu image">`;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(poi.imageBlob);
            }
            
            if (poi.audioBlob) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('audioPreview');
                    preview.innerHTML = `<audio controls><source src="${e.target.result}" type="audio/mp3"></audio>`;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(poi.audioBlob);
            }
            
            if (poi.videoBlob) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('videoPreview');
                    preview.innerHTML = `<video controls width="300"><source src="${e.target.result}" type="video/mp4"></video>`;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(poi.videoBlob);
            }
        }
        
        function deletePOI(index) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce POI ?')) {
                visit.pois.splice(index, 1);
                updatePOIList();
            }
        }
        
        function finishEditing() {
            if (visit.pois.length === 0) {
                alert('Veuillez ajouter au moins un POI avant de terminer');
                return;
            }
            showStep(3);
            generateVisitSummary();
        }
        
        function generateVisitSummary() {
            const summaryElement = document.getElementById('visitSummary');
            summaryElement.innerHTML = `
                <h3>üìã R√©sum√© de la visite</h3>
                <p><strong>Titre:</strong> ${visit.title}</p>
                <p><strong>Nombre de POI:</strong> ${visit.pois.length}</p>
                <ul>
                    ${visit.pois.map(poi => `<li><strong>${poi.title}</strong> - ${poi.latitude.toFixed(6)}, ${poi.longitude.toFixed(6)}</li>`).join('')}
                </ul>
            `;
        }
        
        function backToEditing() {
            showStep(2);
        }
        
        function exportVisit() {
            const zip = new JSZip();
            const dataFolder = zip.folder('data');
            
            // Cr√©er le fichier visit.json
            const visitData = {
                title: visit.title,
                pois: visit.pois.map(poi => ({
                    id: poi.id,
                    title: poi.title,
                    latitude: poi.latitude,
                    longitude: poi.longitude,
                    comment: poi.comment,
                    image: poi.image,
                    audio: poi.audio,
                    video: poi.video
                }))
            };
            
            zip.file('visit.json', JSON.stringify(visitData, null, 2));
            
            // Ajouter les fichiers m√©dia
            const promises = [];
            
            visit.pois.forEach(poi => {
                if (poi.imageBlob) {
                    promises.push(
                        dataFolder.file(poi.image, poi.imageBlob)
                    );
                }
                if (poi.audioBlob) {
                    promises.push(
                        dataFolder.file(poi.audio, poi.audioBlob)
                    );
                }
                if (poi.videoBlob) {
                    promises.push(
                        dataFolder.file(poi.video, poi.videoBlob)
                    );
                }
            });
            
            // G√©n√©rer et t√©l√©charger le ZIP
            Promise.all(promises).then(() => {
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `${visit.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.zip`;
                    link.click();
                    
                    alert('Visite export√©e avec succ√®s !');
                });
            });
        }
        
        function