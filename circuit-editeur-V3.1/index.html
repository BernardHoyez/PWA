<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0066cc">
<title>Éditeur de circuit v3.1</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<style>
  body { font-family: system-ui, Arial; margin: 0; }
  header { background: #0066cc; color: white; padding: 12px; text-align: center; }
  main { display: flex; flex-wrap: wrap; gap: 12px; padding: 12px; }
  #left { flex: 1; min-width: 320px; }
  #map { height: 60vh; border: 1px solid #ddd; }
  #poiList { margin-top: 12px; }
  .poiItem { border: 1px solid #ccc; border-radius: 6px; padding: 6px; margin-bottom: 6px; background: #f9f9f9; }
  .poiItem small { display: block; color: #666; margin-top: 2px; }
  button { background: #0066cc; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-right: 4px; }
  input[type=file] { display:block; margin-top:4px; }
</style>
</head>
<body>
<header><h1>Éditeur de circuit v3.1</h1></header>
<main>
  <section id="left">
    <div>
      <label>Nom du circuit : <input id="circuitTitle" type="text" value="Nouveau Circuit"></label>
    </div>
    <div style="margin-top:8px;">
      <label>Ajouter un POI : <input type="text" id="poiName" placeholder="Nom du POI"></label>
      <label>Description : <input type="text" id="poiDesc" placeholder="Description"></label>
      <label>Photo/vidéo : <input type="file" id="poiMedia" accept="image/*,video/*"></label>
      <label>Audio (MP3) : <input type="file" id="poiAudio" accept="audio/mpeg"></label>
      <button id="addPoiBtn">Ajouter POI</button>
    </div>
    <div id="poiList"></div>
    <div style="margin-top:12px;">
      <button id="exportBtn">Exporter ZIP</button>
    </div>
  </section>
  <aside id="mapContainer" style="width:360px; min-width:280px;">
    <div id="map"></div>
    <div style="font-size:0.85rem;color:#444;margin-top:6px;">Cliquez sur la carte pour définir latitude/longitude si non dans EXIF.</div>
  </aside>
</main>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script>
// --- State ---
let map, markerLayer, pois = [];

// --- Map ---
map = L.map('map').setView([45.0,5.0], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
markerLayer = L.layerGroup().addTo(map);

map.on('click', e => {
  const { lat, lng } = e.latlng;
  const lastPoi = pois[pois.length-1];
  if(lastPoi && (!lastPoi.lat || !lastPoi.lon)){
    lastPoi.lat = lat;
    lastPoi.lon = lng;
    alert(`Coordonnées ajoutées : ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
    renderPois();
  }
});

// --- UI ---
const poiListDiv = document.getElementById('poiList');
const addPoiBtn = document.getElementById('addPoiBtn');
const exportBtn = document.getElementById('exportBtn');

addPoiBtn.addEventListener('click', () => {
  const name = document.getElementById('poiName').value.trim();
  if(!name) return alert('Nom du POI obligatoire');
  const desc = document.getElementById('poiDesc').value.trim();
  const mediaFile = document.getElementById('poiMedia').files[0];
  const audioFile = document.getElementById('poiAudio').files[0];

  let poi = { id: 'poi'+(pois.length+1), title:name, description:desc, lat:null, lon:null };
  if(mediaFile) poi.media = mediaFile;
  if(audioFile) poi.audio = audioFile;

  pois.push(poi);
  renderPois();
});

function renderPois(){
  poiListDiv.innerHTML = '';
  markerLayer.clearLayers();
  pois.forEach((poi,i)=>{
    const div = document.createElement('div');
    div.className = 'poiItem';
    div.innerHTML = `<strong>${poi.title}</strong><small>${poi.description}</small>${poi.lat&&poi.lon?'<small>'+poi.lat.toFixed(6)+', '+poi.lon.toFixed(6)+'</small>':''}`;
    poiListDiv.appendChild(div);

    if(poi.lat && poi.lon) L.marker([poi.lat,poi.lon]).addTo(markerLayer).bindPopup(poi.title);
  });
}

exportBtn.addEventListener('click', async () => {
  if(pois.length===0) return alert('Aucun POI à exporter');
  const zip = new JSZip();
  const folderMedia = zip.folder('media');

  let manifest = { title: document.getElementById('circuitTitle').value.trim(), id:'circuit-'+Date.now(), waypoints:[] };
  for(let poi of pois){
    let wp = { id: poi.id, title: poi.title, description: poi.description, lat: poi.lat, lon: poi.lon };
    if(poi.media){
      const content = await poi.media.arrayBuffer();
      folderMedia.file(poi.media.name, content);
      wp.media = 'media/'+poi.media.name;
    }
    if(poi.audio){
      const content = await poi.audio.arrayBuffer();
      folderMedia.file(poi.audio.name, content);
      wp.audio = 'media/'+poi.audio.name;
    }
    manifest.waypoints.push(wp);
  }

  zip.file('manifest.json', JSON.stringify(manifest,null,2));
  zip.generateAsync({type:'blob'}).then(content=>{
    const url = URL.createObjectURL(content);
    const a = document.createElement('a');
    a.href = url; a.download = 'circuit.zip'; a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
