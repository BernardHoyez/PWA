<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimiseur 16/9</title>
<link rel="manifest" href="manifest.json">
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 1em; }
  canvas { border: 1px solid #ccc; touch-action: none; }
  #controls { margin-top: 1em; display: flex; flex-direction: column; gap: 0.5em; }
  button { padding: 0.5em 1em; }
</style>
</head>
<body>

<h1>Optimiseur 16/9</h1>
<input type="file" id="fileInput" accept="image/*">

<canvas id="canvas"></canvas>

<div id="dimensions">
  <p>Photo originale : <span id="originalDim">0 × 0</span></p>
  <p>Cadre sélection : <span id="cropDim">0 × 0</span></p>
</div>

<div id="controls">
  <button id="saveOriginal">Sauvegarder taille sélection</button>
  <button id="saveWidth1220">Sauvegarder largeur 1220px</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();

// Cadre portrait initial
let selection = { x:50, y:50, w:90, h:160 };
const handleSize = 10; // taille des coins pour resize
let dragging = false;
let resizing = false;
let resizeCorner = null;
let offsetX, offsetY;

const originalDim = document.getElementById('originalDim');
const cropDim = document.getElementById('cropDim');

function drawSelection() {
    ctx.strokeStyle='red';
    ctx.lineWidth=2;
    ctx.strokeRect(selection.x, selection.y, selection.w, selection.h);

    // coins pour resize
    const corners = [
        {x:selection.x, y:selection.y},
        {x:selection.x+selection.w, y:selection.y},
        {x:selection.x, y:selection.y+selection.h},
        {x:selection.x+selection.w, y:selection.y+selection.h}
    ];
    ctx.fillStyle='blue';
    corners.forEach(c=>ctx.fillRect(c.x-handleSize/2,c.y-handleSize/2,handleSize,handleSize));
}

function updateCanvas() {
    canvas.width = img.width > 800 ? 800 : img.width;
    canvas.height = img.height * canvas.width / img.width;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    drawSelection();
    cropDim.textContent = `${Math.round(selection.w)} × ${Math.round(selection.h)}`;
}

function getCorner(x,y){
    const corners = [
        {name:'tl', x:selection.x, y:selection.y},
        {name:'tr', x:selection.x+selection.w, y:selection.y},
        {name:'bl', x:selection.x, y:selection.y+selection.h},
        {name:'br', x:selection.x+selection.w, y:selection.y+selection.h}
    ];
    for(const c of corners){
        if(Math.abs(x-c.x)<=handleSize && Math.abs(y-c.y)<=handleSize) return c.name;
    }
    return null;
}

document.getElementById('fileInput').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = ev=>{
            img.src = ev.target.result;
            img.onload = ()=>{
                originalDim.textContent = `${img.width} × ${img.height}`;
                selection.h = selection.w * 16/9; // portrait ratio
                updateCanvas();
            }
        };
        reader.readAsDataURL(file);
    }
});

canvas.addEventListener('pointerdown', e=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const corner = getCorner(x,y);
    if(corner){
        resizing = true;
        resizeCorner = corner;
    } else if(x>selection.x && x<selection.x+selection.w && y>selection.y && y<selection.y+selection.h){
        dragging = true;
        offsetX = x - selection.x;
        offsetY = y - selection.y;
    }
});

canvas.addEventListener('pointermove', e=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    if(resizing){
        let newW, newH;
        if(resizeCorner==='br'){
            newW = x - selection.x;
            newH = newW*16/9;
        } else if(resizeCorner==='bl'){
            newW = selection.x+selection.w-x;
            newH = newW*16/9;
            selection.x = x;
        } else if(resizeCorner==='tr'){
            newW = x - selection.x;
            newH = newW*16/9;
            selection.y = selection.y + selection.h - newH;
        } else if(resizeCorner==='tl'){
            newW = selection.x+selection.w-x;
            newH = newW*16/9;
            selection.x = x;
            selection.y = selection.y + selection.h - newH;
        }
        selection.w = Math.max(20, newW);
        selection.h = Math.max(20, newH);
        // limite au canvas
        selection.x = Math.max(0, Math.min(selection.x, canvas.width-selection.w));
        selection.y = Math.max(0, Math.min(selection.y, canvas.height-selection.h));
        updateCanvas();
    } else if(dragging){
        selection.x = x - offsetX;
        selection.y = y - offsetY;
        selection.x = Math.max(0, Math.min(selection.x, canvas.width - selection.w));
        selection.y = Math.max(0, Math.min(selection.y, canvas.height - selection.h));
        updateCanvas();
    }
});

canvas.addEventListener('pointerup', ()=>{dragging=false; resizing=false; resizeCorner=null;});
canvas.addEventListener('pointerleave', ()=>{dragging=false; resizing=false; resizeCorner=null;});

// Save functions
function saveImage(width=null){
    const tempCanvas = document.createElement('canvas');
    let scale = 1;
    if(width) scale = width / selection.w;
    tempCanvas.width = selection.w * scale;
    tempCanvas.height = selection.h * scale;
    const tCtx = tempCanvas.getContext('2d');
    tCtx.drawImage(img, selection.x*(img.width/canvas.width), selection.y*(img.height/canvas.height),
        selection.w*(img.width/canvas.width), selection.h*(img.height/canvas.height),
        0,0,tempCanvas.width,tempCanvas.height
    );
    const link = document.createElement('a');
    link.download = 'photo_cadree.png';
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
}

document.getElementById('saveOriginal').addEventListener('click', ()=>saveImage());
document.getElementById('saveWidth1220').addEventListener('click', ()=>saveImage(1220));
</script>

</body>
</html>
