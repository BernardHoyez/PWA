<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>varcoord</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">

<style>
html,body { margin:0; height:100%; font-family:Arial; }

#map { width:100%; height:100%; }

/* -------- PANELS -------- */

.panel {
  position:absolute;
  background:white;
  padding:12px;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.35);
  z-index:1000;
}

/* Desktop */
#panelA { top:10px; left:10px; width:300px; }
#panelB { top:10px; right:10px; width:300px; }

/* Mobile */
@media (max-width: 640px) {
  #panelA, #panelB {
    position:relative;
    width:auto;
    margin:8px;
  }
  #panelB { margin-top:0; }
  body { display:flex; flex-direction:column; }
  #map { flex:1; }
}

button {
  width:100%;
  padding:10px;
  margin-top:6px;
  font-size:15px;
}

input {
  width:100%;
  padding:8px;
  font-size:15px;
}
</style>
</head>

<body>

<div id="panelA" class="panel">
<b>Cliquer pour afficher des coordonnées</b>
<div id="coords"></div>
<button id="copyDec" style="display:none;">Copier décimal</button>
<button id="copySexa" style="display:none;">Copier sexagésimal</button>
</div>

<div id="panelB" class="panel">
<b>Aller vers des coordonnées</b>
<input id="inputCoord" placeholder="Coller décimal ou sexagésimal">
<button id="goBtn">Aller vers le point</button>
<button id="gmBtn">Ouvrir Google Maps</button>
<button id="wazeBtn">Ouvrir Waze</button>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>

<script>

// -------- PLAN IGN V2 --------

const ign = new ol.layer.Tile({
  source: new ol.source.WMTS({
    url: "https://data.geopf.fr/wmts",
    layer: "GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2",
    matrixSet: "PM",
    format: "image/png",
    style: "normal",
    tileGrid: new ol.tilegrid.WMTS({
      origin: [-20037508, 20037508],
      resolutions: [
        156543.033928,78271.516964,39135.758482,19567.879241,
        9783.9396205,4891.96981025,2445.98490513,1222.99245256,
        611.496226281,305.748113141,152.87405657,76.4370282852,
        38.2185141426,19.1092570713,9.55462853565,4.77731426782,
        2.38865713391,1.19432856696,0.597164283478
      ],
      matrixIds: Array.from({length:19}, (_,i)=>String(i))
    })
  })
});

const markerSource = new ol.source.Vector();
const markerLayer = new ol.layer.Vector({ source: markerSource });

function setMarker(lon,lat){
  markerSource.clear();
  markerSource.addFeature(
    new ol.Feature({
      geometry: new ol.geom.Point(
        ol.proj.fromLonLat([lon,lat])
      )
    })
  );
}

const map = new ol.Map({
  target: "map",
  layers: [ign, markerLayer],
  view: new ol.View({
    center: ol.proj.fromLonLat([6.18326, 43.478778]),
    zoom: 15
  })
});

// -------- CONVERSIONS --------

function toSexa(v,isLat){
  const d=Math.floor(Math.abs(v));
  const mF=(Math.abs(v)-d)*60;
  const m=Math.floor(mF);
  const s=((mF-m)*60).toFixed(2);
  const dir=isLat?(v>=0?"N":"S"):(v>=0?"E":"W");
  return `${d}°${m}'${s}"${dir}`;
}

function parseDec(txt){
  const m = txt.match(/(-?\d+\.?\d*)[, ;]+(-?\d+\.?\d*)/);
  return m ? {lat:+m[1], lon:+m[2]} : null;
}

function parseSexa(txt){
  const r=/(\d+)[° ]+(\d+)[']+([\d.]+)["]?\s*([NSEW])/gi;
  let m, vals=[];
  while((m=r.exec(txt))){
    let v = +m[1] + m[2]/60 + m[3]/3600;
    if("SW".includes(m[4])) v=-v;
    vals.push(v);
  }
  return vals.length>=2 ? {lat:vals[0], lon:vals[1]} : null;
}

// -------- CLIC --------

let lastLat=null,lastLon=null;

map.on("click", e=>{
  const ll=ol.proj.toLonLat(e.coordinate);
  lastLat=ll[1];
  lastLon=ll[0];

  coords.innerHTML =
    "<b>Décimal</b><br>"+lastLat.toFixed(6)+", "+lastLon.toFixed(6)+
    "<br><b>Sexagésimal</b><br>"+
    toSexa(lastLat,true)+" "+toSexa(lastLon,false);

  copyDec.style.display="block";
  copySexa.style.display="block";
  setMarker(lastLon,lastLat);
});

// -------- BOUTONS --------

copyDec.onclick=()=>navigator.clipboard.writeText(
  `${lastLat.toFixed(6)}, ${lastLon.toFixed(6)}`
);

copySexa.onclick=()=>navigator.clipboard.writeText(
  `${toSexa(lastLat,true)} ${toSexa(lastLon,false)}`
);

goBtn.onclick=()=>{
  const p=parseDec(inputCoord.value)||parseSexa(inputCoord.value);
  if(!p){ alert("Format non reconnu"); return; }
  map.getView().animate({
    center: ol.proj.fromLonLat([p.lon,p.lat]),
    zoom:16
  });
  setMarker(p.lon,p.lat);
  lastLat=p.lat; lastLon=p.lon;
};

gmBtn.onclick=()=> lastLat &&
  window.open(`https://google.com/maps?q=${lastLat},${lastLon}`);

wazeBtn.onclick=()=> lastLat &&
  window.open(`https://waze.com/ul?ll=${lastLat},${lastLon}&navigate=yes`);

</script>
</body>
</html>
