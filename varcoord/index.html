<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>varcoord</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">

<style>
html,body { margin:0; height:100%; font-family:Arial; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  max-width:340px;
  z-index:1000;
}

#panelA { top:10px; left:10px; }
#panelB { top:10px; right:10px; }

button {
  width:100%;
  padding:8px;
  margin-top:6px;
  cursor:pointer;
}

input {
  width:100%;
  padding:6px;
  margin-top:6px;
}
</style>
</head>

<body>

<div id="map"></div>

<!-- --------- BOITE A --------- -->

<div id="panelA" class="panel">
<b>Cliquer sur la carte</b>
<div id="coords"></div>

<button id="copyDec" style="display:none;">Copier décimal</button>
<button id="copySexa" style="display:none;">Copier sexagésimal</button>
</div>

<!-- --------- BOITE B --------- -->

<div id="panelB" class="panel">
<b>Aller vers coordonnées</b>
<input id="inputCoord" placeholder="Coller décimal ou sexagésimal">

<button id="goBtn">Aller vers le point</button>
<button id="gmBtn">Ouvrir Google Maps</button>
<button id="wazeBtn">Ouvrir Waze</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>

<script>

// ---------------- PLAN IGN V2 ----------------

const ign = new ol.layer.Tile({
  source: new ol.source.WMTS({
    url: "https://data.geopf.fr/wmts",
    layer: "GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2",
    matrixSet: "PM",
    format: "image/png",
    style: "normal",
    tileGrid: new ol.tilegrid.WMTS({
      origin: [-20037508, 20037508],
      resolutions: [
        156543.033928,78271.516964,39135.758482,19567.879241,
        9783.9396205,4891.96981025,2445.98490513,1222.99245256,
        611.496226281,305.748113141,152.87405657,76.4370282852,
        38.2185141426,19.1092570713,9.55462853565,4.77731426782,
        2.38865713391,1.19432856696,0.597164283478
      ],
      matrixIds: Array.from({length:19}, (_,i)=>String(i))
    })
  })
});

// ---------------- MARQUEUR ----------------

const markerSource = new ol.source.Vector();
const markerLayer = new ol.layer.Vector({ source: markerSource });

function setMarker(lon,lat){
  markerSource.clear();
  const feat = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([lon,lat]))
  });
  markerSource.addFeature(feat);
}

// ---------------- CARTE ----------------

const map = new ol.Map({
  target: "map",
  layers: [ign, markerLayer],
  view: new ol.View({
    center: ol.proj.fromLonLat([6.18326, 43.478778]),
    zoom: 15
  })
});

// ---------------- SEXAGESIMAL ----------------

function toSexa(v,isLat){
  const d=Math.floor(Math.abs(v));
  const mF=(Math.abs(v)-d)*60;
  const m=Math.floor(mF);
  const s=((mF-m)*60).toFixed(2);
  const dir=isLat?(v>=0?"N":"S"):(v>=0?"E":"W");
  return `${d}°${m}'${s}"${dir}`;
}

// ---------------- PARSE SEXA ----------------

function parseSexa(txt){
  const r=/(\d+)[° ]+(\d+)[']+([\d.]+)["]?\s*([NSEW])/gi;
  let m, vals=[];
  while((m=r.exec(txt))!==null){
    let v = +m[1] + m[2]/60 + m[3]/3600;
    if(m[4]=="S"||m[4]=="W") v=-v;
    vals.push(v);
  }
  if(vals.length>=2) return {lat:vals[0], lon:vals[1]};
  return null;
}

// ---------------- PARSE DECIMAL ----------------

function parseDec(txt){
  const m = txt.match(/(-?\d+\.?\d*)[, ;]+(-?\d+\.?\d*)/);
  if(!m) return null;
  return {lat:+m[1], lon:+m[2]};
}

// ---------------- CLIC CARTE ----------------

let lastLat=null, lastLon=null;

map.on("click", e=>{
  const ll=ol.proj.toLonLat(e.coordinate);
  lastLat=ll[1];
  lastLon=ll[0];

  const dec=`${lastLat.toFixed(6)}, ${lastLon.toFixed(6)}`;
  const sex=`${toSexa(lastLat,true)} ${toSexa(lastLon,false)}`;

  coords.innerHTML =
    "<b>Décimal</b><br>"+dec+
    "<br><b>Sexagésimal</b><br>"+sex;

  copyDec.style.display="block";
  copySexa.style.display="block";

  setMarker(lastLon,lastLat);
});

// ---------------- COPIES ----------------

copyDec.onclick=()=>navigator.clipboard.writeText(
  `${lastLat.toFixed(6)}, ${lastLon.toFixed(6)}`
);

copySexa.onclick=()=>navigator.clipboard.writeText(
  `${toSexa(lastLat,true)} ${toSexa(lastLon,false)}`
);

// ---------------- ALLER VERS POINT ----------------

goBtn.onclick=()=>{
  const txt=inputCoord.value.trim();
  let p=parseDec(txt) || parseSexa(txt);
  if(!p){ alert("Format non reconnu"); return; }

  map.getView().animate({
    center: ol.proj.fromLonLat([p.lon,p.lat]),
    zoom:16
  });

  setMarker(p.lon,p.lat);
  lastLat=p.lat;
  lastLon=p.lon;
};

// ---------------- NAVIGATION ----------------

gmBtn.onclick=()=>{
  if(lastLat===null) return;
  window.open(
    `https://www.google.com/maps?q=${lastLat},${lastLon}`
  );
};

wazeBtn.onclick=()=>{
  if(lastLat===null) return;
  window.open(
    `https://waze.com/ul?ll=${lastLat},${lastLon}&navigate=yes`
  );
};

</script>
</body>
</html>
