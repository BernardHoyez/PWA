<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2196f3" />
  <title>Éditeur de circuit</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">Éditeur de Circuit</h1>

    <!-- Formulaire infos générales -->
    <div class="bg-white shadow-md rounded-lg p-4 mb-4">
      <h2 class="text-lg font-semibold mb-2">Informations du circuit</h2>
      <label class="block mb-2">Titre : <input id="circuitTitle" class="border rounded p-1 w-full" type="text"></label>
      <label class="block mb-2">Langue : <input id="circuitLang" class="border rounded p-1 w-full" value="fr" type="text"></label>
    </div>

    <!-- Ajout de POI -->
    <div class="bg-white shadow-md rounded-lg p-4 mb-4">
      <h2 class="text-lg font-semibold mb-2">Ajouter un point d'intérêt</h2>
      <label class="block mb-2">Titre : <input id="poiTitle" class="border rounded p-1 w-full" type="text"></label>
      <label class="block mb-2">Description : <textarea id="poiDesc" class="border rounded p-1 w-full"></textarea></label>
      <label class="block mb-2">Médias : <input id="poiMedia" class="border rounded p-1 w-full" type="file" multiple></label>
      <label class="block mb-2">Latitude : <input id="poiLat" class="border rounded p-1 w-full" type="number"></label>
      <label class="block mb-2">Longitude : <input id="poiLon" class="border rounded p-1 w-full" type="number"></label>
      <label class="block mb-2">Rayon d'arrivée (m) : <input id="poiRadius" class="border rounded p-1 w-full" value="15" type="number"></label>
      <button id="addPoiBtn" class="bg-blue-500 text-white rounded px-4 py-2 mt-2">Ajouter POI</button>
    </div>

    <!-- Carte pour positionner les POI -->
    <div id="map" class="w-full h-64 rounded shadow mb-4"></div>

    <!-- Liste des POI -->
    <div class="bg-white shadow-md rounded-lg p-4 mb-4">
      <h2 class="text-lg font-semibold mb-2">Points d'intérêt</h2>
      <ul id="poiList" class="space-y-2"></ul>
    </div>

    <!-- Export -->
    <button id="exportBtn" class="bg-green-600 text-white rounded px-4 py-2">Exporter le circuit (.zip)</button>
  </div>

  <script>
    const waypoints = [];
    const poiList = document.getElementById("poiList");
    const map = L.map("map").setView([45.0, 5.0], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    // Lecture des coordonnées GPS EXIF
    document.getElementById("poiMedia").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith("image")) return;

      const reader = new FileReader();
      reader.onload = function() {
        EXIF.getData({ data: reader.result }, function() {
          const lat = EXIF.getTag(this, "GPSLatitude");
          const lon = EXIF.getTag(this, "GPSLongitude");
          const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
          const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

          if (lat && lon) {
            const latDec = convertDMSToDD(lat[0], lat[1], lat[2], latRef);
            const lonDec = convertDMSToDD(lon[0], lon[1], lon[2], lonRef);
            document.getElementById("poiLat").value = latDec;
            document.getElementById("poiLon").value = lonDec;
          }
        });
      };
      reader.readAsArrayBuffer(file);
    });

    function convertDMSToDD(deg, min, sec, ref) {
      let dd = deg + min / 60 + sec / 3600;
      if (ref === "S" || ref === "W") dd = dd * -1;
      return dd;
    }

    // Ajout d'un POI
    document.getElementById("addPoiBtn").addEventListener("click", async () => {
      const title = document.getElementById("poiTitle").value;
      const desc = document.getElementById("poiDesc").value;
      const lat = parseFloat(document.getElementById("poiLat").value);
      const lon = parseFloat(document.getElementById("poiLon").value);
      const radius = parseInt(document.getElementById("poiRadius").value);
      const mediaInput = document.getElementById("poiMedia");
      const files = Array.from(mediaInput.files);

      // Vérification taille fichiers individuels
      for (const file of files) {
        if (file.size > 20 * 1024 * 1024) {
          alert(`Le fichier ${file.name} dépasse 20 Mo. Choisissez un fichier plus léger.`);
          return;
        }
      }

      const poiId = "wp-" + (waypoints.length + 1);

      const media = files.map(f => ({
        type: f.type.startsWith("image") ? "image" : (f.type.startsWith("audio") ? "audio" : "video"),
        file: `media/${poiId}-${f.name}`
      }));

      waypoints.push({ id: poiId, title, description: desc, media, lat, lon, arrivalRadius: radius, order: waypoints.length + 1 });

      // Ajout visuel sur carte
      L.marker([lat, lon]).addTo(map).bindPopup(`<b>${title}</b>`);

      // Ajout dans la liste HTML
      const li = document.createElement("li");
      li.textContent = `${title} (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
      poiList.appendChild(li);

      // Reset formulaire
      document.getElementById("poiTitle").value = "";
      document.getElementById("poiDesc").value = "";
      document.getElementById("poiMedia").value = "";
      document.getElementById("poiLat").value = "";
      document.getElementById("poiLon").value = "";
    });

    // Export ZIP
    document.getElementById("exportBtn").addEventListener("click", async () => {
      if (waypoints.length === 0) {
        alert("Ajoutez au moins un point d'intérêt.");
        return;
      }

      const circuit = {
        id: "circuit-" + Date.now(),
        title: document.getElementById("circuitTitle").value || "Circuit sans titre",
        language: document.getElementById("circuitLang").value,
        createdAt: new Date().toISOString(),
        startPoint: { lat: waypoints[0].lat, lon: waypoints[0].lon },
        waypoints
      };

      const zip = new JSZip();
      zip.file("manifest.json", JSON.stringify(circuit, null, 2));

      // Ajouter médias
      for (const wp of waypoints) {
        for (const m of wp.media) {
          const fileInput = document.querySelector(`#poiMedia`);
          const file = Array.from(fileInput.files).find(f => m.file.endsWith(f.name));
          if (file) zip.file(m.file, file);
        }
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, `${circuit.id}.zip`);
    });
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
      .then(() => console.log("Service Worker enregistré !"))
      .catch(err => console.error("SW erreur :", err));
  }
</script>
</body>
</html>
