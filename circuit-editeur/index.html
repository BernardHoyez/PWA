<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2196f3">
<title>Éditeur de circuit</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<!-- exifr CDN for EXIF GPS extraction -->
<script src="https://unpkg.com/exifr/dist/full.umd.js"></script>
<style>
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold text-center mb-4">Éditeur de Circuit (prototype)</h1>

  <div class="bg-white shadow rounded p-4 mb-4">
    <h2 class="font-semibold">Infos circuit</h2>
    <label class="block mt-2">Titre: <input id="circuitTitle" class="border p-1 w-full" /></label>
    <label class="block mt-2">Langue: <input id="circuitLang" class="border p-1 w-full" value="fr" /></label>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="bg-white shadow rounded p-4">
      <h2 class="font-semibold">Ajouter / éditer un POI</h2>
      <label class="block mt-2">Photo (image géoloc ou non): <input id="photoInput" type="file" accept="image/*" /></label>
      <label class="block mt-2">Audio (optionnel): <input id="audioInput" type="file" accept="audio/*" /></label>
      <label class="block mt-2">Titre: <input id="poiTitle" class="border p-1 w-full" /></label>
      <label class="block mt-2">Description: <textarea id="poiDesc" class="border p-1 w-full"></textarea></label>
      <label class="block mt-2">Latitude: <input id="poiLat" class="border p-1 w-full" /></label>
      <label class="block mt-2">Longitude: <input id="poiLon" class="border p-1 w-full" /></label>
      <label class="block mt-2">Rayon d'arrivée (m): <input id="poiRadius" class="border p-1 w-full" value="15" /></label>
      <div class="mt-3 space-x-2">
        <button id="addPoiBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Ajouter POI</button>
        <button id="resetBtn" class="bg-gray-500 text-white px-3 py-1 rounded">Réinitialiser formulaire</button>
      </div>
      <p class="text-sm text-gray-600 mt-2">Si la photo contient GPS EXIF, latitude/longitude seront extraites automatiquement et le marqueur placé sur la carte. Sinon, cliquez sur la carte pour positionner le POI.</p>
    </div>

    <div class="bg-white shadow rounded p-4">
      <h2 class="font-semibold">Carte (cliquez pour positionner si nécessaire)</h2>
      <div id="map" class="w-full h-80 rounded"></div>
      <div class="mt-3">
        <button id="exportBtn" class="bg-green-600 text-white px-3 py-1 rounded">Exporter le circuit (.zip)</button>
        <span id="status" class="ml-3 text-sm text-gray-600"></span>
      </div>
    </div>
  </div>

  <div class="bg-white shadow rounded p-4 mt-4">
    <h2 class="font-semibold">Points d'intérêt (ordre d'ajout)</h2>
    <ol id="poiList" class="list-decimal ml-5"></ol>
  </div>
</div>

<script>
  // Basic state
  const waypoints = []; // {id, title, desc, lat, lon, radius, photoFile, audioFile, photoPath, audioPath}
  const map = L.map('map').setView([45.0,5.0], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '© OpenStreetMap' }).addTo(map);
  let tempMarker = null;

  // Helpers
  function toFixedOrEmpty(n, d=5){ return (typeof n === 'number') ? n.toFixed(d) : ''; }
  function uid(prefix='id'){ return prefix + '-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*1000); }

  // Map click for manual placement
  map.on('click', (e) => {
    const lat = e.latlng.lat, lon = e.latlng.lng;
    document.getElementById('poiLat').value = lat;
    document.getElementById('poiLon').value = lon;
    if(tempMarker) tempMarker.setLatLng(e.latlng);
    else tempMarker = L.marker(e.latlng).addTo(map).bindPopup('Position POI (cliquer Ajouter)').openPopup();
  });

  // Extract EXIF GPS when photo chosen using exifr
  const photoInput = document.getElementById('photoInput');
  photoInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    // size check
    if(file.size > 20*1024*1024){ alert('Photo > 20 Mo refusée'); photoInput.value=''; return; }
    try {
      const exif = await window.exifr.parse(file, {gps:true});
      if(exif && exif.latitude && exif.longitude){
        document.getElementById('poiLat').value = exif.latitude;
        document.getElementById('poiLon').value = exif.longitude;
        // place marker
        const latlng = [exif.latitude, exif.longitude];
        if(tempMarker) tempMarker.setLatLng(latlng);
        else tempMarker = L.marker(latlng).addTo(map).bindPopup('Position extrait EXIF').openPopup();
        map.setView(latlng, 17);
      } else {
        // no gps -> user must click on map
        // optionally center map on user location
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos => map.setView([pos.coords.latitude,pos.coords.longitude], 15));
        }
        alert('Aucune donnée GPS EXIF trouvée : cliquez sur la carte pour positionner le POI ou saisissez manuellement lat/lon.');
      }
    } catch(err){
      console.error('exif read error', err);
      alert('Erreur lecture EXIF (voir console).');
    }
  });

  // Add POI
  document.getElementById('addPoiBtn').addEventListener('click', () => {
    const title = document.getElementById('poiTitle').value.trim();
    const desc = document.getElementById('poiDesc').value.trim();
    const latVal = document.getElementById('poiLat').value;
    const lonVal = document.getElementById('poiLon').value;
    const radius = parseFloat(document.getElementById('poiRadius').value) || 15;
    const photoFile = document.getElementById('photoInput').files[0];
    const audioFile = document.getElementById('audioInput').files[0];

    if(!title){ alert('Titre requis'); return; }
    if(!photoFile){ alert('Photo requise'); return; }
    if(photoFile.size > 20*1024*1024){ alert('Photo > 20 Mo refusée'); return; }
    if(audioFile && audioFile.size > 20*1024*1024){ alert('Audio > 20 Mo refusé'); return; }

    let lat = latVal ? parseFloat(latVal) : null;
    let lon = lonVal ? parseFloat(lonVal) : null;
    if((lat === null || lon === null) && !tempMarker){
      alert('Aucune coordonnée fournie : utilisez une photo géolocalisée ou cliquez sur la carte pour positionner le POI.'); return;
    }
    if((lat === null || lon === null) && tempMarker){
      const p = tempMarker.getLatLng(); lat = p.lat; lon = p.lng;
    }

    const id = uid('wp');
    const wp = { id, title, description: desc, lat, lon, radius, photoFile: photoFile || null, audioFile: audioFile || null };
    waypoints.push(wp);

    // add marker
    L.marker([lat,lon]).addTo(map).bindPopup(`<b>${title}</b>`);

    // list
    const li = document.createElement('li');
    li.innerHTML = `<strong>${title}</strong> — ${toFixedOrEmpty(lat)}, ${toFixedOrEmpty(lon)} <br><em>${desc}</em>`;
    document.getElementById('poiList').appendChild(li);

    // reset form
    document.getElementById('poiTitle').value=''; document.getElementById('poiDesc').value=''; document.getElementById('photoInput').value=''; document.getElementById('audioInput').value=''; document.getElementById('poiLat').value=''; document.getElementById('poiLon').value=''; if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }

    document.getElementById('status').textContent = `${waypoints.length} POI(s)`;
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('poiTitle').value=''; document.getElementById('poiDesc').value=''; document.getElementById('photoInput').value=''; document.getElementById('audioInput').value=''; document.getElementById('poiLat').value=''; document.getElementById('poiLon').value=''; if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
  });

  // Export ZIP logic
  document.getElementById('exportBtn').addEventListener('click', async () => {
    if(waypoints.length === 0){ alert('Aucun POI à exporter'); return; }
    const circuit = {
      id: 'circuit-' + Date.now(),
      title: document.getElementById('circuitTitle').value || 'Circuit sans titre',
      language: document.getElementById('circuitLang').value || 'fr',
      createdAt: new Date().toISOString(),
      startPoint: { lat: waypoints[0].lat, lon: waypoints[0].lon },
      waypoints: []
    };
    const zip = new JSZip();
    const mediaFolder = zip.folder('media');

    // include minimal README
    zip.file('README.txt', 'Circuit exporté depuis Éditeur PWA. Structure: manifest.json + media/');

    for(let i=0;i<waypoints.length;i++){
      const wp = waypoints[i];
      const entry = {
        id: wp.id,
        title: wp.title,
        description: wp.description,
        lat: wp.lat,
        lon: wp.lon,
        arrivalRadius: wp.radius,
        order: i+1,
        media: []
      };
      // photo
      if(wp.photoFile){
        const safePhotoName = `${wp.id}-photo-${wp.photoFile.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
        entry.media.push({type: 'image', file: `media/${safePhotoName}`});
        // add file blob
        const arrayBuffer = await wp.photoFile.arrayBuffer();
        mediaFolder.file(safePhotoName, arrayBuffer);
      }
      // audio
      if(wp.audioFile){
        const safeAudioName = `${wp.id}-audio-${wp.audioFile.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
        entry.media.push({type: 'audio', file: `media/${safeAudioName}`});
        const arrayBufferA = await wp.audioFile.arrayBuffer();
        mediaFolder.file(safeAudioName, arrayBufferA);
      }
      circuit.waypoints.push(entry);
    }

    zip.file('manifest.json', JSON.stringify(circuit, null, 2));

    document.getElementById('status').textContent = 'Génération ZIP...';
    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, `${circuit.id}.zip`);
    document.getElementById('status').textContent = 'Export terminé';
  });

  // register SW
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('SW enregistré')).catch(e=>console.warn('SW fail',e));
  }
</script>
</body>
</html>
