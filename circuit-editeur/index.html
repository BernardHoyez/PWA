<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ã‰diteur de Circuit Touristique</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/exifr/dist/full.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #0066cc; color: white; padding: 10px; text-align: center; }
    main { padding: 10px; }
    .poi-form { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 8px; background: #f9f9f9; }
    .poi-list { margin-top: 20px; }
    .poi-item { display: flex; align-items: center; margin-bottom: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
    .poi-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 10px; }
    .poi-item span { margin-right: 10px; }
    #map { height: 300px; margin-top: 10px; }
    button { padding: 6px 12px; margin-top: 5px; cursor: pointer; border: none; background: #0066cc; color: white; border-radius: 5px; }
    button:hover { background: #004999; }
  </style>
</head>
<body>
  <header>
    <h1>Ã‰diteur de Circuit Touristique</h1>
  </header>
  <main>
    <div class="poi-form">
      <label>Titre : <input type="text" id="title" /></label><br/>
      <label>Description : <textarea id="description"></textarea></label><br/>
      <label>Photo : <input type="file" id="photo" accept="image/*"></label><br/>
      <label>VidÃ©o : <input type="file" id="video" accept="video/mp4,video/webm"></label><br/>
      <label>Audio : <input type="file" id="audio" accept="audio/mp3,audio/wav"></label><br/>
      <label>Latitude : <input type="text" id="latitude" /></label><br/>
      <label>Longitude : <input type="text" id="longitude" /></label><br/>
      <label>Rayon (m) : <input type="number" id="radius" value="20" /></label><br/>
      <button id="addPoi">Ajouter le POI</button>
    </div>

    <div id="map"></div>

    <div class="poi-list" id="poiList">
      <h3>Points d'intÃ©rÃªt</h3>
    </div>

    <button id="exportZip">Exporter en ZIP</button>
  </main>

  <script>
    const map = L.map('map').setView([43.7, 6.3], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    let currentMarker = null;
    let pois = [];

    // Gestion clic sur carte
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      document.getElementById('latitude').value = lat.toFixed(6);
      document.getElementById('longitude').value = lng.toFixed(6);
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker([lat, lng]).addTo(map);
    });

    // Lecture EXIF auto
    document.getElementById('photo').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (file) {
        try {
          const exif = await exifr.gps(file);
          if (exif && exif.latitude && exif.longitude) {
            document.getElementById('latitude').value = exif.latitude;
            document.getElementById('longitude').value = exif.longitude;
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([exif.latitude, exif.longitude]).addTo(map);
            map.setView([exif.latitude, exif.longitude], 16);
          }
        } catch (err) {
          console.error('Pas de GPS EXIF trouvÃ©.');
        }
      }
    });

    // Ajout POI
    document.getElementById('addPoi').addEventListener('click', function() {
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const latitude = parseFloat(document.getElementById('latitude').value);
      const longitude = parseFloat(document.getElementById('longitude').value);
      const radius = parseInt(document.getElementById('radius').value);
      const photo = document.getElementById('photo').files[0];
      const video = document.getElementById('video').files[0];
      const audio = document.getElementById('audio').files[0];

      if (!title || isNaN(latitude) || isNaN(longitude)) {
        alert('Titre, latitude et longitude sont obligatoires.');
        return;
      }

      const poi = { title, description, latitude, longitude, radius,
                    photo: photo ? photo.name : null,
                    video: video ? video.name : null,
                    audio: audio ? audio.name : null,
                    files: { photo, video, audio } };
      pois.push(poi);
      afficherPois();
    });

    function afficherPois() {
      const list = document.getElementById('poiList');
      list.innerHTML = '<h3>Points d'intÃ©rÃªt</h3>';
      pois.forEach((poi, i) => {
        const div = document.createElement('div');
        div.className = 'poi-item';
        if (poi.photo) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(poi.files.photo);
          div.appendChild(img);
        }
        const info = document.createElement('span');
        info.textContent = poi.title;
        div.appendChild(info);
        if (poi.video) div.innerHTML += ' ðŸŽ¥';
        if (poi.audio) div.innerHTML += ' ðŸŽ§';
        list.appendChild(div);
      });
    }

    // Export ZIP
    document.getElementById('exportZip').addEventListener('click', async function() {
      const zip = new JSZip();
      const mediaFolder = zip.folder('media');
      const data = [];

      for (const poi of pois) {
        if (poi.files.photo) await mediaFolder.file(poi.photo, poi.files.photo);
        if (poi.files.video) await mediaFolder.file(poi.video, poi.files.video);
        if (poi.files.audio) await mediaFolder.file(poi.audio, poi.files.audio);
        const {files, ...poiData} = poi;
        data.push(poiData);
      }

      zip.file('pois.json', JSON.stringify(data, null, 2));
      const content = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = 'circuit.zip';
      a.click();
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>