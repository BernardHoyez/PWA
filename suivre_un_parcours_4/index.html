<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivre un parcours</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        #import-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        #parcours-info {
            margin: 20px 0;
            display: none;
        }
        #points-list {
            margin: 20px 0;
        }
        .point-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .point-item:hover {
            background: #f8f9fa;
        }
        .point-item.active {
            background: #e9ecef;
            border-color: #007bff;
        }
        #map {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #point-details {
            margin: 20px 0;
            display: none;
        }
        #point-photo {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        #import-btn {
            background: #28a745;
            color: white;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Suivre un parcours</h1>

    <div id="import-section">
        <input type="file" id="import-input" accept=".zip" style="display: none;">
        <button id="import-btn" onclick="document.getElementById('import-input').click()">Importer un parcours</button>
        <div id="import-error" class="error-message" style="display: none;"></div>
    </div>

    <div id="parcours-info">
        <h2 id="parcours-title"></h2>
    </div>

    <div id="points-list"></div>

    <div id="point-details">
        <h3 id="detail-title"></h3>
        <img id="point-photo" alt="Photo du point">
        <p id="point-coords"></p>
        <p id="point-description"></p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let currentZip = null;
        let currentParcours = null;
        let activePointIndex = null;
        let photoUrls = []; // Pour stocker les URLs des photos et les libérer plus tard

        // Initialiser la carte
        function initMap() {
            map = L.map('map').setView([48.8566, 2.3522], 13); // Paris par défaut
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
        }

        // Charger le fichier ZIP
        document.getElementById('import-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const errorElement = document.getElementById('import-error');
            errorElement.style.display = 'none';

            try {
                // Réinitialiser l'état
                currentZip = await JSZip.loadAsync(file);
                const jsonContent = await currentZip.file("parcours.json").async("text");
                currentParcours = JSON.parse(jsonContent);

                // Afficher le titre du parcours
                document.getElementById('parcours-title').textContent = currentParcours.title || 'Mon parcours';
                document.getElementById('parcours-info').style.display = 'block';

                // Afficher la liste des points
                displayPointsList();

                // Initialiser et afficher la carte si ce n'est pas déjà fait
                if (!map) initMap();
                await displayPointsOnMap();

            } catch (error) {
                console.error("Erreur lors du chargement:", error);
                errorElement.textContent = "Erreur lors du chargement du parcours. Vérifiez que le fichier est valide.";
                errorElement.style.display = 'block';
            }
        });

        // Afficher la liste des points
        function displayPointsList() {
            const container = document.getElementById('points-list');
            container.innerHTML = '';

            if (!currentParcours?.points || currentParcours.points.length === 0) {
                container.innerHTML = '<p>Aucun point dans ce parcours.</p>';
                return;
            }

            container.innerHTML = currentParcours.points.map((point, index) => `
                <div class="point-item ${index === activePointIndex ? 'active' : ''}"
                     onclick="selectPoint(${index})">
                    <h3>${point.title || 'Point sans titre'}</h3>
                    <p>${point.coords || 'Coordonnées non disponibles'}</p>
                </div>
            `).join('');
        }

        // Sélectionner un point
        async function selectPoint(index) {
            activePointIndex = index;
            displayPointsList();

            if (!currentParcours?.points[index]) return;

            const point = currentParcours.points[index];
            document.getElementById('detail-title').textContent = point.title || 'Point sans titre';
            document.getElementById('point-coords').textContent = point.coords || 'Coordonnées non disponibles';
            document.getElementById('point-description').textContent = point.description || 'Aucune description';

            // Charger et afficher la photo
            try {
                const photoBlob = await currentZip.file(point.photo).async("blob");
                const photoUrl = URL.createObjectURL(photoBlob);
                document.getElementById('point-photo').src = photoUrl;

                // Stocker l'URL pour la libérer plus tard
                photoUrls.push(photoUrl);

                document.getElementById('point-details').style.display = 'block';
            } catch (error) {
                console.error("Erreur lors du chargement de la photo:", error);
                document.getElementById('point-photo').src = '';
            }

            // Centrer la carte sur ce point si des coordonnées sont disponibles
            if (point.coords && point.coords.includes('Lat:')) {
                const parts = point.coords.split(',');
                const lat = parseFloat(parts[0].replace('Lat:', '').trim());
                const lon = parseFloat(parts[1].replace('Lon:', '').trim());

                if (!isNaN(lat) && !isNaN(lon)) {
                    map.setView([lat, lon], 17);
                }
            }
        }

        // Afficher les points sur la carte
        async function displayPointsOnMap() {
            if (!currentParcours?.points || !currentZip) return;

            // Effacer les anciens marqueurs
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Libérer les URLs des photos précédentes
            photoUrls.forEach(url => URL.revokeObjectURL(url));
            photoUrls = [];

            for (let i = 0; i < currentParcours.points.length; i++) {
                const point = currentParcours.points[i];

                try {
                    // Lire les coordonnées depuis le fichier
                    const coordsContent = await currentZip.file(point.coords).async("text");
                    const [latPart, lonPart] = coordsContent.replace('Lat: ', '').replace('Lon: ', '').split(', ');
                    const lat = parseFloat(latPart);
                    const lon = parseFloat(lonPart);

                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${point.title || 'Point sans titre'}</b><br>Lat: ${lat}, Lon: ${lon}`)
                            .on('click', () => selectPoint(i));
                        markers.push(marker);
                    }
                } catch (error) {
                    console.error(`Erreur avec le point ${i}:`, error);
                }
            }
        }

        // Initialiser la carte au chargement
        window.onload = initMap;

        // Libérer les ressources quand on quitte la page
        window.addEventListener('beforeunload', () => {
            photoUrls.forEach(url => URL.revokeObjectURL(url));
        });
    </script>
</body>
</html>
