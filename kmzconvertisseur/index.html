<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMZ Convertisseur</title>
    <link rel="manifest" href="/PWA/kmzconvertisseur/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="/PWA/kmzconvertisseur/icon192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 16px;
            line-height: 1.5;
        }
        h1, h2, h3 { text-align: center; }
        .thumbnail {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #ddd;
        }
        .waypoint {
            border: 1px solid #ccc;
            padding: 12px;
            margin: 12px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #aaa;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            font-size: 1.1em;
            margin: 16px 0;
            background: #4a7c59;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background: #3a6447; }
        #loading {
            display: none;
            text-align: center;
            font-style: italic;
            color: #666;
            margin: 20px 0;
        }
        small { color: #555; }
    </style>
</head>
<body>

    <h1>KMZ Convertisseur<br><small>Optimisation traces + photos (OruxMaps)</small></h1>

    <input type="file" id="kmzInput" accept=".kmz">
    <button onclick="processKMZ()">Charger et traiter le KMZ</button>

    <div id="loading">Traitement en cours… (peut prendre quelques secondes selon le nombre de photos)</div>

    <div id="communeDiv" style="display:none; margin: 20px 0;">
        <label>Commune principale :
            <input id="commune" type="text" style="width: 240px;">
        </label>
    </div>

    <div id="waypoints"></div>

    <button onclick="generateNewKMZ()" style="display:none;" id="generateBtn">Générer le KMZ modifié</button>

    <script>
        let originalZip;
        let kmlDoc;
        let waypoints = [];
        let images = {};
        let communeInput = document.getElementById('commune');

        async function processKMZ() {
            const file = document.getElementById('kmzInput').files[0];
            if (!file) return alert('Veuillez sélectionner un fichier KMZ');

            document.getElementById('loading').style.display = 'block';

            try {
                const zip = await JSZip.loadAsync(file);
                originalZip = zip;

                const kmlFile = zip.file('doc.kml');
                if (!kmlFile) throw new Error('Fichier doc.kml non trouvé dans le KMZ');

                const kmlText = await kmlFile.async('text');
                kmlDoc = new DOMParser().parseFromString(kmlText, 'text/xml');

                // ───────────────────────────────────────────────
                // EXTRACTION CORRIGÉE pour OruxMaps (style #3 + table/img)
                waypoints = [];
                images = {};

                const placemarks = kmlDoc.getElementsByTagName('Placemark');

                for (let pm of placemarks) {
                    const styleUrl = pm.getElementsByTagName('styleUrl')[0];
                    if (!styleUrl || styleUrl.textContent.trim() !== '#3') continue;

                    const nameEl = pm.getElementsByTagName('name')[0];
                    const descEl = pm.getElementsByTagName('description')[0];
                    const coordEl = pm.getElementsByTagName('coordinates')[0];

                    if (!coordEl || !descEl) continue;

                    const name = (nameEl ? nameEl.textContent.trim() : '').slice(0, 20);

                    const descHTML = (descEl.innerHTML || descEl.textContent || '').trim();

                    const imgMatch = descHTML.match(/<img[^>]*src\s*=\s*["']?([^"'\s>]+)["']?/i);
                    if (!imgMatch) continue;

                    let imgSrc = imgMatch[1].trim();
                    imgSrc = imgSrc.replace(/^\.?\//, ''); // enlève ./ ou /

                    const imgFile = zip.file(imgSrc);
                    if (!imgFile) {
                        console.warn(`Image introuvable : ${imgSrc}`);
                        continue;
                    }

                    const imgBlob = await imgFile.async('blob');
                    images[imgSrc] = imgBlob;

                    const coordsText = coordEl.textContent.trim().split(/[\s,]+/).filter(Boolean);
                    if (coordsText.length < 2) continue;

                    const lon = parseFloat(coordsText[0]);
                    const lat = parseFloat(coordsText[1]);

                    if (isNaN(lon) || isNaN(lat)) continue;

                    waypoints.push({
                        placemark: pm,
                        originalName: name,
                        name: name,
                        comment: '',
                        imgSrc: imgSrc,
                        coords: { lon, lat }
                    });
                }

                if (waypoints.length === 0) {
                    alert(
                        "Aucun waypoint photo détecté.\n\n" +
                        "Vérifications :\n" +
                        "• Le KMZ contient-il le dossier 'files/' avec les OMIMG_*.jpg ?\n" +
                        "• Les photos sont-elles associées à des waypoints avec l'icône appareil photo ?\n" +
                        "Ouvre la console (F12) pour plus d'informations."
                    );
                    return;
                }

                // Détection commune (premier waypoint)
                const first = waypoints[0].coords;
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${first.lat}&lon=${first.lon}&zoom=14&addressdetails=1`);
                    const data = await resp.json();
                    const addr = data.address || {};
                    const detected = addr.village || addr.town || addr.city || addr.municipality || addr.hamlet || 'Non détectée';
                    communeInput.value = detected;
                } catch {
                    communeInput.value = 'Non détectée';
                }

                // Affichage
                const wpDiv = document.getElementById('waypoints');
                wpDiv.innerHTML = `<h3>${waypoints.length} waypoint(s) photo trouvé(s)</h3>`;

                waypoints.forEach((wp, i) => {
                    const div = document.createElement('div');
                    div.className = 'waypoint';
                    div.innerHTML = `
                        <img src="${URL.createObjectURL(images[wp.imgSrc])}" class="thumbnail" alt="photo">
                        <label>Nom du waypoint (max 20) :
                            <input type="text" value="${wp.name}" maxlength="20" data-index="${i}" class="wp-name">
                        </label>
                        <label>Commentaire (max 60) :
                            <input type="text" value="${wp.comment}" maxlength="60" data-index="${i}" class="wp-comment">
                        </label>
                    `;
                    wpDiv.appendChild(div);
                });

                document.querySelectorAll('.wp-name, .wp-comment').forEach(input => {
                    input.addEventListener('input', e => {
                        const idx = parseInt(e.target.dataset.index);
                        const field = e.target.classList.contains('wp-name') ? 'name' : 'comment';
                        waypoints[idx][field] = e.target.value;
                    });
                });

                document.getElementById('communeDiv').style.display = 'block';
                document.getElementById('generateBtn').style.display = 'inline-block';

                // Optimisation des images en arrière-plan
                for (let wp of waypoints) {
                    images[wp.imgSrc] = await optimizeImage(images[wp.imgSrc]);
                }

            } catch (err) {
                alert('Erreur lors du traitement : ' + err.message);
                console.error(err);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function optimizeImage(originalBlob) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1920;

                    if (w > max || h > max) {
                        if (w > h) { h = Math.round(h * max / w); w = max; }
                        else       { w = Math.round(w * max / h); h = max; }
                    }

                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);

                    canvas.toBlob(blob => resolve(blob || originalBlob), 'image/jpeg', 0.82);
                };
                img.src = URL.createObjectURL(originalBlob);
            });
        }

        async function generateNewKMZ() {
            if (!originalZip || !kmlDoc) return alert('Aucun KMZ chargé');

            const newZip = new JSZip();

            // Mise à jour noms + descriptions
            waypoints.forEach(wp => {
                const pm = wp.placemark;
                const nameEl = pm.getElementsByTagName('name')[0];
                if (nameEl) nameEl.textContent = wp.name;

                let descEl = pm.getElementsByTagName('description')[0];
                if (!descEl) {
                    descEl = kmlDoc.createElement('description');
                    pm.appendChild(descEl);
                }

                let current = descEl.innerHTML || '';
                if (wp.comment.trim()) {
                    current += (current ? '<br>' : '') + wp.comment.trim();
                }
                descEl.innerHTML = current;
            });

            const newKml = new XMLSerializer().serializeToString(kmlDoc);
            newZip.file('doc.kml', newKml);

            // Images optimisées
            for (const [path, blob] of Object.entries(images)) {
                newZip.file(path, blob);
            }

            // Autres fichiers du KMZ original
            for (const filename in originalZip.files) {
                if (filename !== 'doc.kml' && !images[filename]) {
                    newZip.file(filename, await originalZip.file(filename).async('blob'));
                }
            }

            const blob = await newZip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trace_modifiee.kmz';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Service Worker (scope adapté au sous-dossier GitHub Pages)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/PWA/kmzconvertisseur/sw.js', { scope: '/PWA/kmzconvertisseur/' })
                    .then(() => console.log('Service Worker enregistré'))
                    .catch(err => console.warn('Échec SW', err));
            });
        }
    </script>
</body>
</html>
