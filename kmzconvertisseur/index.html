<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMZ Convertisseur → Web</title>
    <link rel="manifest" href="/PWA/kmzconvertisseur/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="/PWA/kmzconvertisseur/icon192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 920px; margin: 0 auto; padding: 16px; line-height: 1.5; }
        h1, h3 { text-align: center; }
        .thumbnail { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; margin: 8px 0; border: 1px solid #ddd; }
        .waypoint { border: 1px solid #ccc; padding: 12px; margin: 12px 0; border-radius: 8px; background: #f9f9f9; }
        label { display: block; margin: 8px 0 4px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #aaa; border-radius: 4px; }
        button { padding: 12px 24px; font-size: 1.1em; margin: 12px 8px 12px 0; background: #4a7c59; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #3a6447; }
        #instructions { background: #fff3cd; padding: 16px; border-radius: 8px; margin: 16px 0; border: 1px solid #ffeeba; }
        #loading { display: none; text-align: center; font-style: italic; color: #666; margin: 20px 0; padding: 12px; background: #e8f5e8; border-radius: 6px; }
    </style>
</head>
<body>

    <h1>KMZ Convertisseur → Version Web<br><small>Optimise photos + prépare KML léger pour GitHub Pages</small></h1>

    <input type="file" id="kmzInput" accept=".kmz">
    <button onclick="processKMZ()">1. Charger et traiter le KMZ</button>

    <div id="loading">Traitement en cours…</div>

    <div id="communeDiv" style="display:none; margin: 20px 0;">
        <label>Commune principale : <input id="commune" type="text" style="width: 240px;"></label>
    </div>

    <div id="githubFolderDiv" style="display:none; margin: 20px 0;">
        <label><strong>Nom du dossier GitHub</strong> (ex: Bras2026-02-11) :<br>
            <input id="githubFolder" type="text" placeholder="BrasXXXXXX" style="width: 300px; font-weight:bold;">
        </label>
        <p style="font-size:0.9em; color:#555;">Ce nom sera utilisé pour construire les liens directs vers les photos.</p>
    </div>

    <div id="waypoints"></div>

    <div style="margin: 24px 0;">
        <button onclick="generateKMZ()" id="btnKMZ" style="display:none; background:#556b2f;">Télécharger KMZ modifié (local)</button>
        <button onclick="generateWebKML()" id="btnWeb" style="display:none; background:#8b4513;">Générer KML léger (pour GitHub)</button>
    </div>

    <div id="instructions" style="display:none;">
        <h3>Étapes suivantes après génération du KML :</h3>
        <ol>
            <li>Décompressez le KMZ que vous venez de télécharger</li>
            <li>Dans votre dépôt GitHub <strong>bernardhoyez/PWA</strong>, créez le dossier :<br><code>kmz-photos/<strong id="exampleFolder">BrasXXXXXX</strong></code></li>
            <li>À l'intérieur, uploadez :
                <ul>
                    <li>le fichier <code>doc.kml</code> (ou renommez-le trace.kml)</li>
                    <li>le dossier <code>files/</code> entier avec les photos optimisées</li>
                </ul>
            </li>
            <li>Utilisez le KML téléchargé pour Google Earth / My Maps</li>
        </ol>
        <p>Les photos seront accessibles via des liens directs comme :<br>
            <code>https://raw.githubusercontent.com/bernardhoyez/PWA/main/kmz-photos/BrasXXXXXX/files/OMIMG_....jpg</code>
        </p>
    </div>

    <script>
        let originalZip;
        let kmlDoc;
        let waypoints = [];
        let images = {};
        let githubFolder = '';

        async function processKMZ() {
            const file = document.getElementById('kmzInput').files[0];
            if (!file) return alert('Sélectionnez un KMZ');

            document.getElementById('loading').style.display = 'block';

            try {
                const zip = await JSZip.loadAsync(file);
                originalZip = zip;

                const kmlFile = zip.file('doc.kml');
                if (!kmlFile) throw new Error('Pas de doc.kml');

                const kmlText = await kmlFile.async('text');
                kmlDoc = new DOMParser().parseFromString(kmlText, 'text/xml');

                waypoints = [];
                images = {};

                const placemarks = kmlDoc.getElementsByTagName('Placemark');
                for (let pm of placemarks) {
                    const styleUrl = pm.getElementsByTagName('styleUrl')[0];
                    if (!styleUrl || styleUrl.textContent.trim() !== '#3') continue;

                    const nameEl = pm.getElementsByTagName('name')[0];
                    const descEl = pm.getElementsByTagName('description')[0];
                    const coordEl = pm.getElementsByTagName('coordinates')[0];

                    if (!coordEl || !descEl) continue;

                    const name = (nameEl ? nameEl.textContent.trim() : '').slice(0, 20);
                    const descHTML = (descEl.innerHTML || descEl.textContent || '').trim();

                    const imgMatch = descHTML.match(/<img[^>]*src\s*=\s*["']?([^"'\s>]+)["']?/i);
                    if (!imgMatch) continue;

                    let imgSrc = imgMatch[1].trim().replace(/^\.?\//, '');
                    const imgFile = zip.file(imgSrc);
                    if (!imgFile) continue;

                    const imgBlob = await imgFile.async('blob');
                    images[imgSrc] = imgBlob;

                    const coordsText = coordEl.textContent.trim().split(/[\s,]+/).filter(Boolean);
                    if (coordsText.length < 2) continue;

                    const lon = parseFloat(coordsText[0]);
                    const lat = parseFloat(coordsText[1]);

                    if (isNaN(lon) || isNaN(lat)) continue;

                    waypoints.push({
                        placemark: pm,
                        originalName: name,
                        name: name,
                        comment: '',
                        imgSrc: imgSrc,
                        coords: { lon, lat }
                    });
                }

                if (waypoints.length === 0) throw new Error('Aucun waypoint photo détecté');

                // Détection commune
                const first = waypoints[0].coords;
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${first.lat}&lon=${first.lon}&zoom=14`);
                    const data = await resp.json();
                    document.getElementById('commune').value = data.address?.village || data.address?.town || data.address?.city || 'Non détectée';
                } catch {
                    document.getElementById('commune').value = 'Non détectée';
                }

                // Affichage waypoints
                const wpDiv = document.getElementById('waypoints');
                wpDiv.innerHTML = `<h3>${waypoints.length} waypoint(s) photo trouvé(s)</h3>`;

                waypoints.forEach((wp, i) => {
                    const div = document.createElement('div');
                    div.className = 'waypoint';
                    div.innerHTML = `
                        <img src="${URL.createObjectURL(images[wp.imgSrc])}" class="thumbnail">
                        <label>Nom (max 20) : <input type="text" value="${wp.name}" maxlength="20" data-index="${i}" class="wp-name"></label>
                        <label>Commentaire (max 60) : <input type="text" value="${wp.comment}" maxlength="60" data-index="${i}" class="wp-comment"></label>
                    `;
                    wpDiv.appendChild(div);
                });

                document.querySelectorAll('.wp-name, .wp-comment').forEach(inp => {
                    inp.addEventListener('input', e => {
                        const idx = e.target.dataset.index;
                        const field = e.target.classList.contains('wp-name') ? 'name' : 'comment';
                        waypoints[idx][field] = e.target.value;
                    });
                });

                document.getElementById('communeDiv').style.display = 'block';
                document.getElementById('githubFolderDiv').style.display = 'block';
                document.getElementById('btnKMZ').style.display = 'inline-block';
                document.getElementById('btnWeb').style.display = 'inline-block';

                // Optimisation images
                for (let wp of waypoints) {
                    images[wp.imgSrc] = await optimizeImage(images[wp.imgSrc]);
                }

            } catch (err) {
                alert('Erreur : ' + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function optimizeImage(blob) {
            return new Promise(r => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > 1920 || h > 1920) {
                        if (w > h) { h = Math.round(1920 * h / w); w = 1920; }
                        else { w = Math.round(1920 * w / h); h = 1920; }
                    }
                    c.width = w; c.height = h;
                    c.getContext('2d').drawImage(img, 0, 0, w, h);
                    c.toBlob(b => r(b || blob), 'image/jpeg', 0.82);
                };
                img.src = URL.createObjectURL(blob);
            });
        }

        async function generateKMZ() {
            // Même code que précédemment pour KMZ local (avec CDATA, copie fichiers sauf dossiers)
            // ... (je ne le répète pas ici pour ne pas alourdir – garde ta version qui fonctionne)
            alert("Fonction KMZ local conservée – utilise ton code précédent pour cette partie.");
        }

        function generateWebKML() {
            githubFolder = document.getElementById('githubFolder').value.trim();
            if (!githubFolder) {
                alert("Veuillez entrer le nom du dossier GitHub (ex: Bras2026-02-11)");
                return;
            }

            const baseUrl = `https://raw.githubusercontent.com/bernardhoyez/PWA/main/kmz-photos/${githubFolder}/files/`;

            // Créer un nouveau document KML simple
            const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>Trace ${githubFolder}</name>
    <description>Trace optimisée - Photos sur GitHub</description>

    <!-- Copie du track original si présent -->
    ${getOriginalTrack()}

    <!-- Waypoints photo -->
    ${waypoints.map(wp => `
    <Placemark>
        <name>${wp.name || wp.originalName || 'Photo'}</name>
        <description><![CDATA[
            ${wp.comment ? `<p>${wp.comment.replace(/\n/g, '<br>')}</p>` : ''}
            <p><img src="${baseUrl}${wp.imgSrc}" width="400" alt="Photo"></p>
            <p><a href="${baseUrl}${wp.imgSrc}" target="_blank" rel="noopener">Agrandir l'image →</a></p>
        ]]></description>
        <styleUrl>#photoStyle</styleUrl>
        <Point>
            <coordinates>${wp.coords.lon},${wp.coords.lat},0</coordinates>
        </Point>
    </Placemark>
    `).join('\n')}

    <!-- Style simple pour les photos -->
    <Style id="photoStyle">
        <IconStyle>
            <Icon><href>https://www.oruxmaps.com/iconos/wpts_foto.png</href></Icon>
        </IconStyle>
    </Style>
</Document>
</kml>`;

            const blob = new Blob([kml], {type: 'application/xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trace_${githubFolder}.kml`;
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('exampleFolder').textContent = githubFolder;
            document.getElementById('instructions').style.display = 'block';
        }

        function getOriginalTrack() {
            // Optionnel : extraire et copier le <gx:Track> ou <LineString> original
            // Pour simplifier ici, on peut le laisser vide ou copier tel quel si trouvé
            const trackPlacemarks = Array.from(kmlDoc.getElementsByTagName('Placemark'))
                .filter(pm => pm.getElementsByTagName('gx:Track')[0] || pm.getElementsByTagName('LineString')[0]);

            if (trackPlacemarks.length === 0) return '<!-- Pas de trace trouvée -->';

            return Array.from(trackPlacemarks)
                .map(pm => new XMLSerializer().serializeToString(pm))
                .join('\n');
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/PWA/kmzconvertisseur/sw.js', { scope: '/PWA/kmzconvertisseur/' });
        }
    </script>
</body>
</html>
