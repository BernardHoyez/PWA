<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>editchat</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/favicon.ico">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    #map { height:300px; margin:10px 0; }
    #poiList { padding:10px; background:#eee; }
    #editor { padding:10px; }
    .poi { padding:4px; border-bottom:1px solid #ccc; cursor:pointer; }
    label { display:block; margin-top:6px; }
    input, textarea { width:100%; }
    button { margin-top:10px; padding:6px 12px; }
    button.secondary { background:#c33; color:#fff; border:none; }
  </style>

  <!-- EXIF & JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader@5.0.3/dist/exif-reader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h1>editchat – Éditeur de visite</h1>

<div style="padding:10px;">
  <label>Nom de la visite : <input id="visitName"></label>
  <button id="addPoi">Ajouter un POI</button>
  <button id="downloadZip">Télécharger Zip</button>
</div>

<div id="poiList"></div>
<div id="map"></div>
<div id="editor">Sélectionnez un POI</div>

<script>
const pois = [];
let activeIndex = null;

// --- Carte Leaflet ---
const map = L.map('map').setView([48.85, 2.35], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: '© OpenStreetMap' }).addTo(map);
map.on('click', e => {
  if (activeIndex === null) return;
  pois[activeIndex].location =
      `${e.latlng.lat.toFixed(5)}N, ${e.latlng.lng.toFixed(5)}E`;
  updateEditor();
});

// --- Helpers ---
function dmsToDecimal(dms, ref) {
  const toNum = x => (x.numerator ? x.numerator / x.denominator : x);
  const [d, m, s] = dms.map(toNum);
  let dec = d + m / 60 + s / 3600;
  if (ref === 'S' || ref === 'W') dec = -dec;
  return dec;
}

// --- Liste des POI ---
function renderList() {
  const list = document.getElementById('poiList');
  list.innerHTML = '';
  pois.forEach((p, i) => {
    const d = document.createElement('div');
    d.className = 'poi';
    d.textContent = (i + 1) + '. ' + (p.title || 'Sans titre');
    d.onclick = () => { activeIndex = i; updateEditor(); };
    list.appendChild(d);
  });
}

// --- Éditeur avec prévisualisation ---
function updateEditor() {
  const editor = document.getElementById('editor');
  if (activeIndex === null) { editor.textContent = 'Sélectionnez un POI'; return; }

  const p = pois[activeIndex];
  const imgURL = p.img ? URL.createObjectURL(p.img) : '';
  const vidURL = p.vid ? URL.createObjectURL(p.vid) : '';
  cons
