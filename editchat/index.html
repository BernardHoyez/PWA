<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editchat – Éditeur de visite</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body{font-family:sans-serif;margin:0;}
header{background:#3f51b5;color:#fff;text-align:center;padding:1rem;}
#map{height:300px;margin:1rem;}
h2{margin:1rem 1rem 0.5rem;}
#poiTitles{list-style:none;padding:0 1rem;margin:0;}
#poiTitles li{padding:6px 8px;margin-bottom:4px;border:1px solid #ccc;border-radius:4px;background:#f2f2f2;cursor:grab;}
#poiList{display:flex;flex-direction:column;gap:.5rem;padding:1rem;}
.poi-card{border:1px solid #ccc;border-radius:8px;padding:.5rem;background:#fafafa;}
.poi-card input,.poi-card textarea{width:100%;margin-bottom:.3rem;}
.preview{max-width:100%;max-height:150px;display:block;margin-top:.3rem;}
.del-poi{background:#c62828;color:white;border:none;padding:.4rem .6rem;border-radius:4px;cursor:pointer;}
.add-poi{margin:1rem;}
</style>
</head>
<body>
<header><h1>Editchat</h1></header>

<div id="map"></div>

<h2>Ordre des POI</h2>
<ul id="poiTitles"></ul>

<button id="addPoiBtn" class="add-poi">Ajouter un POI</button>
<div id="poiList"></div>
<button id="downloadZip">Télécharger la visite (ZIP)</button>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exifreader@5.0.3/dist/exif-reader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
let pois = [];
const map = L.map('map').setView([48.85, 2.35], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {attribution:'&copy; OpenStreetMap'}).addTo(map);

document.getElementById('addPoiBtn').addEventListener('click', addPOI);
document.getElementById('downloadZip').addEventListener('click', downloadZip);

function addPOI(){
  const id = Date.now();
  pois.push({id,title:'',location:'',comment:'',image:null,video:null,audio:null,marker:null});
  renderPOIs();
}

function renderPOIs(){
  const list = document.getElementById('poiList');
  list.innerHTML = '';
  pois.forEach(poi=>{
    const card = document.createElement('div');
    card.className='poi-card';
    card.dataset.id=poi.id;
    card.innerHTML=`
      <input data-id="${poi.id}" data-field="title" placeholder="Titre" value="${poi.title}">
      <input data-id="${poi.id}" data-field="location" placeholder="Localisation" value="${poi.location}">
      <textarea data-id="${poi.id}" data-field="comment" placeholder="Commentaire">${poi.comment}</textarea>
      <label>Image JPEG <input type="file" accept="image/jpeg" data-id="${poi.id}" data-field="image"></label>
      <img id="imgPreview-${poi.id}" class="preview" ${poi.image?`src="${poi.image}"`:'style="display:none;"'}>
      <label>Vidéo MP4 <input type="file" accept="video/mp4" data-id="${poi.id}" data-field="video"></label>
      <video id="vidPreview-${poi.id}" class="preview" controls ${poi.video?`src="${poi.video}"`:'style="display:none;"'}></video>
      <label>Audio MP3 <input type="file" accept="audio/mp3" data-id="${poi.id}" data-field="audio"></label>
      <audio id="audPreview-${poi.id}" class="preview" controls ${poi.audio?`src="${poi.audio}"`:'style="display:none;"'}></audio>
      <button class="del-poi" data-id="${poi.id}">Supprimer</button>
    `;
    list.appendChild(card);
  });
  attachInputs();
  renderTitleList();
}

function renderTitleList(){
  const ul = document.getElementById('poiTitles');
  ul.innerHTML = '';
  pois.forEach(p=>{
    const li = document.createElement('li');
    li.className='poi-title-item';
    li.dataset.id=p.id;
    li.textContent = p.title || '(Sans titre)';
    ul.appendChild(li);
  });
  if (!window.titleSortable){
    window.titleSortable = Sortable.create(ul,{
      animation:150,
      onEnd:()=>{
        const order=[...ul.querySelectorAll('li')].map(li=>+li.dataset.id);
        pois.sort((a,b)=>order.indexOf(a.id)-order.indexOf(b.id));
        renderPOIs();
      }
    });
  }
}

function attachInputs(){
  document.querySelectorAll('#poiList input, #poiList textarea').forEach(el=>{
    el.onchange = e => handleInput(e);
  });
  document.querySelectorAll('.del-poi').forEach(btn=>{
    btn.onclick = e=>{
      const id=+e.target.dataset.id;
      const idx=pois.findIndex(p=>p.id===id);
      if(idx>-1){
        if(pois[idx].marker) map.removeLayer(pois[idx].marker);
        pois.splice(idx,1);
        renderPOIs();
      }
    };
  });
}

function handleInput(e){
  const id=+e.target.dataset.id;
  const field=e.target.dataset.field;
  const poi=pois.find(p=>p.id===id);
  if(!poi) return;

  if(['title','location','comment'].includes(field)){
    poi[field]=e.target.value;
    if(field==='title') renderTitleList();
  } else {
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=evt=>{
      poi[field]=evt.target.result;
      const previewId=(field==='image'?'imgPreview-':field==='video'?'vidPreview-':'audPreview-')+poi.id;
      const preview=document.getElementById(previewId);
      preview.src=evt.target.result;
      preview.style.display='block';
      if(field==='audio') preview.load();
      if(field==='image'){
        try{
          const tags=ExifReader.load(file);
          if(tags.GPSLatitude && tags.GPSLongitude){
            const lat=toDec(tags.GPSLatitude,tags.GPSLatitudeRef?.value[0]);
            const lon=toDec(tags.GPSLongitude,tags.GPSLongitudeRef?.value[0]);
            poi.location=`${lat.toFixed(5)}N, ${lon.toFixed(5)}E`;
            document.querySelector(`input[data-id="${poi.id}"][data-field="location"]`).value=poi.location;
            setMarkerForPoi(poi,lat,lon);
          }
        }catch(err){console.log('Pas de données EXIF');}
      }
    };
    reader.readAsDataURL(file);
  }
}

function toDec(arr,ref){
  const [d,m,s]=arr.map(v=>v.valueOf());
  let dec=d+m/60+s/3600;
  if(ref==='S'||ref==='W') dec=-dec;
  return dec;
}

map.on('click',e=>{
  if(!pois.length) return;
  const poi=pois[pois.length-1];
  setMarkerForPoi(poi,e.latlng.lat,e.latlng.lng);
  poi.location=`${e.latlng.lat.toFixed(5)}N, ${e.latlng.lng.toFixed(5)}E`;
  document.querySelector(`input[data-id="${poi.id}"][data-field="location"]`).value=poi.location;
});

function setMarkerForPoi(poi,lat,lon){
  if(poi.marker) map.removeLayer(poi.marker);
  poi.marker=L.marker([lat,lon],{draggable:true}).addTo(map);
  poi.marker.on('dragend',ev=>{
    const {lat,lng}=ev.target.getLatLng();
    poi.location=`${lat.toFixed(5)}N, ${lng.toFixed(5)}E`;
    document.querySelector(`input[data-id="${poi.id}"][data-field="location"]`).value=poi.location;
  });
}

function downloadZip(){
  const zip=new JSZip();
  const dataFolder=zip.folder("data");
  pois.forEach((poi,i)=>{
    const folder=dataFolder.folder(`${i+1}`);
    folder.file("Titre.txt",poi.title||'');
    folder.file("Localisation.txt",poi.location||'');
    folder.file("Commentaire.txt",poi.comment||'');
    if(poi.image) folder.file("Image.jpg",poi.image.split(',')[1],{base64:true});
    if(poi.video) folder.file("Video.mp4",poi.video.split(',')[1],{base64:true});
    if(poi.audio) folder.file("Audio.mp3",poi.audio.split(',')[1],{base64:true});
  });
  zip.file("visit.json",JSON.stringify({visitName:"Visite",poiCount:pois.length},null,2));
  zip.generateAsync({type:"blob"}).then(content=>saveAs(content,"visite.zip"));
}
</script>
</body>
</html>
