<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>editchat</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/favicon.ico">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  body { font-family:sans-serif; margin:0; padding:0; }
  #map { height:300px; margin:10px 0; }
  #poiList { padding:10px; background:#eee; }
  #editor { padding:10px; }
  .poi { padding:4px; border-bottom:1px solid #ccc; cursor:pointer; }
  label { display:block; margin-top:6px; }
  input, textarea { width:100%; }
  button { margin-top:10px; padding:6px 12px; }
  button.secondary { background:#c33; color:#fff; border:none; }
</style>

<script src="https://cdn.jsdelivr.net/npm/exifreader@5.0.3/dist/exif-reader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h1>editchat – Éditeur de visite</h1>

<div style="padding:10px;">
  <label>Nom de la visite : <input id="visitName"></label>
  <button id="addPoi">Ajouter un POI</button>
  <button id="downloadZip">Télécharger Zip</button>
</div>

<div id="poiList"></div>
<div id="map"></div>
<div id="editor">Sélectionnez un POI</div>

<script>
const pois = [];
let activeIndex = null;

// --- Carte Leaflet ---
const map = L.map('map').setView([48.85, 2.35], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: '© OpenStreetMap' }).addTo(map);

// 2) Mise à jour par clic sur la carte
map.on('click', e => {
  if (activeIndex === null) return;
  pois[activeIndex].location =
    `${e.latlng.lat.toFixed(5)}N, ${e.latlng.lng.toFixed(5)}E`;
  updateEditor();
});

// --- Utilitaires ---
function dmsToDecimal(dms, ref) {
  const toNum = x => (x.numerator ? x.numerator / x.denominator : x);
  const [d, m, s] = dms.map(toNum);
  let dec = d + m/60 + s/3600;
  if (ref === 'S' || ref === 'W') dec = -dec;
  return dec;
}

function renderList() {
  const list = document.getElementById('poiList');
  list.innerHTML = '';
  pois.forEach((p, i) => {
    const d = document.createElement('div');
    d.className = 'poi';
    d.textContent = (i + 1) + '. ' + (p.title || 'Sans titre');
    d.onclick = () => { activeIndex = i; updateEditor(); };
    list.appendChild(d);
  });
}

// --- Éditeur complet ---
function updateEditor() {
  const editor = document.getElementById('editor');
  if (activeIndex === null) { editor.textContent = 'Sélectionnez un POI'; return; }

  const p = pois[activeIndex];
  const imgURL = p.img ? URL.createObjectURL(p.img) : '';
  const vidURL = p.vid ? URL.createObjectURL(p.vid) : '';
  const audURL = p.aud ? URL.createObjectURL(p.aud) : '';

  editor.innerHTML = `
    <label>Titre<input id="poiTitle" value="${p.title||''}"></label>
    <label>Localisation<input id="poiLoc" value="${p.location||''}" placeholder="ex: 49.55640N, 0.08857E"></label>
    <label>Commentaire<textarea id="poiCom">${p.comment||''}</textarea></label>

    <label>Image JPEG<input type="file" id="poiImg" accept="image/jpeg"></label>
    ${imgURL ? `<img src="${imgURL}" style="max-width:100%;margin-top:4px;border:1px solid #ccc">` : ''}

    <label>Vidéo MP4<input type="file" id="poiVid" accept="video/mp4"></label>
    ${vidURL ? `<video controls style="max-width:100%;margin-top:4px"><source src="${vidURL}" type="video/mp4"></video>` : ''}

    <label>Audio MP3<input type="file" id="poiAud" accept="audio/mpeg"></label>
    ${audURL ? `<audio controls style="width:100%;margin-top:4px"><source src="${audURL}" type="audio/mpeg"></audio>` : ''}

    <button id="delPoi" class="secondary">Supprimer ce POI</button>
  `;

  // 3) Modification manuelle : on relie l'input au POI
  document.getElementById('poiTitle').oninput = e => p.title = e.target.value;
  document.getElementById('poiLoc').oninput  = e => p.location = e.target.value;
  document.getElementById('poiCom').oninput  = e => p.comment = e.target.value;

  document.getElementById('delPoi').onclick = () => {
    pois.splice(activeIndex, 1);
    activeIndex = null;
    renderList(); updateEditor();
  };

  // 1) Extraction automatique EXIF si image choisie
  document.getElementById('poiImg').onchange = async e => {
    const f = e.target.files[0];
    if (!f) return;
    p.img = f;

    try {
      const tags = await ExifReader.load(await f.arrayBuffer());
      if (tags.GPSLatitude && tags.GPSLongitude) {
        const lat = dmsToDecimal(tags.GPSLatitude.description, tags.GPSLatitudeRef?.description || 'N');
        const lon = dmsToDecimal(tags.GPSLongitude.description, tags.GPSLongitudeRef?.description || 'E');
        p.location = `${lat.toFixed(5)}N, ${lon.toFixed(5)}E`;
      }
    } catch(err) {
      console.warn('Pas de données EXIF GPS', err);
    }
    updateEditor(); // re-render pour afficher image + coordonnées
  };

  document.getElementById('poiVid').onchange = e => {
    const f = e.target.files[0];
    if (f) { p.vid = f; updateEditor(); }
  };
  document.getElementById('poiAud').onchange = e => {
    const f = e.target.files[0];
    if (f) { p.aud = f; updateEditor(); }
  };
}

// --- Boutons principaux ---
document.getElementById('addPoi').onclick = () => {
  pois.push({ title: '' });
  activeIndex = pois.length - 1;
  renderList(); updateEditor();
};

document.getElementById('downloadZip').onclick = async () => {
  const visitName = document.getElementById('visitName').value.trim();
  if (!visitName) { alert('Nom de visite manquant'); return; }

  const zip = new JSZip();
  const data = zip.folder('data');
  const structure = [];

  for (let i = 0; i < pois.length; i++) {
    const p = pois[i];
    if (!p.title || !p.location) { alert(`POI ${i + 1} incomplet`); return; }
    const pf = data.folder(String(i + 1));
    pf.file('Titre.txt', p.title);
    pf.file('Localisation.txt', p.location);
    pf.file('Commentaire.txt', p.comment || '');
    if (p.img) pf.file('Image.jpg', p.img);
    if (p.vid) pf.file('Video.mp4', p.vid);
    if (p.aud) pf.file('Audio.mp3', p.aud);
    structure.push({ id: i + 1, title: p.title, location: p.location });
  }

  zip.file('visit.json', JSON.stringify({ name: visitName, pois: structure }, null, 2));
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = visitName + '.zip';
  a.click();
};

// --- Service Worker ---
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
