<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visite de Site</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; }
        #map { height: 300px; width: 100%; margin-bottom: 20px; }
        .controls { display: flex; justify-content: space-around; margin-top: 20px; }
        .info-box { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .media-container img, .media-container video { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(
                    registration => { console.log('SW enregistré:', registration); },
                    err => { console.log('SW échec:', err); }
                );
            });
        }
    </script>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            const [tour, setTour] = useState(null);
            const [currentPointIndex, setCurrentPointIndex] = useState(0);
            const [userLocation, setUserLocation] = useState(null);
            const mapRef = useRef(null);
            const markersRef = useRef([]);

            useEffect(() => {
                if (tour && !mapRef.current) {
                    const firstPoint = tour.points[0];
                    if (firstPoint.lat && firstPoint.lng) {
                        mapRef.current = L.map('map').setView([firstPoint.lat, firstPoint.lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(mapRef.current);
                        displayPointsOnMap(tour.points);
                    }
                }
            }, [tour]);
            
            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition((position) => {
                        setUserLocation({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    }, (error) => {
                        console.error("Erreur de géolocalisation: ", error);
                    });
                }
            }, []);

            const displayPointsOnMap = (points) => {
                markersRef.current.forEach(marker => mapRef.current.removeLayer(marker));
                markersRef.current = points.map(p => {
                    if (p.lat && p.lng) {
                       const marker = L.marker([p.lat, p.lng]).addTo(mapRef.current);
                       return marker;
                    }
                    return null;
                }).filter(m => m);
            };

            const handleFileImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const zip = new JSZip();
                try {
                    const content = await zip.loadAsync(file);
                    const dataFile = content.file('data.json');
                    if (dataFile) {
                        const data = await dataFile.async('string');
                        const parsedData = JSON.parse(data);
                        const tourData = {
                            ...parsedData,
                            points: await Promise.all(parsedData.points.map(async p => {
                                if (p.mediaFileName) {
                                    const mediaBlob = await content.file(`medias/${p.mediaFileName}`).async('blob');
                                    p.mediaUrl = URL.createObjectURL(mediaBlob);
                                }
                                if (p.audioFileName) {
                                    const audioBlob = await content.file(`medias/${p.audioFileName}`).async('blob');
                                    p.audioUrl = URL.createObjectURL(audioBlob);
                                }
                                return p;
                            }))
                        };
                        setTour(tourData);
                    }
                } catch (error) {
                    alert("Erreur lors de l'importation du fichier Zip.");
                    console.error(error);
                }
            };

            const handleNavigate = (direction) => {
                const newIndex = currentPointIndex + direction;
                if (newIndex >= 0 && newIndex < tour.points.length) {
                    setCurrentPointIndex(newIndex);
                    const newPoint = tour.points[newIndex];
                    if (newPoint.lat && newPoint.lng) {
                        mapRef.current.setView([newPoint.lat, newPoint.lng], 13);
                    }
                } else if (newIndex >= tour.points.length) {
                    alert("Vous avez atteint le dernier point de la visite.");
                } else {
                    alert("Vous êtes déjà au premier point.");
                }
            };

            const calculateDistance = () => {
                if (!userLocation || !tour) return "N/A";
                const currentPoint = tour.points[currentPointIndex];
                if (!currentPoint.lat || !currentPoint.lng) return "Coordonnées du point non disponibles.";
                const from = turf.point([userLocation.lng, userLocation.lat]);
                const to = turf.point([currentPoint.lng, currentPoint.lat]);
                const distance = turf.distance(from, to, { units: 'meters' });
                return `${distance.toFixed(2)} m`;
            };

            const calculateAzimuth = () => {
                if (!userLocation || !tour) return "N/A";
                const currentPoint = tour.points[currentPointIndex];
                if (!currentPoint.lat || !currentPoint.lng) return "Coordonnées du point non disponibles.";
                const from = turf.point([userLocation.lng, userLocation.lat]);
                const to = turf.point([currentPoint.lng, currentPoint.lat]);
                const bearing = turf.bearing(from, to);
                return `Nord ${bearing.toFixed(0)}°`;
            };

            if (!tour) {
                return (
                    <div>
                        <h1>Visite de Sites - Bienvenue Mary</h1>
                        <label>Importer le projet Zip: <input type="file" onChange={handleFileImport} accept=".zip" /></label>
                    </div>
                );
            }

            const currentPoint = tour.points[currentPointIndex];
            if (!currentPoint) {
                 return <div>Aucun point trouvé pour cette visite.</div>;
            }

            return (
                <div>
                    <h1>{tour.siteTitle}</h1>
                    <div id="map"></div>
                    <div className="info-box">
                        <h2>{currentPoint.title}</h2>
                        <div className="media-container">
                            {currentPoint.mediaUrl && (currentPoint.mediaUrl.includes('image') ?
                                <img src={currentPoint.mediaUrl} alt={currentPoint.title} /> :
                                <video src={currentPoint.mediaUrl} controls />
                            )}
                        </div>
                        <p>{currentPoint.text}</p>
                        {currentPoint.audioUrl && <audio src={currentPoint.audioUrl} controls />}
                    </div>

                    <div className="info-box">
                        <p>Votre position: Lat: {userLocation?.lat?.toFixed(6) || 'N/A'}, Lng: {userLocation?.lng?.toFixed(6) || 'N/A'}</p>
                        <p>Distance au point: {calculateDistance()}</p>
                        <p>Azimut vers le point: {calculateAzimuth()}</p>
                    </div>

                    <div className="controls">
                        <button onClick={() => handleNavigate(-1)}>Précédent</button>
                        <button onClick={() => handleNavigate(1)}>Suivant</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>