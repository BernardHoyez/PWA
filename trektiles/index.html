<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrekTiles – Générateur PMTiles offline</title>
    <meta name="description" content="Créer des cartes hors-ligne PMTiles (OSM ou IGN) pour randonnée, trekking, GPS">
    <meta name="theme-color" content="#2563eb">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon512.png">
    <link rel="apple-touch-icon" href="icon192.png">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- PMTiles.js v3 -->
    <script src="https://cdn.jsdelivr.net/npm/pmtiles@3.2.0/dist/index.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; padding:15px; }
        .container { max-width:1200px; margin:0 auto; background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }
        .header { background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%); color:#fff; padding:30px; text-align:center; }
        .header h1 { font-size:2.5em; margin-bottom:8px; }
        .content { padding:30px; }
        .section { margin-bottom:30px; padding:25px; background:#f8fafc; border-radius:15px; border:2px solid #e2e8f0; }
        .section h2 { color:#2563eb; margin-bottom:20px; font-size:1.5em; display:flex; align-items:center; gap:10px; }
        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        input, select { width:100%; padding:12px 15px; border:2px solid #e2e8f0; border-radius:10px; font-size:1em; background:#fff; }
        input:focus, select:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        .btn { padding:12px 25px; border:none; border-radius:10px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition:all .3s; }
        .btn-primary { background:linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; box-shadow:0 4px 15px rgba(37,99,235,0.3); }
        .btn-primary:hover { transform:translateY(-2px); }
        .btn-success { background:#10b981; color:#fff; }
        #map { width:100%; height:420px; border-radius:15px; margin-top:20px; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
        .slider-value { background:#2563eb; color:#fff; padding:5px 15px; border-radius20px; font-weight:600; margin-left:10px; }
        .progress-container { display:none; margin-top:25px; padding:20px; background:#fff; border-radius:12px; border:2px solid #2563eb; }
        .progress-bar { height:32px; background:#e2e8f0; border-radius:16px; overflow:hidden; margin-bottom:12px; }
        .progress-fill { height:100%; width:0%; background:linear-gradient(90deg,#2563eb,#3b82f6); transition:width .4s; color:#fff; font-weight:600; display:flex; align-items:center; justify-content:center; }
        .folder-section { background:#fef3c7; border:2px solid #f59e0b; padding:20px; border-radius:15px; margin:25px 0; }
        @media (max-width:768px) { .input-row { grid-template-columns:1fr; } #map { height:300px; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>TrekTiles</h1>
        <p>Générateur de cartes hors-ligne PMTiles (OSM • IGN)</p>
    </div>

    <div class="content">
        <div class="section">
            <h2>Source des tuiles</h2>
            <select id="tileSource" onchange="changeTileSource()">
                <option value="osm">OpenStreetMap</option>
                <option value="ign">IGN Plan v2 (France)</option>
            </select>
        </div>

        <div class="section">
            <h2>Centre de la carte</h2>
            <div class="input-row">
                <input type="number" id="lat" step="0.000001" value="44.8378" placeholder="Latitude">
                <input type="number" id="lon" step="0.000001" value="-0.5792" placeholder="Longitude">
            </div>
            <button class="btn btn-primary" onclick="setCenterManual()">Positionner</button>
            <button class="btn btn-primary" onclick="setCenterGPS()">Ma position GPS</button>
            <p style="margin-top:10px; color:#64748b;">Cliquez aussi sur la carte</p>
            <div id="map"></div>
            <div style="margin-top:10px; padding:10px; background:#dbeafe; border-radius:8px;">
                Centre : <strong id="centerInfo">44.8378, -0.5792</strong>
            </div>
        </div>

        <div class="section">
            <h2>Paramètres</h2>
            <div style="margin:20px 0;">
                <label>Rayon : <span class="slider-value" id="radiusValue">10 km</span></label>
                <input type="range" id="radius" min="1" max="50" value="10" step="1" style="width:100%; margin-top:8px;" oninput="updateRadius()">
            </div>
            <div class="input-row">
                <div><label>Zoom min</label><input type="number" id="minZoom" value="10" min="0" max="18"></div>
                <div><label>Zoom max</label><input type="number" id="maxZoom" value="16" min="0" max="18"></div>
            </div>

            <div class="folder-section">
                <button class="btn btn-success" onclick="selectDirectory()" id="dirBtn" style="width:100%;padding:15px;font-size:1.1em;">
                    Activer le choix du dossier
                </button>
                <p id="dirInfo" style="margin-top:10px;">Sinon → dossier Téléchargements</p>
            </div>

            <button class="btn btn-primary" onclick="generatePMTiles()" style="width:100%;padding:18px;font-size:1.3em;margin-top:20px;">
                Générer le fichier .pmtiles
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
                <div style="text-align:center;font-weight:600;" id="progressText">Préparation…</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log('SW OK'))
            .catch(err => console.log('SW erreur:', err));
    }

    let map, marker, circle, tileLayer;
    let centerLat = 44.8378, centerLon = -0.5792;
    let directoryHandle = null;
    let currentTileSource = 'osm';

    function initMap() {
        map = L.map('map').setView([centerLat, centerLon], 13);
        changeTileSource();
        marker = L.marker([centerLat, centerLon]).addTo(map);
        circle = L.circle([centerLat, centerLon], {radius:10000, color:'#2563eb', fillOpacity:0.15}).addTo(map);
        map.on('click', e => { centerLat = e.latlng.lat; centerLon = e.latlng.lng; updateCenter(); });
        updateCenter();
    }

    function changeTileSource() {
        currentTileSource = document.getElementById('tileSource').value;
        if (tileLayer) map.removeLayer(tileLayer);
        tileLayer = L.tileLayer(currentTileSource === 'osm' ?
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' :
            'https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}',
            { attribution: currentTileSource === 'osm' ? '© OpenStreetMap' : '© IGN', maxZoom:19 }
        ).addTo(map);
    }

    function updateCenter() {
        marker.setLatLng([centerLat, centerLon]);
        circle.setLatLng([centerLat, centerLon]);
        map.setView([centerLat, centerLon]);
        document.getElementById('lat').value = centerLat.toFixed(6);
        document.getElementById('lon').value = centerLon.toFixed(6);
        document.getElementById('centerInfo').textContent = `${centerLat.toFixed(6)}, ${centerLon.toFixed(6)}`;
        updateRadius();
    }

    function setCenterManual() { centerLat = +document.getElementById('lat').value; centerLon = +document.getElementById('lon').value; updateCenter(); }
    function setCenterGPS() { navigator.geolocation.getCurrentPosition(p=>{centerLat=p.coords.latitude; centerLon=p.coords.longitude; updateCenter();}); }
    function updateRadius() {
        const r = +document.getElementById('radius').value;
        document.getElementById('radiusValue').textContent = r + ' km';
        circle.setRadius(r * 1000);
    }
    function selectDirectory() {
        directoryHandle = 'use_picker';
        document.getElementById('dirBtn').textContent = 'Choix du dossier activé !';
        document.getElementById('dirBtn').classList.replace('btn-success','btn-success');
        document.getElementById('dirInfo').textContent = 'Vous choisirez le dossier à la sauvegarde';
    }

    function getTileBounds(lat, lon, radiusKm, z) {
        const R = 6371;
        const latRad = lat * Math.PI / 180;
        const latOffset = (radiusKm / R) * (180 / Math.PI);
        const lonOffset = (radiusKm / R) * (180 / Math.PI) / Math.cos(latRad);
        const minLat = lat - latOffset, maxLat = lat + latOffset;
        const minLon = lon - lonOffset, maxLon = lon + lonOffset;
        const long2tile = (lon,z) => Math.floor((lon + 180)/360 * (1<<z));
        const lat2tile = (lat,z) => Math.floor((1 - Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 * (1<<z));
        return { minX: long2tile(minLon,z), maxX: long2tile(maxLon,z), minY: lat2tile(maxLat,z), maxY: lat2tile(minLat,z) };
    }

    async function generatePMTiles() {
        const radius = +document.getElementById('radius').value;
        const minZ = +document.getElementById('minZoom').value;
        const maxZ = +document.getElementById('maxZoom').value;
        if (minZ > maxZ) return alert('Zoom min > Zoom max');

        const now = new Date();
        const name = `trektiles-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

        let fileHandle = null;
        if (directoryHandle === 'use_picker' && 'showSaveFilePicker' in window) {
            try { fileHandle = await showSaveFilePicker({ suggestedName: name + '.pmtiles', types: [{accept:{'application/octet-stream':['.pmtiles']}}] }); }
            catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('progressFill').style.width = '0%';

        const writer = new PMTiles.Writer();
        let total = 0, done = 0;

        for (let z=minZ; z<=maxZ; z++) {
            const b = getTileBounds(centerLat, centerLon, radius, z);
            total += (b.maxX - b.minX + 1) * (b.maxY - b.minY + 1);
        }

        for (let z=minZ; z<=maxZ; z++) {
            const b = getTileBounds(centerLat, centerLon, radius, z);
            for (let x=b.minX; x<=b.maxX; x++) {
                for (let y=b.minY; y<=b.maxY; y++) {
                    try {
                        const url = currentTileSource === 'osm' ?
                            `https://tile.openstreetmap.org/${z}/${x}/${y}.png` :
                            `https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX=${z}&TILEROW=${y}&TILECOL=${x}`;
                        const r = await fetch(url);
                        if (!r.ok) continue;
                        const buf = await r.arrayBuffer();
                        await writer.addTile(z, x, y, buf);
                        done++;
                        const pct = Math.round(done/total*100);
                        document.getElementById('progressFill').style.width = pct + '%';
                        document.getElementById('progressFill').textContent = pct + '%';
                        document.getElementById('progressText').textContent = `Téléchargement ${done}/${total}…`;
                        if (done % 30 === 0) await new Promise(r=>setTimeout(r,1));
                    } catch(e) {}
                }
            }
        }

        document.getElementById('progressText').textContent = 'Finalisation…';
        const final = await writer.finish({
            minZoom: minZ, maxZoom: maxZ,
            center: [centerLon, centerLat, Math.round((minZ+maxZ)/2)],
            name: "TrekTiles – " + (currentTileSource==='osm'?'OSM':'IGN'),
            attribution: currentTileSource==='osm'?'© OpenStreetMap contributors':'© IGN',
            format: 'png'
        });

        const blob = new Blob([final], {type:'application/octet-stream'});
        if (fileHandle) {
            const w = await fileHandle.createWritable();
            await w.write(blob); await w.close();
            document.getElementById('progressText').textContent = `Terminé ! ${name}.pmtiles sauvegardé`;
        } else {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + '.pmtiles';
            a.click();
            document.getElementById('progressText').textContent = `Terminé ! Téléchargement démarré`;
        }
        document.getElementById('progressFill').style.width = '100%';
        setTimeout(()=>document.getElementById('progressContainer').style.display='none', 5000);
    }

    window.onload = initMap;
</script>
</body>
</html>