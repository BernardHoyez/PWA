<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marando - PWA Randonn√©e</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon512.png">
  <link rel="apple-touch-icon" href="icon192.png">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Marando">
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            overflow: hidden;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            color: #2563eb;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #f0f9ff;
        }

        .controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 0.75rem 1.2rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .btn-start {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-stop {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-history {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
        }

        .status.recording {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.6; }
        }

        .info-panel {
            position: absolute;
            top: 4rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 1000;
            min-width: 200px;
        }

        .info-item {
            margin-bottom: 0.5rem;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #2563eb;
            font-weight: 700;
        }

        .tile {
            position: absolute;
            width: 256px;
            height: 256px;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
        }

        .marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 500;
        }

        .track-point {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #2563eb;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 400;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
            color: white;
        }

        .modal-content {
            max-width: 500px;
            margin: 0 auto;
            background: #2563eb;
            padding: 20px;
            border-radius: 10px;
        }

        .hike-item {
            margin: 10px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .hike-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-download {
            background: #10b981;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        @media (max-width: 768px) {
            .controls {
                bottom: 1rem;
                gap: 0.3rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            
            .info-panel {
                left: 0.5rem;
                right: 0.5rem;
                min-width: auto;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container">
   <header class="header">
    <h1 id="app-title">Marando</h1>
   </header>
   <div class="map-container">
    <div id="map"></div>
    <div class="status" id="status">
     Initialisation...
    </div>
    <div class="info-panel" id="info-panel">
     <div class="info-item"><span class="info-label">Distance:</span> <span class="info-value" id="distance">0.0 km</span>
     </div>
     <div class="info-item"><span class="info-label">Dur√©e:</span> <span class="info-value" id="duration">00:00:00</span>
     </div>
     <div class="info-item"><span class="info-label">Points:</span> <span class="info-value" id="points-count">0</span>
     </div>
    </div>
    <div class="controls"><button class="btn btn-start" id="start-btn">Commencer</button> <button class="btn btn-stop" id="stop-btn" disabled>Arr√™ter</button> <button class="btn btn-history" id="history-btn">Historique</button>
    </div>
   </div>
   <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>
     Chargement de la carte...
    </div>
   </div>
   <div class="toast" id="toast"></div>
  </div>
  <script>
        // Variables globales
        let userPosition = null;
        let isRecording = false;
        let trackPoints = [];
        let startTime = null;
        let timerInterval = null;
        let totalDistance = 0;
        let lastPosition = null;
        let watchId = null;
        let tiles = new Map();
        let mapCenter = { lat: 46.5197, lon: 6.6323 };
        let mapZoom = 15;

        // Stockage local
        function saveHikeToStorage(hikeData) {
            try {
                const hikes = JSON.parse(localStorage.getItem('marando_hikes') || '[]');
                hikes.push(hikeData);
                localStorage.setItem('marando_hikes', JSON.stringify(hikes));
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                return false;
            }
        }

        function getHikesFromStorage() {
            try {
                return JSON.parse(localStorage.getItem('marando_hikes') || '[]');
            } catch (error) {
                return [];
            }
        }

        function deleteHikeFromStorage(hikeId) {
            try {
                const hikes = JSON.parse(localStorage.getItem('marando_hikes') || '[]');
                const filtered = hikes.filter(h => h.id !== hikeId);
                localStorage.setItem('marando_hikes', JSON.stringify(filtered));
                return true;
            } catch (error) {
                return false;
            }
        }

        // Utilitaires
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateStatus(text, isRecording = false) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${isRecording ? 'recording' : ''}`;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Conversion coordonn√©es
        function latLonToTile(lat, lon, zoom) {
            const n = Math.pow(2, zoom);
            const x = Math.floor((lon + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(lat * Math.PI / 180)) / Math.PI) / 2 * n);
            return { x, y };
        }

        function latLonToPixel(lat, lon, zoom, centerLat, centerLon) {
            const centerTile = latLonToTile(centerLat, centerLon, zoom);
            const pointTile = latLonToTile(lat, lon, zoom);
            return {
                x: (pointTile.x - centerTile.x) * 256,
                y: (pointTile.y - centerTile.y) * 256
            };
        }

        // Gestion tuiles
        function loadTile(x, y, zoom) {
            const tileKey = `${zoom}-${x}-${y}`;
            if (tiles.has(tileKey)) return;

            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.style.left = `${(x - Math.floor(mapCenter.x)) * 256}px`;
            tile.style.top = `${(y - Math.floor(mapCenter.y)) * 256}px`;

            const img = document.createElement('img');
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            
            const ign_url = `https://wxs.ign.fr/cartes/geoportail/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX=${zoom}&TILEROW=${y}&TILECOL=${x}`;
            
            img.onerror = function() {
                tile.style.background = `linear-gradient(45deg, #f0f9ff ${(x+y)%2*50}%, #e0f2fe ${50+(x+y)%2*50}%)`;
                tile.innerHTML = `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#64748b;">${x},${y}</div>`;
            };
            
            img.src = ign_url;
            tile.appendChild(img);
            document.getElementById('map').appendChild(tile);
            tiles.set(tileKey, tile);
        }

        function loadTilesAroundPosition(lat, lon, radius = 5000) {
            const zoom = mapZoom;
            const centerTile = latLonToTile(lat, lon, zoom);
            const tilesRadius = Math.ceil(radius / (40075000 / Math.pow(2, zoom)) * 256 / 256);
            
            for (let x = centerTile.x - tilesRadius; x <= centerTile.x + tilesRadius; x++) {
                for (let y = centerTile.y - tilesRadius; y <= centerTile.y + tilesRadius; y++) {
                    if (x >= 0 && y >= 0 && x < Math.pow(2, zoom) && y < Math.pow(2, zoom)) {
                        loadTile(x, y, zoom);
                    }
                }
            }
        }

        // Position utilisateur
        function updateUserPosition(lat, lon) {
            userPosition = { lat, lon };
            mapCenter = { lat, lon };
            
            let marker = document.querySelector('.marker');
            if (!marker) {
                marker = document.createElement('div');
                marker.className = 'marker';
                document.getElementById('map').appendChild(marker);
            }
            
            const mapRect = document.getElementById('map').getBoundingClientRect();
            marker.style.left = `${mapRect.width / 2}px`;
            marker.style.top = `${mapRect.height / 2}px`;
            
            loadTilesAroundPosition(lat, lon);
            updateStatus('Position GPS acquise');
        }

        function addTrackPoint(lat, lon) {
            if (!isRecording) return;
            
            const point = { lat, lon, timestamp: Date.now() };
            trackPoints.push(point);
            
            if (lastPosition) {
                const distance = calculateDistance(lastPosition.lat, lastPosition.lon, lat, lon);
                totalDistance += distance;
                document.getElementById('distance').textContent = `${totalDistance.toFixed(2)} km`;
            }
            
            lastPosition = { lat, lon };
            
            const trackPoint = document.createElement('div');
            trackPoint.className = 'track-point';
            
            const pixel = latLonToPixel(lat, lon, mapZoom, mapCenter.lat, mapCenter.lon);
            const mapRect = document.getElementById('map').getBoundingClientRect();
            trackPoint.style.left = `${mapRect.width / 2 + pixel.x}px`;
            trackPoint.style.top = `${mapRect.height / 2 + pixel.y}px`;
            
            document.getElementById('map').appendChild(trackPoint);
            document.getElementById('points-count').textContent = trackPoints.length;
        }

        // G√©n√©ration fichiers
        function generateGPX(name, points) {
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Marando">
    <trk>
        <name>${name}</name>
        <trkseg>`;
            
            points.forEach(point => {
                const date = new Date(point.timestamp).toISOString();
                gpx += `
            <trkpt lat="${point.lat}" lon="${point.lon}">
                <time>${date}</time>
            </trkpt>`;
            });
            
            gpx += `
        </trkseg>
    </trk>
</gpx>`;
            return gpx;
        }

        function generateKML(name, points) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${name}</name>
        <Placemark>
            <name>Randonn√©e ${name}</name>
            <LineString>
                <coordinates>`;
            
            points.forEach(point => {
                kml += `${point.lon},${point.lat},0 `;
            });
            
            kml += `</coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            return kml;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // √âv√©nements randonn√©e
        function startRecording() {
            if (!userPosition) {
                showToast('Position GPS non disponible', true);
                return;
            }
            
            isRecording = true;
            trackPoints = [];
            totalDistance = 0;
            lastPosition = null;
            startTime = Date.now();
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            updateStatus('Enregistrement en cours...', true);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('duration').textContent = formatDuration(elapsed);
            }, 1000);
            
            showToast('Randonn√©e d√©marr√©e !');
        }

        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            clearInterval(timerInterval);
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            updateStatus('Randonn√©e termin√©e');
            
            if (trackPoints.length === 0) {
                showToast('Aucun point enregistr√©', true);
                return;
            }
            
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
            const name = `Randonn√©e_${date}_${time}`;
            
            const gpxData = generateGPX(name, trackPoints);
            const kmlData = generateKML(name, trackPoints);
            
            const duration = Math.floor((Date.now() - startTime) / 1000);
            const hikeData = {
                id: `hike_${Date.now()}`,
                name: name,
                date: new Date().toISOString(),
                duration: duration,
                distance: totalDistance,
                gpx_data: gpxData,
                kml_data: kmlData,
                points: JSON.stringify(trackPoints)
            };
            
            const saved = saveHikeToStorage(hikeData);
            if (saved) {
                showToast('Randonn√©e sauvegard√©e !');
                downloadFile(gpxData, `${name}.gpx`, 'application/gpx+xml');
                downloadFile(kmlData, `${name}.kml`, 'application/vnd.google-earth.kml+xml');
            } else {
                showToast('Erreur lors de la sauvegarde', true);
            }
        }

        // G√©olocalisation
        function initGeolocation() {
            if (!navigator.geolocation) {
                showToast('G√©olocalisation non support√©e', true);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 1000
            };
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    updateUserPosition(lat, lon);
                    addTrackPoint(lat, lon);
                    
                    document.getElementById('loading').style.display = 'none';
                },
                (error) => {
                    console.error('Erreur g√©olocalisation:', error);
                    showToast('Erreur GPS: ' + error.message, true);
                    document.getElementById('loading').style.display = 'none';
                },
                options
            );
        }

        // Historique
        function showHikesHistory() {
            const hikes = getHikesFromStorage();
            if (hikes.length === 0) {
                showToast('Aucune randonn√©e sauvegard√©e');
                return;
            }
            
            let historyHtml = '<h3>Historique des randonn√©es (' + hikes.length + ')</h3>';
            hikes.reverse().forEach(hike => {
                const date = new Date(hike.date).toLocaleDateString('fr-FR');
                const time = new Date(hike.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                historyHtml += `
                    <div class="hike-item">
                        <strong>${hike.name}</strong><br>
                        üìÖ ${date} √† ${time}<br>
                        üìè Distance: ${hike.distance.toFixed(2)} km<br>
                        ‚è±Ô∏è Dur√©e: ${formatDuration(hike.duration)}<br>
                        üìç Points: ${JSON.parse(hike.points).length}
                        <div class="hike-actions">
                            <button class="btn-small btn-download" onclick="downloadHikeFiles('${hike.id}')">üì• T√©l√©charger</button>
                            <button class="btn-small btn-delete" onclick="deleteHike('${hike.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    ${historyHtml}
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                        Fermer
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadHikeFiles(hikeId) {
            const hikes = getHikesFromStorage();
            const hike = hikes.find(h => h.id === hikeId);
            if (hike) {
                downloadFile(hike.gpx_data, `${hike.name}.gpx`, 'application/gpx+xml');
                downloadFile(hike.kml_data, `${hike.name}.kml`, 'application/vnd.google-earth.kml+xml');
                showToast('Fichiers t√©l√©charg√©s !');
            }
        }

        function deleteHike(hikeId) {
            if (deleteHikeFromStorage(hikeId)) {
                showToast('Randonn√©e supprim√©e');
                document.querySelector('.modal').remove();
                showHikesHistory();
            } else {
                showToast('Erreur lors de la suppression', true);
            }
        }

        // Initialisation
        function init() {
            document.getElementById('start-btn').addEventListener('click', startRecording);
            document.getElementById('stop-btn').addEventListener('click', stopRecording);
            document.getElementById('history-btn').addEventListener('click', showHikesHistory);
            
            initGeolocation();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            }
        }

        init();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f1f4b2b71a3d11',t:'MTc2MzI0MzMzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>