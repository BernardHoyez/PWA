<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marando - PWA Randonn√©e</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon512.png">
  <link rel="apple-touch-icon" href="icon192.png">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Marando">
  <style>
        html, body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            overflow: hidden;
        }

        .app-container {
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            color: #2563eb;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #f0f9ff;
        }

        .controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 0.75rem 1.2rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .btn-start {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-stop {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-history {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
        }

        .status.recording {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.6; }
        }

        .info-panel {
            position: absolute;
            top: 4rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 1000;
            min-width: 200px;
        }

        .info-item {
            margin-bottom: 0.5rem;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #2563eb;
            font-weight: 700;
        }

        .tile {
            position: absolute;
            width: 256px;
            height: 256px;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
        }

        .marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 500;
        }

        .track-point {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #2563eb;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 400;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
            color: white;
        }

        .modal-content {
            max-width: 500px;
            margin: 0 auto;
            background: #2563eb;
            padding: 20px;
            border-radius: 10px;
        }

        .hike-item {
            margin: 10px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .hike-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-download {
            background: #10b981;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .map-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }

        .zoom-controls {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #2563eb;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .center-btn {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .controls {
                bottom: 1rem;
                gap: 0.3rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            
            .info-panel {
                left: 0.5rem;
                right: 0.5rem;
                min-width: auto;
            }

            .map-controls {
                top: 0.5rem;
                left: 0.5rem;
            }

            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container">
   <header class="header">
    <h1 id="app-title">Marando</h1>
   </header>
   <div class="map-container">
    <div id="map"></div>
    <div class="status" id="status">
     Initialisation...
    </div>
    <div class="info-panel" id="info-panel">
     <div class="info-item"><span class="info-label">Distance:</span> <span class="info-value" id="distance">0.0 km</span>
     </div>
     <div class="info-item"><span class="info-label">Dur√©e:</span> <span class="info-value" id="duration">00:00:00</span>
     </div>
     <div class="info-item"><span class="info-label">Points:</span> <span class="info-value" id="points-count">0</span>
     </div>
    </div>
    <div class="controls"><button class="btn btn-start" id="start-btn">Commencer</button> <button class="btn btn-stop" id="stop-btn" disabled>Arr√™ter</button> <button class="btn btn-history" id="history-btn">Historique</button>
    </div><!-- Contr√¥les de navigation -->
    <div class="map-controls">
     <div class="zoom-controls"><button class="control-btn" id="zoom-in">+</button> <button class="control-btn" id="zoom-out">-</button>
     </div><button class="control-btn center-btn" id="center-btn">üìç</button>
    </div>
   </div>
   <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>
     Chargement de la carte...
    </div>
   </div>
   <div class="toast" id="toast"></div>
  </div>
  <script>
        // Variables globales
        let userPosition = null;
        let isRecording = false;
        let trackPoints = [];
        let startTime = null;
        let timerInterval = null;
        let totalDistance = 0;
        let lastPosition = null;
        let watchId = null;
        let tiles = new Map();
        let mapCenter = { lat: 49.4944, lon: 0.1079 };
        let mapZoom = 15;

        // Stockage local
        function saveHikeToStorage(hikeData) {
            try {
                const hikes = JSON.parse(localStorage.getItem('marando_hikes') || '[]');
                hikes.push(hikeData);
                localStorage.setItem('marando_hikes', JSON.stringify(hikes));
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                return false;
            }
        }

        function getHikesFromStorage() {
            try {
                return JSON.parse(localStorage.getItem('marando_hikes') || '[]');
            } catch (error) {
                return [];
            }
        }

        function deleteHikeFromStorage(hikeId) {
            try {
                const hikes = JSON.parse(localStorage.getItem('marando_hikes') || '[]');
                const filtered = hikes.filter(h => h.id !== hikeId);
                localStorage.setItem('marando_hikes', JSON.stringify(filtered));
                return true;
            } catch (error) {
                return false;
            }
        }

        // Utilitaires
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateStatus(text, isRecording = false) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${isRecording ? 'recording' : ''}`;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Conversion coordonn√©es
        function latLonToTile(lat, lon, zoom) {
            const n = Math.pow(2, zoom);
            const x = Math.floor((lon + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(lat * Math.PI / 180)) / Math.PI) / 2 * n);
            return { x, y };
        }

        function latLonToPixel(lat, lon, zoom, centerLat, centerLon) {
            const centerTile = latLonToTile(centerLat, centerLon, zoom);
            const pointTile = latLonToTile(lat, lon, zoom);
            return {
                x: (pointTile.x - centerTile.x) * 256,
                y: (pointTile.y - centerTile.y) * 256
            };
        }

        // Gestion tuiles
        function loadTile(x, y, zoom) {
            const tileKey = `${zoom}-${x}-${y}`;
            if (tiles.has(tileKey)) return;

            const tile = document.createElement('div');
            tile.className = 'tile';
            
            // Calculer la position relative au centre de la carte
            const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, zoom);
            const offsetX = (x - centerTile.x) * 256;
            const offsetY = (y - centerTile.y) * 256;
            
            const mapRect = document.getElementById('map').getBoundingClientRect();
            tile.style.left = `${mapRect.width / 2 + offsetX}px`;
            tile.style.top = `${mapRect.height / 2 + offsetY}px`;

            // URL IGN officielle G√©oPlateforme fran√ßaise
            const ign_url = `https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX=${zoom}&TILEROW=${y}&TILECOL=${x}&FORMAT=image/png`;
            const osm_url = `https://tile.openstreetmap.org/${zoom}/${x}/${y}.png`;
            
            // Affichage imm√©diat avec style de base
            tile.style.background = `linear-gradient(45deg, #e8f4f8 ${(x+y)%2*25}%, #d1e7dd ${25+(x+y)%2*25}%)`;
            tile.innerHTML = `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:12px;color:#2563eb;font-weight:600;text-align:center;">üó∫Ô∏è<br>IGN ${x},${y}<br>Z${zoom}</div>`;

            // Tentative de chargement des vraies tuiles IGN
            const img = document.createElement('img');
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                console.log(`‚úÖ Tuile IGN ${x},${y} charg√©e avec succ√®s`);
                tile.innerHTML = '';
                tile.appendChild(img);
            };
            
            img.onerror = function() {
                console.log(`‚ùå Tuile IGN ${x},${y} √©chou√©e, tentative OSM...`);
                // Fallback vers OpenStreetMap
                const fallbackImg = document.createElement('img');
                fallbackImg.style.width = '100%';
                fallbackImg.style.height = '100%';
                fallbackImg.style.objectFit = 'cover';
                fallbackImg.crossOrigin = 'anonymous';
                
                fallbackImg.onload = function() {
                    console.log(`‚úÖ Tuile OSM ${x},${y} charg√©e en fallback`);
                    tile.innerHTML = '';
                    tile.appendChild(fallbackImg);
                };
                
                fallbackImg.onerror = function() {
                    console.log(`‚ùå Toutes les tuiles ${x},${y} √©chou√©es, garde le style par d√©faut`);
                    // Le style par d√©faut reste visible
                };
                
                fallbackImg.src = osm_url;
            };
            
            // D√©marrer le chargement IGN
            img.src = ign_url;
            document.getElementById('map').appendChild(tile);
            tiles.set(tileKey, tile);
        }

        // Navigation carte
        function clearAllTiles() {
            tiles.forEach(tile => tile.remove());
            tiles.clear();
        }

        function refreshMap() {
            clearAllTiles();
            loadTilesAroundPosition(mapCenter.lat, mapCenter.lon);
            updateMarkerPosition();
        }

        function updateMarkerPosition() {
            if (!userPosition) return;
            
            const marker = document.querySelector('.marker');
            if (!marker) return;
            
            const pixel = latLonToPixel(userPosition.lat, userPosition.lon, mapZoom, mapCenter.lat, mapCenter.lon);
            const mapRect = document.getElementById('map').getBoundingClientRect();
            marker.style.left = `${mapRect.width / 2 + pixel.x}px`;
            marker.style.top = `${mapRect.height / 2 + pixel.y}px`;
        }

        function panMap(deltaLat, deltaLon) {
            mapCenter.lat += deltaLat;
            mapCenter.lon += deltaLon;
            refreshMap();
        }

        function zoomMap(delta) {
            const newZoom = Math.max(5, Math.min(18, mapZoom + delta));
            if (newZoom !== mapZoom) {
                mapZoom = newZoom;
                refreshMap();
            }
        }

        function centerOnUser() {
            if (userPosition) {
                mapCenter = { lat: userPosition.lat, lon: userPosition.lon };
                refreshMap();
                showToast('Centr√© sur votre position');
            } else {
                showToast('Position GPS non disponible', true);
            }
        }

        function loadTilesAroundPosition(lat, lon, radius = 2) {
            const zoom = mapZoom;
            const centerTile = latLonToTile(lat, lon, zoom);
            
            // Charger une grille 5x5 de tuiles autour de la position
            for (let x = centerTile.x - radius; x <= centerTile.x + radius; x++) {
                for (let y = centerTile.y - radius; y <= centerTile.y + radius; y++) {
                    if (x >= 0 && y >= 0 && x < Math.pow(2, zoom) && y < Math.pow(2, zoom)) {
                        loadTile(x, y, zoom);
                    }
                }
            }
        }

        // Position utilisateur
        function updateUserPosition(lat, lon) {
            userPosition = { lat, lon };
            mapCenter = { lat, lon };
            
            let marker = document.querySelector('.marker');
            if (!marker) {
                marker = document.createElement('div');
                marker.className = 'marker';
                document.getElementById('map').appendChild(marker);
            }
            
            const mapRect = document.getElementById('map').getBoundingClientRect();
            marker.style.left = `${mapRect.width / 2}px`;
            marker.style.top = `${mapRect.height / 2}px`;
            
            loadTilesAroundPosition(lat, lon);
            updateStatus('Position GPS acquise');
        }

        function addTrackPoint(lat, lon) {
            if (!isRecording) return;
            
            const point = { lat, lon, timestamp: Date.now() };
            trackPoints.push(point);
            
            if (lastPosition) {
                const distance = calculateDistance(lastPosition.lat, lastPosition.lon, lat, lon);
                totalDistance += distance;
                document.getElementById('distance').textContent = `${totalDistance.toFixed(2)} km`;
            }
            
            lastPosition = { lat, lon };
            
            const trackPoint = document.createElement('div');
            trackPoint.className = 'track-point';
            
            const pixel = latLonToPixel(lat, lon, mapZoom, mapCenter.lat, mapCenter.lon);
            const mapRect = document.getElementById('map').getBoundingClientRect();
            trackPoint.style.left = `${mapRect.width / 2 + pixel.x}px`;
            trackPoint.style.top = `${mapRect.height / 2 + pixel.y}px`;
            
            document.getElementById('map').appendChild(trackPoint);
            document.getElementById('points-count').textContent = trackPoints.length;
        }

        // G√©n√©ration fichiers
        function generateGPX(name, points) {
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Marando">
    <trk>
        <name>${name}</name>
        <trkseg>`;
            
            points.forEach(point => {
                const date = new Date(point.timestamp).toISOString();
                gpx += `
            <trkpt lat="${point.lat}" lon="${point.lon}">
                <time>${date}</time>
            </trkpt>`;
            });
            
            gpx += `
        </trkseg>
    </trk>
</gpx>`;
            return gpx;
        }

        function generateKML(name, points) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${name}</name>
        <Placemark>
            <name>Randonn√©e ${name}</name>
            <LineString>
                <coordinates>`;
            
            points.forEach(point => {
                kml += `${point.lon},${point.lat},0 `;
            });
            
            kml += `</coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            return kml;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // √âv√©nements randonn√©e
        function startRecording() {
            if (!userPosition) {
                showToast('Position GPS non disponible', true);
                return;
            }
            
            isRecording = true;
            trackPoints = [];
            totalDistance = 0;
            lastPosition = null;
            startTime = Date.now();
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            updateStatus('Enregistrement en cours...', true);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('duration').textContent = formatDuration(elapsed);
            }, 1000);
            
            showToast('Randonn√©e d√©marr√©e !');
        }

        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            clearInterval(timerInterval);
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            updateStatus('Randonn√©e termin√©e');
            
            if (trackPoints.length === 0) {
                showToast('Aucun point enregistr√©', true);
                return;
            }
            
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
            const name = `Randonn√©e_${date}_${time}`;
            
            const gpxData = generateGPX(name, trackPoints);
            const kmlData = generateKML(name, trackPoints);
            
            const duration = Math.floor((Date.now() - startTime) / 1000);
            const hikeData = {
                id: `hike_${Date.now()}`,
                name: name,
                date: new Date().toISOString(),
                duration: duration,
                distance: totalDistance,
                gpx_data: gpxData,
                kml_data: kmlData,
                points: JSON.stringify(trackPoints)
            };
            
            const saved = saveHikeToStorage(hikeData);
            if (saved) {
                showToast('Randonn√©e sauvegard√©e !');
                downloadFile(gpxData, `${name}.gpx`, 'application/gpx+xml');
                downloadFile(kmlData, `${name}.kml`, 'application/vnd.google-earth.kml+xml');
            } else {
                showToast('Erreur lors de la sauvegarde', true);
            }
        }

        // G√©olocalisation am√©lior√©e
        function initGeolocation() {
            if (!navigator.geolocation) {
                showToast('G√©olocalisation non support√©e', true);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 5000
            };
            
            // Position initiale pr√©cise
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    console.log(`üìç Position initiale pr√©cise: ${lat}, ${lon} (pr√©cision: ${position.coords.accuracy}m)`);
                    
                    updateUserPosition(lat, lon);
                    document.getElementById('loading').style.display = 'none';
                    showToast(`Position acquise (¬±${Math.round(position.coords.accuracy)}m)`);
                },
                (error) => {
                    console.error('Erreur position initiale:', error);
                    showToast('Position approximative utilis√©e', true);
                    document.getElementById('loading').style.display = 'none';
                },
                options
            );
            
            // Suivi continu
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    updateUserPosition(lat, lon);
                    addTrackPoint(lat, lon);
                },
                (error) => {
                    console.error('Erreur g√©olocalisation continue:', error);
                },
                options
            );
        }

        // Contr√¥les tactiles et clavier
        function initMapControls() {
            const mapElement = document.getElementById('map');
            let isDragging = false;
            let lastTouch = null;
            let dragStart = null;

            // √âv√©nements souris
            mapElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
                mapElement.style.cursor = 'grabbing';
            });

            mapElement.addEventListener('mousemove', (e) => {
                if (!isDragging || !dragStart) return;
                
                const deltaX = e.clientX - dragStart.x;
                const deltaY = e.clientY - dragStart.y;
                
                if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                    const latDelta = deltaY * 0.0001;
                    const lonDelta = -deltaX * 0.0001;
                    panMap(latDelta, lonDelta);
                    dragStart = { x: e.clientX, y: e.clientY };
                }
            });

            mapElement.addEventListener('mouseup', () => {
                isDragging = false;
                dragStart = null;
                mapElement.style.cursor = 'grab';
            });

            // √âv√©nements tactiles
            mapElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            mapElement.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && lastTouch) {
                    const deltaX = e.touches[0].clientX - lastTouch.x;
                    const deltaY = e.touches[0].clientY - lastTouch.y;
                    
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        const latDelta = deltaY * 0.0001;
                        const lonDelta = -deltaX * 0.0001;
                        panMap(latDelta, lonDelta);
                        lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    }
                }
            });

            mapElement.addEventListener('touchend', () => {
                lastTouch = null;
            });

            // Zoom molette
            mapElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -1 : 1;
                zoomMap(delta);
            });

            // Contr√¥les clavier
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        panMap(0.001, 0);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        panMap(-0.001, 0);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        panMap(0, -0.001);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        panMap(0, 0.001);
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomMap(1);
                        break;
                    case '-':
                        e.preventDefault();
                        zoomMap(-1);
                        break;
                    case 'c':
                    case 'C':
                        e.preventDefault();
                        centerOnUser();
                        break;
                }
            });

            // Boutons de contr√¥le
            document.getElementById('zoom-in').addEventListener('click', () => zoomMap(1));
            document.getElementById('zoom-out').addEventListener('click', () => zoomMap(-1));
            document.getElementById('center-btn').addEventListener('click', centerOnUser);

            mapElement.style.cursor = 'grab';
        }

        // Historique
        function showHikesHistory() {
            const hikes = getHikesFromStorage();
            if (hikes.length === 0) {
                showToast('Aucune randonn√©e sauvegard√©e');
                return;
            }
            
            let historyHtml = '<h3>Historique des randonn√©es (' + hikes.length + ')</h3>';
            hikes.reverse().forEach(hike => {
                const date = new Date(hike.date).toLocaleDateString('fr-FR');
                const time = new Date(hike.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                historyHtml += `
                    <div class="hike-item">
                        <strong>${hike.name}</strong><br>
                        üìÖ ${date} √† ${time}<br>
                        üìè Distance: ${hike.distance.toFixed(2)} km<br>
                        ‚è±Ô∏è Dur√©e: ${formatDuration(hike.duration)}<br>
                        üìç Points: ${JSON.parse(hike.points).length}
                        <div class="hike-actions">
                            <button class="btn-small btn-download" onclick="downloadHikeFiles('${hike.id}')">üì• T√©l√©charger</button>
                            <button class="btn-small btn-delete" onclick="deleteHike('${hike.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    ${historyHtml}
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                        Fermer
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadHikeFiles(hikeId) {
            const hikes = getHikesFromStorage();
            const hike = hikes.find(h => h.id === hikeId);
            if (hike) {
                downloadFile(hike.gpx_data, `${hike.name}.gpx`, 'application/gpx+xml');
                downloadFile(hike.kml_data, `${hike.name}.kml`, 'application/vnd.google-earth.kml+xml');
                showToast('Fichiers t√©l√©charg√©s !');
            }
        }

        function deleteHike(hikeId) {
            if (deleteHikeFromStorage(hikeId)) {
                showToast('Randonn√©e supprim√©e');
                document.querySelector('.modal').remove();
                showHikesHistory();
            } else {
                showToast('Erreur lors de la suppression', true);
            }
        }

        // Initialisation
        function init() {
            console.log('Initialisation de Marando...');
            
            // V√©rifier que les √©l√©ments existent
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const historyBtn = document.getElementById('history-btn');
            const loading = document.getElementById('loading');
            
            if (!startBtn || !stopBtn || !historyBtn) {
                console.error('√âl√©ments manquants dans le DOM');
                return;
            }
            
            // √âv√©nements
            startBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);
            historyBtn.addEventListener('click', showHikesHistory);
            
            // Charger imm√©diatement la carte en mode d√©mo
            updateStatus('Chargement de la carte...');
            updateUserPosition(49.4944, 0.1079); // Position par d√©faut (Le Havre)
            
            // Masquer le loading apr√®s 3 secondes
            setTimeout(() => {
                if (loading) {
                    loading.style.display = 'none';
                }
            }, 3000);
            
            // Initialiser les contr√¥les de navigation
            initMapControls();
            
            // D√©marrer la g√©olocalisation en arri√®re-plan
            setTimeout(() => {
                initGeolocation();
            }, 1000);
            
            // Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('Service Worker non disponible:', err);
                });
            }
            
            console.log('Marando initialis√© avec succ√®s');
        }

        // D√©marrer quand le DOM est pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f249093197d086',t:'MTc2MzI0Njc5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>