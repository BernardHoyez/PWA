<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivons le Guide</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .controls {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            z-index: 1000;
            position: relative;
            justify-content: space-between;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            background: #4CAF50;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .file-input-label:hover {
            background: #45a049;
        }
        
        .status {
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            white-space: nowrap;
        }
        
        .gps-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            transition: background 0.3s;
        }
        
        .gps-indicator.active {
            background: #4CAF50;
            animation: gpsIndicatorPulse 2s infinite;
        }
        
        @keyframes gpsIndicatorPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #map {
            height: calc(100vh - 160px);
            width: 100%;
            z-index: 1;
        }
        
        /* Styles personnalisés pour la popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 8px 8px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            padding: 0;
        }
        
        .popup-content {
            width: 90vw;
            max-width: 90vw;
            padding: 0.5rem;
        }
        
        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 0.5rem;
        }
        
        .popup-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-comment {
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .popup-media {
            margin-top: 1rem;
        }
        
        .popup-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .popup-video {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .popup-audio {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .navigation-info {
            background: #E3F2FD;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        
        .distance {
            color: #1976D2;
            font-size: 1.1rem;
        }
        
        .azimuth {
            color: #388E3C;
            font-size: 1rem;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border-left: 4px solid #f44336;
        }
        
        /* Bouton commutateur Carte/Liste - Version simplifiée pour debug */
        .view-toggle {
            position: fixed !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: white !important;
            border-radius: 25px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
            display: flex !important;
            padding: 4px !important;
            z-index: 999999 !important;
            border: 3px solid #2196F3 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .toggle-btn {
            background: transparent !important;
            border: none !important;
            padding: 0.75rem 1.5rem !important;
            border-radius: 20px !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            font-size: 0.9rem !important;
            transition: all 0.3s ease !important;
            color: #666 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            visibility: visible !important;
        }
        
        .toggle-btn:hover {
            background: #f5f5f5;
        }
        
        .toggle-btn.active {
            background: #2196F3;
            color: white;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        /* Vue Liste des POI */
        .poi-list-view {
            height: calc(100vh - 160px);
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .poi-list-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .poi-list-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .poi-count {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .poi-list-content {
            padding: 1rem;
        }
        
        .no-poi {
            text-align: center;
            color: #999;
            font-style: italic;
            margin: 2rem 0;
        }
        
        .poi-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #2196F3;
        }
        
        .poi-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        .poi-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .poi-title {
            font-weight: bold;
            color: #2196F3;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .poi-id {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .poi-location {
            color: #666;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .poi-distance {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .poi-comment {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .poi-media-indicators {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .media-indicator {
            background: #f5f5f5;
            color: #666;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* Style pour le marqueur utilisateur */
        .user-position-marker {
            width: 26px !important;
            height: 26px !important;
            background: transparent !important;
            position: relative !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .user-position-marker::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #FF4444;
            border: 3px solid white;
            border-radius: 50%;
            animation: userPulse 2s infinite;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.6);
            transform-origin: center;
        }
        
        @keyframes userPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.6);
            }
            50% {
                transform: scale(1.3);
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.9);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.6);
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                padding: 0.75rem;
            }
            
            .popup-content {
                width: 90vw;
                max-width: 90vw;
                padding: 0.25rem;
            }
            
            #map {
                height: calc(100vh - 200px);
            }
            
            .poi-list-view {
                height: calc(100vh - 200px);
            }
            
            .toggle-btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            
            .view-toggle {
                bottom: 15px;
                padding: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Suivons le Guide</h1>
    </div>
    
    <div class="controls">
        <div class="file-input-wrapper">
            <input type="file" id="zipFile" accept=".zip" />
            <label for="zipFile" class="file-input-label">📁 Charger le fichier ZIP</label>
        </div>
        <div class="status" id="status">Aucun fichier chargé</div>
        <div class="gps-status">
            <div class="gps-indicator" id="gpsIndicator"></div>
            <span id="gpsStatus">GPS inactif</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- Bouton commutateur Carte/Liste -->
    <div class="view-toggle">
        <button id="mapViewBtn" class="toggle-btn active">🗺️ Carte</button>
        <button id="listViewBtn" class="toggle-btn">📋 Liste</button>
    </div>
    
    <!-- Vue Liste des POI -->
    <div id="poiList" class="poi-list-view" style="display: none;">
        <div class="poi-list-header">
            <h2>Points d'Intérêt</h2>
            <span id="poiCount" class="poi-count">0 POI</span>
        </div>
        <div id="poiListContent" class="poi-list-content">
            <p class="no-poi">Aucun fichier chargé</p>
        </div>
    </div>
    
    <div class="loading" id="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Chargement en cours...</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        class VisitGuideApp {
            constructor() {
                this.map = null;
                this.userMarker = null;
                this.poiMarkers = [];
                this.visitData = [];
                this.zipData = null;
                this.userPosition = null;
                this.watchId = null;
                this.currentView = 'map';
                
                this.initMap();
                this.initEventListeners();
                this.startGeolocation();
                this.registerServiceWorker();
            }
            
            initMap() {
                this.map = L.map('map').setView([46.6034, 1.8883], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);
            }
            
            initEventListeners() {
                document.getElementById('zipFile').addEventListener('change', (e) => {
                    this.handleZipFile(e.target.files[0]);
                });
                
                // Gestionnaires pour le commutateur Carte/Liste
                const mapViewBtn = document.getElementById('mapViewBtn');
                const listViewBtn = document.getElementById('listViewBtn');
                
                if (mapViewBtn && listViewBtn) {
                    mapViewBtn.addEventListener('click', () => {
                        this.switchToMapView();
                    });
                    
                    listViewBtn.addEventListener('click', () => {
                        this.switchToListView();
                    });
                }
            }
            
            showLoading(show = true) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
            
            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 5000);
            }
            
            async handleZipFile(file) {
                if (!file) return;
                
                this.showLoading(true);
                this.updateStatus('Lecture du fichier ZIP...');
                
                try {
                    const zip = new JSZip();
                    this.zipData = await zip.loadAsync(file);
                    
                    // Debug : afficher tous les fichiers du ZIP
                    console.log('=== CONTENU COMPLET DU ZIP ===');
                    this.zipData.forEach((relativePath, zipEntry) => {
                        console.log('Fichier ZIP:', relativePath);
                    });
                    console.log('=== FIN CONTENU ZIP ===');
                    
                    const visitJsonFile = this.zipData.file('visit.json');
                    if (!visitJsonFile) {
                        throw new Error('Fichier visit.json non trouvé');
                    }
                    
                    const visitJsonContent = await visitJsonFile.async('string');
                    this.visitData = JSON.parse(visitJsonContent);
                    
                    // Debug : afficher le contenu du visit.json
                    console.log('=== CONTENU VISIT.JSON ===');
                    console.log(this.visitData);
                    console.log('=== FIN VISIT.JSON ===');
                    
                    this.updateStatus(`${this.visitData.length} POI`);
                    await this.loadPointsOfInterest();
                    this.updatePOIList();
                    
                } catch (error) {
                    console.error('Erreur lors du chargement du fichier ZIP:', error);
                    this.showError('Erreur lors du chargement: ' + error.message);
                    this.updateStatus('Erreur lors du chargement');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async loadPointsOfInterest() {
                this.poiMarkers.forEach(marker => this.map.removeLayer(marker));
                this.poiMarkers = [];
                
                const bounds = [];
                
                for (const poi of this.visitData) {
                    try {
                        const poiData = await this.loadPOIData(poi);
                        
                        if (poiData.location) {
                            const marker = L.marker([poiData.location.lat, poiData.location.lng])
                                .addTo(this.map);
                            
                            // Stocker les données POI dans le marqueur pour un accès direct
                            marker.poiData = poiData;
                            
                            // Configuration de la popup avec options personnalisées
                            marker.bindPopup('', {
                                maxWidth: window.innerWidth * 0.9,
                                minWidth: window.innerWidth * 0.9,
                                className: 'custom-popup',
                                closeButton: true,
                                autoClose: false,
                                keepInView: false,
                                autoPan: false,
                                autoPanPadding: [20, 20]
                            });
                            
                            // Gestionnaire de clic pour centrer la vue et ouvrir la popup
                            marker.on('click', (e) => {
                                // Centrer la carte sur le marqueur
                                this.map.setView([poiData.location.lat, poiData.location.lng], Math.max(this.map.getZoom(), 15), {
                                    animate: true,
                                    duration: 0.5
                                });
                                
                                // Créer le contenu de la popup au moment du clic
                                setTimeout(() => {
                                    console.log('=== CREATION POPUP AU CLIC ===');
                                    console.log('Données marker.poiData:', marker.poiData);
                                    console.log('imageUrl présente:', !!marker.poiData?.imageUrl);
                                    console.log('videoUrl présente:', !!marker.poiData?.videoUrl);
                                    console.log('audioUrl présente:', !!marker.poiData?.audioUrl);
                                    
                                    const popupContent = this.createPopupContent(marker.poiData);
                                    console.log('Contenu popup créé:', popupContent);
                                    console.log('Nombre d\'enfants:', popupContent.children.length);
                                    
                                    // Vérifier si il y a un conteneur média
                                    const mediaContainer = popupContent.querySelector('.popup-media');
                                    console.log('Conteneur média trouvé:', !!mediaContainer);
                                    if (mediaContainer) {
                                        console.log('Enfants du conteneur média:', mediaContainer.children.length);
                                        Array.from(mediaContainer.children).forEach((child, i) => {
                                            console.log(`Enfant ${i}:`, child.tagName, child.className);
                                        });
                                    }
                                    
                                    marker.setPopupContent(popupContent);
                                    marker.openPopup();
                                    console.log('=== FIN CREATION POPUP AU CLIC ===');
                                }, 200);
                                
                                this.handlePOIClick(poiData);
                            });
                            
                            this.poiMarkers.push(marker);
                            bounds.push([poiData.location.lat, poiData.location.lng]);
                        }
                    } catch (error) {
                        console.error(`Erreur lors du chargement du POI ${poi.id}:`, error);
                    }
                }
                
                if (bounds.length > 0) {
                    this.map.fitBounds(bounds, { padding: [20, 20] });
                }
            }
            
            async loadPOIData(poi) {
                const poiData = { ...poi };
                
                try {
                    if (poi.titleFile) {
                        const titleFile = this.zipData.file(`data/${poi.folder}/${poi.titleFile}`);
                        if (titleFile) {
                            poiData.title = await titleFile.async('string');
                        }
                    }
                    
                    if (poi.locationFile) {
                        const locationFile = this.zipData.file(`data/${poi.folder}/${poi.locationFile}`);
                        if (locationFile) {
                            const locationStr = await locationFile.async('string');
                            poiData.location = this.parseLocation(locationStr.trim());
                        }
                    }
                    
                    if (poi.commentFile) {
                        const commentFile = this.zipData.file(`data/${poi.folder}/${poi.commentFile}`);
                        if (commentFile) {
                            poiData.comment = await commentFile.async('string');
                        }
                    }
                    
                    // Chargement des médias avec diagnostic complet
                    if (poi.image) {
                        console.log(`=== DEBUG IMAGE POI ${poi.id} ===`);
                        console.log('Nom de fichier attendu:', poi.image);
                        console.log('Chemin complet attendu:', `data/${poi.folder}/${poi.image}`);
                        
                        // Vérifier tous les fichiers dans le dossier du POI
                        const folderFiles = [];
                        this.zipData.forEach((relativePath, zipEntry) => {
                            if (relativePath.startsWith(`data/${poi.folder}/`) && !zipEntry.dir) {
                                folderFiles.push(relativePath);
                            }
                        });
                        console.log('Fichiers trouvés dans le dossier:', folderFiles);
                        
                        // Essayer de trouver l'image
                        let imageFound = false;
                        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
                        
                        // 1. Essai exact
                        let imageFile = this.zipData.file(`data/${poi.folder}/${poi.image}`);
                        if (imageFile) {
                            console.log('✓ Image trouvée avec nom exact');
                            const imageBlob = await imageFile.async('blob');
                            poiData.imageUrl = URL.createObjectURL(imageBlob);
                            console.log('✓ Blob URL créée:', poiData.imageUrl);
                            imageFound = true;
                        } else {
                            console.log('✗ Image non trouvée avec nom exact');
                            
                            // 2. Recherche dans tous les fichiers images du dossier
                            for (const filePath of folderFiles) {
                                const fileName = filePath.split('/').pop().toLowerCase();
                                const hasImageExt = imageExtensions.some(ext => fileName.endsWith(ext.toLowerCase()));
                                
                                if (hasImageExt) {
                                    console.log('Tentative avec:', filePath);
                                    imageFile = this.zipData.file(filePath);
                                    if (imageFile) {
                                        console.log('✓ Image trouvée:', filePath);
                                        const imageBlob = await imageFile.async('blob');
                                        poiData.imageUrl = URL.createObjectURL(imageBlob);
                                        console.log('✓ Blob URL créée:', poiData.imageUrl);
                                        imageFound = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (!imageFound) {
                            console.log('✗ Aucune image trouvée pour le POI', poi.id);
                        }
                        console.log(`=== FIN DEBUG IMAGE POI ${poi.id} ===`);
                    }
                    
                    if (poi.video) {
                        const videoFile = this.zipData.file(`data/${poi.folder}/${poi.video}`);
                        if (videoFile) {
                            const videoBlob = await videoFile.async('blob');
                            poiData.videoUrl = URL.createObjectURL(videoBlob);
                        }
                    }
                    
                    if (poi.audio) {
                        const audioFile = this.zipData.file(`data/${poi.folder}/${poi.audio}`);
                        if (audioFile) {
                            const audioBlob = await audioFile.async('blob');
                            poiData.audioUrl = URL.createObjectURL(audioBlob);
                        }
                    }
                    
                } catch (error) {
                    console.error(`Erreur lors du chargement des données pour le POI ${poi.id}:`, error);
                }
                
                return poiData;
            }
            
            parseLocation(locationStr) {
                try {
                    const [latStr, lngStr] = locationStr.split(',').map(s => s.trim());
                    
                    const lat = parseFloat(latStr.replace('N', '').replace('S', ''));
                    const latSign = latStr.includes('S') ? -1 : 1;
                    
                    const lng = parseFloat(lngStr.replace('E', '').replace('W', ''));
                    const lngSign = lngStr.includes('W') ? -1 : 1;
                    
                    return {
                        lat: lat * latSign,
                        lng: lng * lngSign
                    };
                } catch (error) {
                    console.error('Erreur lors du parsing de la localisation:', locationStr, error);
                    return null;
                }
            }
            
            createPopupContent(poiData) {
                console.log(`=== DEBUT CREATION POPUP CONTENT ===`);
                console.log('POI Data reçue:', poiData);
                
                if (!poiData) {
                    console.error('ERREUR: poiData est null/undefined !');
                    return document.createElement('div');
                }
                
                console.log('Image URL dans createPopupContent:', poiData.imageUrl);
                console.log('Video URL dans createPopupContent:', poiData.videoUrl);
                console.log('Audio URL dans createPopupContent:', poiData.audioUrl);
                
                const container = document.createElement('div');
                container.className = 'popup-content';
                
                // FORCE un élément visible pour test
                const testDiv = document.createElement('div');
                testDiv.style.cssText = `
                    background: red !important;
                    color: white !important;
                    padding: 10px !important;
                    margin: 10px 0 !important;
                    border: 3px solid black !important;
                    font-weight: bold !important;
                `;
                testDiv.textContent = 'TEST POPUP VISIBLE';
                container.appendChild(testDiv);
                
                if (this.userPosition && poiData.location) {
                    const navInfo = this.calculateNavigationInfo(poiData.location);
                    container.appendChild(navInfo);
                }
                
                if (poiData.title) {
                    const title = document.createElement('div');
                    title.className = 'popup-title';
                    title.textContent = poiData.title;
                    container.appendChild(title);
                }
                
                if (poiData.location) {
                    const location = document.createElement('div');
                    location.className = 'popup-location';
                    location.textContent = `📍 ${poiData.location.lat.toFixed(5)}°, ${poiData.location.lng.toFixed(5)}°`;
                    container.appendChild(location);
                }
                
                if (poiData.comment) {
                    const comment = document.createElement('div');
                    comment.className = 'popup-comment';
                    comment.textContent = poiData.comment;
                    container.appendChild(comment);
                }
                
                const mediaContainer = document.createElement('div');
                mediaContainer.className = 'popup-media';
                
                // FORCE un test média visible
                const mediaTest = document.createElement('div');
                mediaTest.style.cssText = `
                    background: blue !important;
                    color: white !important;
                    padding: 10px !important;
                    margin: 5px 0 !important;
                    border: 2px solid yellow !important;
                `;
                mediaTest.textContent = 'CONTENEUR MEDIA TEST';
                mediaContainer.appendChild(mediaTest);
                
                if (poiData.imageUrl) {
                    console.log('=== CREATION IMAGE ===');
                    const img = document.createElement('img');
                    img.src = poiData.imageUrl;
                    img.className = 'popup-image';
                    img.alt = poiData.title || 'Image';
                    img.style.cssText = `
                        max-width: 100% !important; 
                        height: auto !important; 
                        display: block !important;
                        border: 5px solid red !important;
                        background: yellow !important;
                        min-height: 50px !important;
                    `;
                    
                    img.onload = function() {
                        console.log('✓ Image onload réussie');
                        this.style.border = '5px solid green';
                    };
                    
                    img.onerror = function(e) {
                        console.error('✗ Erreur image:', e);
                        this.style.border = '5px solid purple';
                    };
                    
                    mediaContainer.appendChild(img);
                    console.log('Image ajoutée au mediaContainer');
                } else {
                    console.log('PAS D\'IMAGE URL - ajout placeholder');
                    const noImg = document.createElement('div');
                    noImg.style.cssText = `
                        background: orange !important;
                        color: black !important;
                        padding: 20px !important;
                        border: 3px solid red !important;
                        text-align: center !important;
                    `;
                    noImg.textContent = 'PAS D\'IMAGE URL';
                    mediaContainer.appendChild(noImg);
                }
                
                if (poiData.videoUrl) {
                    const video = document.createElement('video');
                    video.src = poiData.videoUrl;
                    video.className = 'popup-video';
                    video.controls = true;
                    mediaContainer.appendChild(video);
                }
                
                if (poiData.audioUrl) {
                    const audio = document.createElement('audio');
                    audio.src = poiData.audioUrl;
                    audio.className = 'popup-audio';
                    audio.controls = true;
                    mediaContainer.appendChild(audio);
                }
                
                container.appendChild(mediaContainer);
                console.log('MediaContainer ajouté avec', mediaContainer.children.length, 'enfants');
                
                console.log('Container final:', container);
                console.log(`=== FIN CREATION POPUP CONTENT ===`);
                
                return container;
            }
            
            calculateNavigationInfo(targetLocation) {
                const container = document.createElement('div');
                container.className = 'navigation-info';
                
                const distance = this.calculateDistance(
                    this.userPosition.lat, this.userPosition.lng,
                    targetLocation.lat, targetLocation.lng
                );
                
                const azimuth = this.calculateAzimuth(
                    this.userPosition.lat, this.userPosition.lng,
                    targetLocation.lat, targetLocation.lng
                );
                
                const distanceDiv = document.createElement('div');
                distanceDiv.className = 'distance';
                distanceDiv.textContent = `Distance: ${Math.round(distance)} m`;
                container.appendChild(distanceDiv);
                
                const azimuthDiv = document.createElement('div');
                azimuthDiv.className = 'azimuth';
                azimuthDiv.textContent = `Azimut: Nord ${Math.round(azimuth)}°`;
                container.appendChild(azimuthDiv);
                
                return container;
            }
            
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            calculateAzimuth(lat1, lng1, lat2, lng2) {
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const lat1Rad = lat1 * Math.PI / 180;
                const lat2Rad = lat2 * Math.PI / 180;
                
                const y = Math.sin(dLng) * Math.cos(lat2Rad);
                const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                        Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
                
                let azimuth = Math.atan2(y, x) * 180 / Math.PI;
                return (azimuth + 360) % 360;
            }
            
            handlePOIClick(poiData) {
                // Popup handled automatically by Leaflet
            }
            
            startGeolocation() {
                if (!navigator.geolocation) {
                    this.updateGpsStatus('GPS non disponible', false);
                    return;
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };
                
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.onGeolocationSuccess(position),
                    (error) => this.onGeolocationError(error),
                    options
                );
            }
            
            onGeolocationSuccess(position) {
                this.userPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                if (this.userMarker) {
                    // Mettre à jour seulement la position du marqueur existant
                    this.userMarker.setLatLng([this.userPosition.lat, this.userPosition.lng]);
                } else {
                    // Créer le marqueur avec l'icône personnalisée
                    this.userMarker = L.marker([this.userPosition.lat, this.userPosition.lng], {
                        icon: L.divIcon({
                            className: 'user-position-marker',
                            html: '',
                            iconSize: [26, 26],
                            iconAnchor: [13, 13],
                            popupAnchor: [0, -13]
                        })
                    }).addTo(this.map);
                    
                    this.userMarker.bindPopup('Votre position');
                }
                
                this.updateGpsStatus('GPS actif', true);
            }
            
            onGeolocationError(error) {
                let message = 'Erreur GPS';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Permission GPS refusée';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Position indisponible';
                        break;
                    case error.TIMEOUT:
                        message = 'Timeout GPS';
                        break;
                }
                this.updateGpsStatus(message, false);
            }
            
            updateGpsStatus(message, active) {
                document.getElementById('gpsStatus').textContent = message;
                const indicator = document.getElementById('gpsIndicator');
                if (active) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }
            
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('Service Worker enregistré avec succès:', registration.scope);
                        })
                        .catch((error) => {
                            console.log('Échec de l\'enregistrement du Service Worker:', error);
                        });
                }
            }
            
            switchToMapView() {
                this.currentView = 'map';
                document.getElementById('map').style.display = 'block';
                document.getElementById('poiList').style.display = 'none';
                document.getElementById('mapViewBtn').classList.add('active');
                document.getElementById('listViewBtn').classList.remove('active');
            }
            
            switchToListView() {
                this.currentView = 'list';
                document.getElementById('map').style.display = 'none';
                document.getElementById('poiList').style.display = 'block';
                document.getElementById('mapViewBtn').classList.remove('active');
                document.getElementById('listViewBtn').classList.add('active');
                this.updatePOIList();
            }
            
            updatePOIList() {
                const listContent = document.getElementById('poiListContent');
                const poiCount = document.getElementById('poiCount');
                
                if (!this.visitData || this.visitData.length === 0) {
                    listContent.innerHTML = '<p class="no-poi">Aucun POI chargé</p>';
                    poiCount.textContent = '0 POI';
                    return;
                }
                
                poiCount.textContent = `${this.visitData.length} POI`;
                
                // Trier les POI par ID
                const sortedPOI = [...this.visitData].sort((a, b) => a.id - b.id);
                
                listContent.innerHTML = '';
                
                sortedPOI.forEach(async (poi) => {
                    const poiData = await this.loadPOIData(poi);
                    const poiElement = this.createPOIListItem(poiData);
                    listContent.appendChild(poiElement);
                });
            }
            
            createPOIListItem(poiData) {
                const item = document.createElement('div');
                item.className = 'poi-item';
                
                // Calculer la distance si position utilisateur disponible
                let distanceText = '';
                if (this.userPosition && poiData.location) {
                    const distance = this.calculateDistance(
                        this.userPosition.lat, this.userPosition.lng,
                        poiData.location.lat, poiData.location.lng
                    );
                    distanceText = `<div class="poi-distance">📍 ${Math.round(distance)} m</div>`;
                }
                
                // Indicateurs de médias
                const mediaIndicators = [];
                if (poiData.imageUrl) mediaIndicators.push('<span class="media-indicator">🖼️ Image</span>');
                if (poiData.videoUrl) mediaIndicators.push('<span class="media-indicator">🎥 Vidéo</span>');
                if (poiData.audioUrl) mediaIndicators.push('<span class="media-indicator">🎵 Audio</span>');
                
                item.innerHTML = `
                    <div class="poi-item-header">
                        <h3 class="poi-title">${poiData.title || `Point ${poiData.id}`}</h3>
                        <span class="poi-id">#${poiData.id}</span>
                    </div>
                    ${poiData.location ? `<div class="poi-location">📍 ${poiData.location.lat.toFixed(5)}°, ${poiData.location.lng.toFixed(5)}°</div>` : ''}
                    ${poiData.comment ? `<div class="poi-comment">${poiData.comment}</div>` : ''}
                    ${distanceText}
                    ${mediaIndicators.length > 0 ? `<div class="poi-media-indicators">${mediaIndicators.join('')}</div>` : ''}
                `;
                
                // Gestionnaire de clic pour basculer vers la carte et centrer sur le POI
                item.addEventListener('click', () => {
                    if (poiData.location) {
                        this.switchToMapView();
                        // Centrer la carte sur le POI
                        this.map.setView([poiData.location.lat, poiData.location.lng], Math.max(this.map.getZoom(), 15), {
                            animate: true,
                            duration: 0.8
                        });
                        // Trouver et ouvrir la popup correspondante
                        this.poiMarkers.forEach(marker => {
                            const markerPos = marker.getLatLng();
                            if (Math.abs(markerPos.lat - poiData.location.lat) < 0.00001 && 
                                Math.abs(markerPos.lng - poiData.location.lng) < 0.00001) {
                                setTimeout(() => {
                                    marker.openPopup();
                                }, 500);
                            }
                        });
                    }
                });
                
                return item;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new VisitGuideApp();
        });
    </script>
</body>
</html>