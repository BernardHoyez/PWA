<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Treking - Trace GPS avec PMTiles</title>
    <meta name="theme-color" content="#059669">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
    <link rel="apple-touch-icon" href="icon192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3.0.3/dist/pmtiles.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: linear-gradient(135deg, #047857 0%, #059669 100%); min-height: 100vh; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: #047857; color: #fff; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header h1 { font-size: 1.5em; font-weight: 700; }
        
        .mode-selection { background: #fff; padding: 30px 20px; text-align: center; min-height: 100vh; }
        .mode-selection h2 { color: #047857; margin-bottom: 30px; font-size: 1.8em; }
        .mode-buttons { display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 0 auto; }
        .mode-btn { padding: 20px; border: 3px solid #047857; border-radius: 15px; background: #fff;
                    font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .mode-btn:hover { background: #047857; color: #fff; }
        .mode-btn.offline { border-color: #dc2626; }
        .mode-btn.offline:hover { background: #dc2626; }
        
        .map-container { flex: 1; position: relative; display: none; }
        #map { width: 100%; height: 100%; }
        .controls { position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px; z-index: 1000; }
        .control-buttons { display: flex; gap: 10px; justify-content: center; }
        
        /* üö® CLASSES POUR AFFICHER/CACHER LES BOUTONS */
        .control-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            min-width: 100px;
        }
        .control-btn:active { transform: scale(0.95); }
        .btn-start { background: #10b981; color: #fff; }
        .btn-stop { background: #ef4444; color: #fff; }
        .btn-save { background: #3b82f6; color: #fff; }
        .hidden { display: none !important; }
        .visible { display: inline-flex !important; }
        
        .status-bar { position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.7);
                      color: #fff; padding: 10px 15px; font-size: 0.9em; z-index: 1000;
                      display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: 5px; }
        .live-indicator { width: 10px; height: 10px; background: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .file-input { position: absolute; top: 70px; left: 20px; z-index: 1000; background: #fff;
                    padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    display: none; max-width: 250px; }
        .file-input label { font-weight: 600; color: #047857; margin-bottom: 5px; display: block; }
        .tile-source-selector { position: absolute; top: 70px; right: 20px; z-index: 1000; background: #fff;
                              padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                              display: none; }
        .distance-display { position: absolute; top: 130px; left: 20px; background: #fff; padding: 10px 15px;
                           border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-weight: 600;
                           color: #047857; display: none; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.3em; }
            .control-buttons { gap: 5px; }
            .control-btn { padding: 12px 20px; font-size: 0.9em; min-width: 80px; }
        }
    </style>
</head>
<body>
    <!-- Mode s√©lection -->
    <div class="mode-selection" id="modeSelection">
        <h2>üó∫Ô∏è Treking</h2>
        <p style="color: #6b7280; margin-bottom: 30px;">Choisissez votre mode de navigation</p>
        <div class="mode-buttons">
            <button class="mode-btn" onclick="startApp('online')">
                üì∂ Mode En Ligne<br>
                <small style="font-weight:normal;">OSM / IGN en direct</small>
            </button>
            <button class="mode-btn offline" onclick="startApp('offline')">
                üì¥ Mode Hors Ligne<br>
                <small style="font-weight:normal;">Utiliser mes PMTiles</small>
            </button>
        </div>
    </div>

    <!-- Application -->
    <div class="container" id="appContainer" style="display: none;">
        <div class="header">
            <h1>üó∫Ô∏è Treking</h1>
        </div>
        
        <div class="map-container" id="mapContainer">
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="live-indicator hidden" id="liveIndicator"></div>
                    <span id="statusText">Initialisation...</span>
                </div>
                <div id="gpsStatus">GPS: üî¥ Inactif</div>
            </div>
            
            <div class="file-input" id="fileInput">
                <label for="pmtileFile">üìÅ Fichier PMTiles :</label>
                <input type="file" id="pmtileFile" accept=".pmtiles" onchange="loadPMTiles(event)">
                <button onclick="document.getElementById('pmtileFile').click()">Choisir un fichier</button>
                <div id="fileName" style="margin-top: 8px; font-size: 0.8em; color: #6b7280;"></div>
            </div>
            
            <div class="tile-source-selector" id="tileSourceSelector">
                <label for="tileSource">üó∫Ô∏è Source :</label>
                <select id="tileSource" onchange="changeTileSource()">
                    <option value="osm">OpenStreetMap</option>
                    <option value="ign">IGN Plan v2</option>
                </select>
            </div>
            
            <div class="distance-display" id="distanceDisplay">
                üìè Distance: <span id="distance">0.00</span> km
            </div>
            
            <div id="map"></div>
            
            <div class="controls">
                <div class="control-buttons">
                    <button class="control-btn btn-start visible" id="startBtn" onclick="startTracking()">‚ñ∂Ô∏è START</button>
                    <button class="control-btn btn-stop hidden" id="stopBtn" onclick="stopTracking()">‚èπÔ∏è STOP</button>
                    <button class="control-btn btn-save hidden" id="saveBtn" onclick="showSaveOptions()">üíæ ENREGISTRER</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let pmtilesInstance = null;
        let currentLayer = null;
        let gpsTracker = null;
        let track = [];
        let isTracking = false;
        let watchId = null;
        let currentMode = null;
        let currentTileSource = 'osm';
        let userMarker = null;
        let trackLine = null;
        let gpsPermissionGranted = false;

        // Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('‚úÖ SW enregistr√©'))
                .catch(err => console.warn('‚ö†Ô∏è Erreur SW:', err));
        }

        // DEMANDER LA PERMISSION GPS APR√àS INTERACTION
        async function requestGPSPermission() {
            if (!navigator.geolocation) {
                updateGPSStatus('üî¥ Non support√©');
                return false;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('‚úÖ Permission GPS accord√©e');
                        gpsPermissionGranted = true;
                        updateGPSStatus('üü¢ Actif');
                        resolve(true);
                    },
                    (error) => {
                        console.error('‚ùå Erreur permission GPS:', error);
                        let message = 'Erreur GPS: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Permission refus√©e. V√©rifiez les param√®tres de votre navigateur.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Position non disponible';
                                break;
                            case error.TIMEOUT:
                                message += 'Timeout';
                                break;
                            default:
                                message += error.message;
                        }
                        alert(message);
                        updateGPSStatus('üî¥ Permission refus√©e');
                        resolve(false);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        // D√âMARRER LA SURVEILLANCE GPS
        function startGPSWatching() {
            if (watchId !== null) return;

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.circleMarker([coords.lat, coords.lon], {
                        radius: 6,
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 1,
                        weight: 2
                    }).addTo(map);
                    
                    if (!map.hasBeenCentered) {
                        map.setView([coords.lat, coords.lon], 16);
                        map.hasBeenCentered = true;
                    }
                    
                    updateGPSStatus(`üü¢ ¬±${coords.accuracy.toFixed(0)}m`);
                },
                (error) => {
                    console.warn('Erreur GPS:', error);
                    updateGPSStatus('üî¥ Erreur');
                },
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
            );
        }

        // D√âMARRER L'APPLICATION
        async function startApp(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('mapContainer').style.display = 'block';
            
            initMap();
            
            setTimeout(async () => {
                const hasPermission = await requestGPSPermission();
                if (mode === 'online' && hasPermission) {
                    startGPSWatching();
                }
            }, 100);
            
            if (mode === 'offline') {
                document.getElementById('fileInput').style.display = 'block';
                document.getElementById('statusText').textContent = 'üì¥ Hors Ligne - S√©lectionnez PMTiles';
            } else {
                document.getElementById('tileSourceSelector').style.display = 'block';
                document.getElementById('distanceDisplay').style.display = 'block';
                changeTileSource();
                document.getElementById('statusText').textContent = 'üì∂ En Ligne - Pr√™t';
            }
        }

        // INITIALISER LA CARTE
        function initMap() {
            map = L.map('map', { zoomControl: true }).setView([44.8378, -0.5792], 13);
            map.hasBeenCentered = false;
            L.control.scale({ position: 'bottomleft' }).addTo(map);
        }

        // Mettre √† jour le statut GPS
        function updateGPSStatus(text) {
            document.getElementById('gpsStatus').textContent = `GPS: ${text}`;
        }

        // Charger PMTiles (inchang√©)
        async function loadPMTiles(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('statusText').textContent = `Chargement de ${file.name}...`;
            
            try {
                const buffer = await file.arrayBuffer();
                pmtilesInstance = new pmtiles.PMTiles(buffer);
                
                const layer = L.tileLayer.pmtiles('', {
                    attribution: '¬© trek-tiles',
                    maxZoom: 19
                });
                
                layer.getTileUrl = function(coords) {
                    const tileId = pmtiles.zxyToTileId(coords.z, coords.x, coords.y);
                    return pmtilesInstance.getZxy(coords.z, coords.x, coords.y).then(tile => {
                        if (tile) {
                            const blob = new Blob([tile.data], { type: 'image/png' });
                            return URL.createObjectURL(blob);
                        }
                        return '';
                    });
                };
                
                if (currentLayer) map.removeLayer(currentLayer);
                currentLayer = layer.addTo(map);
                
                const header = await pmtilesInstance.getHeader();
                if (header.bounds) {
                    const [minLon, minLat, maxLon, maxLat] = header.bounds;
                    map.fitBounds([[minLat, minLon], [maxLat, maxLon]]);
                }
                
                document.getElementById('statusText').textContent = `‚úÖ ${file.name} charg√©`;
                document.getElementById('distanceDisplay').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur chargement PMTiles:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Changer source (inchang√©)
        function changeTileSource() {
            currentTileSource = document.getElementById('tileSource').value;
            if (currentLayer) map.removeLayer(currentLayer);
            
            if (currentTileSource === 'osm') {
                currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            } else {
                currentLayer = L.tileLayer('https://data.geopf.fr/wmts?' +
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
                    '&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png' +
                    '&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
                    attribution: '¬© IGN - Plan v2',
                    maxZoom: 19
                }).addTo(map);
            }
        }

        // üö® CORRECTION PRINCIPALE : Utiliser les classes CSS
        function startTracking() {
            gpsTracker = new GPSTracker();
            if (gpsTracker.start()) {
                isTracking = true;
                track = [];
                
                // Cacher START, afficher STOP
                document.getElementById('startBtn').classList.remove('visible');
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('visible');
                
                document.getElementById('liveIndicator').classList.remove('hidden');
                document.getElementById('liveIndicator').classList.add('visible');
                
                document.getElementById('statusText').textContent = 'üî¥ Enregistrement actif';
                
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
            }
        }

        function stopTracking() {
            if (gpsTracker) gpsTracker.stop();
            isTracking = false;
            
            // Cacher STOP, afficher START et SAVE
            document.getElementById('stopBtn').classList.remove('visible');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').classList.add('visible');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('visible');
            
            document.getElementById('liveIndicator').classList.remove('visible');
            document.getElementById('liveIndicator').classList.add('hidden');
            
            document.getElementById('statusText').textContent = '‚è∏Ô∏è Enregistrement termin√©';
            
            if (currentMode === 'online' && gpsPermissionGranted) {
                startGPSWatching();
            }
        }

        // Reste du code (GPSTracker, export, etc.)
        class GPSTracker {
            constructor() {
                this.positions = [];
                this.startTime = null;
                this.totalDistance = 0;
            }
            
            start() {
                this.startTime = new Date();
                this.positions = [];
                this.totalDistance = 0;
                
                if (!navigator.geolocation) {
                    alert('‚ùå G√©olocalisation non support√©e');
                    return false;
                }

                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                };

                watchId = navigator.geolocation.watchPosition(
                    (position) => this.onPosition(position),
                    (error) => this.onError(error),
                    options
                );

                return true;
            }
            
            stop() {
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
            }
            
            onPosition(position) {
                const coords = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    alt: position.coords.altitude,
                    time: new Date(position.timestamp),
                    accuracy: position.coords.accuracy
                };

                if (this.positions.length > 0) {
                    const last = this.positions[this.positions.length - 1];
                    this.totalDistance += this.calculateDistance(last, coords);
                }

                this.positions.push(coords);
                track.push([coords.lat, coords.lon]);
                
                document.getElementById('distance').textContent = this.totalDistance.toFixed(2);
                
                if (trackLine) map.removeLayer(trackLine);
                trackLine = L.polyline(track, { color: '#ef4444', weight: 4, opacity: 0.8 }).addTo(map);
                
                updateGPSStatus(`üü¢ ¬±${coords.accuracy.toFixed(0)}m`);
            }
            
            onError(error) {
                updateGPSStatus('üî¥ Erreur');
            }
            
            calculateDistance(p1, p2) {
                const R = 6371;
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            getTrack() {
                return {
                    positions: this.positions,
                    startTime: this.startTime,
                    endTime: new Date(),
                    distance: this.totalDistance
                };
            }
        }

        function showSaveOptions() {
            const format = confirm('Exporter au format GPX (OK) ou KML (Annuler) ?');
            format ? exportGPX() : exportKML();
        }

        function exportGPX() {
            const data = gpsTracker.getTrack();
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Treking PWA">
  <trk>
    <name>Randonn√©e ${data.startTime.toLocaleDateString()}</name>
    <trkseg>`;
            
            data.positions.forEach(pos => {
                gpx += `
      <trkpt lat="${pos.lat}" lon="${pos.lon}">
        ${pos.alt ? `<ele>${pos.alt}</ele>` : ''}
        <time>${pos.time.toISOString()}</time>
      </trkpt>`;
            });
            
            gpx += `
    </trkseg>
  </trk>
</gpx>`;
            
            downloadFile(gpx, `randonnee-${Date.now()}.gpx`, 'application/gpx+xml');
        }

        function exportKML() {
            const data = gpsTracker.getTrack();
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Randonn√©e ${data.startTime.toLocaleDateString()}</name>
    <Placemark>
      <name>Trace</name>
      <LineString>
        <coordinates>`;
            
            data.positions.forEach(pos => {
                const alt = pos.alt || 0;
                kml += `${pos.lon},${pos.lat},${alt}\n`;
            });
            
            kml += `</coordinates>
      </LineString>
    </Placemark>
  </Document>
</kml>`;
            
            downloadFile(kml, `randonnee-${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Trace sauvegard√©e : ${filename}`);
        }
    </script>
</body>
</html>