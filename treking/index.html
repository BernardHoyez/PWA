<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Treking - Trace GPS avec PMTiles</title>
    <meta name="theme-color" content="#059669">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon512.png">
    <link rel="apple-touch-icon" href="icon192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3.0.3/dist/pmtiles.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: linear-gradient(135deg, #047857 0%, #059669 100%); min-height: 100vh; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: #047857; color: #fff; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header h1 { font-size: 1.5em; font-weight: 700; }
        
        .mode-selection { background: #fff; padding: 30px 20px; text-align: center; min-height: 100vh; }
        .mode-selection h2 { color: #047857; margin-bottom: 30px; font-size: 1.8em; }
        .mode-buttons { display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 0 auto; }
        .mode-btn { padding: 20px; border: 3px solid #047857; border-radius: 15px; background: #fff;
                    font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.3s;
                    display: flex; align-items: center; justify-content: center; gap: 10px; }
        .mode-btn:hover { background: #047857; color: #fff; transform: translateY(-2px); }
        .mode-btn.offline { border-color: #dc2626; }
        .mode-btn.offline:hover { background: #dc2626; }
        
        .map-container { flex: 1; position: relative; display: none; }
        #map { width: 100%; height: 100%; }
        .controls { position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px; z-index: 1000; }
        .control-buttons { display: flex; gap: 10px; justify-content: center; }
        .control-btn { padding: 15px 25px; border: none; border-radius: 50px; font-size: 1em;
                      font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                      transition: all 0.3s; min-width: 100px; }
        .control-btn:active { transform: scale(0.95); }
        .btn-start { background: #10b981; color: #fff; }
        .btn-stop { background: #ef4444; color: #fff; display: none; }
        .btn-save { background: #3b82f6; color: #fff; display: none; }
        
        .status-bar { position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.7);
                      color: #fff; padding: 10px 15px; font-size: 0.9em; z-index: 1000;
                      display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: 5px; }
        .live-indicator { width: 10px; height: 10px; background: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .file-input { position: absolute; top: 70px; left: 20px; z-index: 1000; background: #fff;
                    padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    display: none; max-width: 250px; }
        .file-input label { font-weight: 600; color: #047857; margin-bottom: 5px; display: block; }
        .file-input input[type="file"] { display: none; }
        .file-input button { width: 100%; padding: 8px; background: #047857; color: #fff; border: none;
                           border-radius: 5px; cursor: pointer; margin-top: 5px; }
        
        .tile-source-selector { position: absolute; top: 70px; right: 20px; z-index: 1000; background: #fff;
                              padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                              display: none; }
        select { padding: 8px; border: 2px solid #047857; border-radius: 5px; width: 100%; }
        
        .distance-display { position: absolute; top: 130px; left: 20px; background: #fff; padding: 10px 15px;
                           border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-weight: 600;
                           color: #047857; display: none; }
        
        /* Message d'erreur */
        .error-message { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; padding: 15px;
                         border-radius: 10px; margin: 20px; display: none; text-align: center; font-weight: 600; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.3em; }
            .control-buttons { gap: 5px; }
            .control-btn { padding: 12px 20px; font-size: 0.9em; min-width: 80px; }
        }
    </style>
</head>
<body>
    <!-- Message d'erreur -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Mode s√©lection -->
    <div class="mode-selection" id="modeSelection">
        <h2>üó∫Ô∏è Treking</h2>
        <p style="color: #6b7280; margin-bottom: 30px;">Choisissez votre mode de navigation</p>
        <div class="mode-buttons">
            <button class="mode-btn" onclick="startApp('online')">
                üì∂ Mode En Ligne<br>
                <small style="font-weight:normal;">OSM / IGN en direct</small>
            </button>
            <button class="mode-btn offline" onclick="startApp('offline')">
                üì¥ Mode Hors Ligne<br>
                <small style="font-weight:normal;">Utiliser mes PMTiles</small>
            </button>
        </div>
    </div>

    <!-- Application -->
    <div class="container" id="appContainer" style="display: none;">
        <div class="header">
            <h1>üó∫Ô∏è Treking</h1>
        </div>
        
        <div class="map-container" id="mapContainer">
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="live-indicator" id="liveIndicator" style="display: none;"></div>
                    <span id="statusText">Initialisation...</span>
                </div>
                <div id="gpsStatus">GPS: üî¥ Inactif</div>
            </div>
            
            <div class="file-input" id="fileInput">
                <label for="pmtileFile">üìÅ Fichier PMTiles :</label>
                <input type="file" id="pmtileFile" accept=".pmtiles" onchange="loadPMTiles(event)">
                <button onclick="document.getElementById('pmtileFile').click()">Choisir un fichier</button>
                <div id="fileName" style="margin-top: 8px; font-size: 0.8em; color: #6b7280;"></div>
            </div>
            
            <div class="tile-source-selector" id="tileSourceSelector">
                <label for="tileSource">üó∫Ô∏è Source :</label>
                <select id="tileSource" onchange="changeTileSource()">
                    <option value="osm">OpenStreetMap</option>
                    <option value="ign">IGN Plan v2</option>
                </select>
            </div>
            
            <div class="distance-display" id="distanceDisplay">
                üìè Distance: <span id="distance">0.00</span> km
            </div>
            
            <div id="map"></div>
            
            <div class="controls">
                <div class="control-buttons">
                    <button class="control-btn btn-start" id="startBtn" onclick="startTracking()">‚ñ∂Ô∏è START</button>
                    <button class="control-btn btn-stop" id="stopBtn" onclick="stopTracking()">‚èπÔ∏è STOP</button>
                    <button class="control-btn btn-save" id="saveBtn" onclick="showSaveOptions()">üíæ ENREGISTRER</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let pmtilesInstance = null;
        let currentLayer = null;
        let gpsTracker = null;
        let track = [];
        let isTracking = false;
        let watchId = null;
        let currentMode = null;
        let currentTileSource = 'osm';
        let userMarker = null;
        let trackLine = null;
        let gpsPermissionGranted = false;

        // Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('‚úÖ SW enregistr√©'))
                .catch(err => console.warn('‚ö†Ô∏è Erreur SW:', err));
        }

        // üö® DEMANDER LA PERMISSION GPS APR√àS INTERACTION UTILISATEUR
        async function requestGPSPermission() {
            if (!navigator.geolocation) {
                showError('‚ùå G√©olocalisation non support√©e par ce navigateur');
                return false;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('‚úÖ Permission GPS accord√©e');
                        gpsPermissionGranted = true;
                        updateGPSStatus('üü¢ Actif');
                        resolve(true);
                    },
                    (error) => {
                        console.error('‚ùå Erreur permission GPS:', error);
                        let message = 'Erreur GPS: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Permission refus√©e. Activez la g√©olocalisation dans les param√®tres.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Position non disponible';
                                break;
                            case error.TIMEOUT:
                                message += 'Timeout';
                                break;
                            default:
                                message += error.message;
                        }
                        showError(message);
                        updateGPSStatus('üî¥ Permission refus√©e');
                        resolve(false);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        // üö® D√âMARRER LA SURVEILLANCE GPS EN MODE EN LIGNE
        function startGPSWatching() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    // Mettre √† jour le marqueur
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.circleMarker([coords.lat, coords.lon], {
                        radius: 6,
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 1,
                        weight: 2
                    }).addTo(map);
                    
                    // Centrer la carte au d√©marrage
                    if (!map.hasBeenCentered) {
                        map.setView([coords.lat, coords.lon], 16);
                        map.hasBeenCentered = true;
                    }
                    
                    updateGPSStatus(`üü¢ ¬±${coords.accuracy.toFixed(0)}m`);
                },
                (error) => {
                    console.warn('Erreur GPS:', error);
                    updateGPSStatus('üî¥ Erreur');
                },
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
            );
        }

        // üö® D√âMARRER L'APPLICATION APR√àS INTERACTION UTILISATEUR
        async function startApp(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('mapContainer').style.display = 'block';
            
            // Initialiser la carte IMM√âDIATEMENT (sans attendre GPS)
            initMap();
            
            // üö® DEMANDER LA PERMISSION GPS APR√àS (l√©ger d√©lai pour √©viter blocage)
            setTimeout(async () => {
                const hasPermission = await requestGPSPermission();
                if (mode === 'online' && hasPermission) {
                    startGPSWatching();
                }
            }, 500);
            
            if (mode === 'offline') {
                document.getElementById('fileInput').style.display = 'block';
                document.getElementById('statusText').textContent = 'üì¥ Hors Ligne - S√©lectionnez PMTiles';
            } else {
                document.getElementById('tileSourceSelector').style.display = 'block';
                document.getElementById('distanceDisplay').style.display = 'block';
                changeTileSource();
                document.getElementById('statusText').textContent = 'üì∂ En Ligne - Pr√™t';
            }
        }

        // üö® INITIALISER LA CARTE SANS GPS
        function initMap() {
            map = L.map('map', { 
                zoomControl: true,
                center: [44.8378, -0.5792],
                zoom: 13
            });
            
            map.hasBeenCentered = false; // Flag pour centrer une seule fois
            
            L.control.scale({ position: 'bottomleft' }).addTo(map);
        }

        // Mettre √† jour le statut GPS
        function updateGPSStatus(text) {
            document.getElementById('gpsStatus').textContent = `GPS: ${text}`;
        }

        // Afficher un message d'erreur
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Charger le fichier PMTiles (inchang√©)
        async function loadPMTiles(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('statusText').textContent = `Chargement de ${file.name}...`;
            
            try {
                const buffer = await file.arrayBuffer();
                pmtilesInstance = new pmtiles.PMTiles(buffer);
                
                const layer = L.tileLayer.pmtiles('', {
                    attribution: '¬© trek-tiles',
                    maxZoom: 19
                });
                
                layer.getTileUrl = function(coords) {
                    const tileId = pmtiles.zxyToTileId(coords.z, coords.x, coords.y);
                    return pmtilesInstance.getZxy(coords.z, coords.x, coords.y).then(tile => {
                        if (tile) {
                            const blob = new Blob([tile.data], { type: 'image/png' });
                            return URL.createObjectURL(blob);
                        }
                        return '';
                    });
                };
                
                if (currentLayer) map.removeLayer(currentLayer);
                currentLayer = layer.addTo(map);
                
                const header = await pmtilesInstance.getHeader();
                if (header.bounds) {
                    const [minLon, minLat, maxLon, maxLat] = header.bounds;
                    map.fitBounds([[minLat, minLon], [maxLat, maxLon]]);
                }
                
                document.getElementById('statusText').textContent = `‚úÖ ${file.name} charg√©`;
                document.getElementById('distanceDisplay').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur chargement PMTiles:', error);
                showError('‚ùå Erreur chargement fichier: ' + error.message);
                document.getElementById('statusText').textContent = '‚ùå √âchec chargement';
            }
        }

        // Changer source (inchang√©)
        function changeTileSource() {
            currentTileSource = document.getElementById('tileSource').value;
            if (currentLayer) map.removeLayer(currentLayer);
            
            if (currentTileSource === 'osm') {
                currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            } else {
                currentLayer = L.tileLayer('https://data.geopf.fr/wmts?' +
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
                    '&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png' +
                    '&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
                    attribution: '¬© IGN - Plan v2',
                    maxZoom: 19
                }).addTo(map);
            }
        }

        // D√©marrer l'enregistrement (inchang√©)
        function startTracking() {
            gpsTracker = new GPSTracker();
            if (gpsTracker.start()) {
                isTracking = true;
                track = [];
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('liveIndicator').style.display = 'block';
                document.getElementById('statusText').textContent = 'üî¥ Enregistrement actif';
                
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
            }
        }

        // Arr√™ter l'enregistrement (inchang√©)
        function stopTracking() {
            if (gpsTracker) gpsTracker.stop();
            isTracking = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'block';
            document.getElementById('liveIndicator').style.display = 'none';
            document.getElementById('statusText').textContent = '‚è∏Ô∏è Enregistrement termin√©';
            
            if (currentMode === 'online' && gpsPermissionGranted) {
                startGPSWatching();
            }
        }

        // Export GPX/KML (inchang√©)
        function showSaveOptions() { /* ... */ }
        function exportGPX() { /* ... */ }
        function exportKML() { /* ... */ }
        function downloadFile(content, filename, mimeType) { /* ... */ }

        // Classes et gestionnaires (inchang√©s)
        class GPSTracker {
            constructor() {
                this.positions = [];
                this.startTime = null;
                this.totalDistance = 0;
            }
            start() { /* ... */ }
            stop() { /* ... */ }
            onPosition(position) { /* ... */ }
            onError(error) { /* ... */ }
            calculateDistance(p1, p2) { /* ... */ }
            getTrack() { /* ... */ }
        }

        // Nettoyage
        window.addEventListener('beforeunload', () => {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        });
    </script>
</body>
</html>