<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ... (garder le mÃªme head) ... -->
</head>
<body>
    <!-- ... (garder le mÃªme HTML) ... -->

    <script>
        let map;
        let pmtilesInstance = null;
        let currentLayer = null;
        let gpsTracker = null;
        let track = [];
        let isTracking = false;
        let watchId = null;
        let currentMode = null;
        let currentTileSource = 'osm';
        let userMarker = null;
        let trackLine = null;

        // Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('âœ… SW enregistrÃ©'))
                .catch(err => console.warn('âš ï¸ Erreur SW:', err));
        }

        // DÃ©marrer l'application
        async function startApp(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('mapContainer').style.display = 'block';
            
            // ðŸš¨ DEMANDER LA PERMISSION GPS AU DÃ‰MARRAGE
            await requestGPSPermission();
            
            initMap();
            
            if (mode === 'offline') {
                document.getElementById('fileInput').style.display = 'block';
                document.getElementById('statusText').textContent = 'ðŸ“´ Mode Hors Ligne - SÃ©lectionnez un fichier PMTiles';
            } else {
                document.getElementById('tileSourceSelector').style.display = 'block';
                document.getElementById('distanceDisplay').style.display = 'block';
                changeTileSource();
                document.getElementById('statusText').textContent = 'ðŸ“¶ Mode En Ligne - PrÃªt';
                
                // ðŸš¨ ACTIVER LE GPS EN MODE EN LIGNE
                startGPSWatching();
            }
        }

        // ðŸš¨ NOUVELLE FONCTION : Demander la permission GPS
        async function requestGPSPermission() {
            if (!navigator.geolocation) {
                alert('âŒ GÃ©olocalisation non supportÃ©e par ce navigateur');
                return false;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('âœ… Permission GPS accordÃ©e');
                        document.getElementById('gpsStatus').textContent = 'GPS: ðŸŸ¢ Actif';
                        resolve(true);
                    },
                    (error) => {
                        console.error('âŒ Erreur permission GPS:', error);
                        let message = 'Erreur GPS: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Permission refusÃ©e. Activez la gÃ©olocalisation dans les paramÃ¨tres de votre navigateur.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Position non disponible';
                                break;
                            case error.TIMEOUT:
                                message += 'Timeout';
                                break;
                            default:
                                message += error.message;
                        }
                        alert(message);
                        document.getElementById('gpsStatus').textContent = 'GPS: ðŸ”´ Permission refusÃ©e';
                        resolve(false);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        // ðŸš¨ NOUVELLE FONCTION : Observer la position GPS en continu
        function startGPSWatching() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            const options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            };

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    // Mettre Ã  jour la position sur la carte
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.circleMarker([coords.lat, coords.lon], {
                        radius: 6,
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 1,
                        weight: 2
                    }).addTo(map);
                    
                    // Centrer sur la position si c'est la premiÃ¨re fois
                    if (track.length === 0) {
                        map.setView([coords.lat, coords.lon], 16);
                    }
                    
                    document.getElementById('gpsStatus').textContent = `GPS: ðŸŸ¢ Â±${coords.accuracy.toFixed(0)}m`;
                },
                (error) => {
                    console.warn('Erreur GPS:', error);
                    document.getElementById('gpsStatus').textContent = 'GPS: ðŸ”´ Erreur';
                },
                options
            );
            
            console.log('âœ… Surveillance GPS dÃ©marrÃ©e');
        }

        // Initialiser la carte
        function initMap() {
            map = L.map('map', { 
                zoomControl: true,
                center: [44.8378, -0.5792],
                zoom: 13
            });
            
            L.control.scale({ position: 'bottomleft' }).addTo(map);
            
            // ðŸš¨ ESSAYER DE RECUPERER LA POSITION ACTUELLE
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 16);
                    console.log('âœ… Position initiale obtenue');
                },
                (error) => {
                    console.warn('âš ï¸ Position initiale non disponible, utilisation des valeurs par dÃ©faut');
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        // ... (garder le reste du code inchangÃ© : loadPMTiles, changeTileSource, startTracking, etc.) ...

        // DÃ©marrer l'enregistrement
        function startTracking() {
            gpsTracker = new GPSTracker();
            if (gpsTracker.start()) {
                isTracking = true;
                track = [];
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('liveIndicator').style.display = 'block';
                document.getElementById('statusText').textContent = 'ðŸ”´ Enregistrement actif';
                
                // ðŸš¨ DÃ‰SACTIVER LA SURVEILLANCE GPS DE BASE PENDANT L'ENREGISTREMENT
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
            }
        }

        // ArrÃªter l'enregistrement
        function stopTracking() {
            if (gpsTracker) gpsTracker.stop();
            isTracking = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'block';
            document.getElementById('liveIndicator').style.display = 'none';
            document.getElementById('statusText').textContent = 'â¸ï¸ Enregistrement terminÃ©';
            
            // ðŸš¨ RÃ‰ACTIVER LA SURVEILLANCE GPS DE BASE
            if (currentMode === 'online') {
                startGPSWatching();
            }
        }

        // ... (garder le reste du code inchangÃ© : exportGPX, exportKML, etc.) ...

        // ðŸš¨ NETTOYER Ã€ LA FERMETURE
        window.addEventListener('beforeunload', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>