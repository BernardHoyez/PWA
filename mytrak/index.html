<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>mytrak</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="css/style.css">
</head>

<body>

<header>
  <h1>mytrak</h1>
  <div id="status">Aucun dossier sélectionné</div>
</header>

<!-- ÉTAPE 1 -->
<section id="step-folder">
  <p><strong>Sélectionner le dossier « mes traces de randos »</strong></p>

  <input
    type="file"
    id="folderInput"
    webkitdirectory
    multiple
  >
</section>

<!-- ÉTAPE 2 -->
<section id="step-map" style="display:none">
  <div id="map"></div>
  <div style="padding:10px">
    <p><strong>La représentation vous convient-elle ?</strong></p>
    <button onclick="exportHTML()">Oui, exporter la carte</button>
    <button onclick="location.reload()">Non, revenir au dossier</button>
  </div>
</section>

<script src="app.js"></script>

<script>
/* =========================
   Gestion sélection dossier
   ========================= */

document.getElementById("folderInput").addEventListener("change", async (event) => {
  const files = Array.from(event.target.files);

  if (files.length === 0) return;

  document.getElementById("status").textContent =
    files.length + " fichier(s) détecté(s)";

  // Initialisation carte
  initMap();

  // Parsing manuel des fichiers HTML
  for (const file of files) {
    if (!file.name.endsWith(".html")) continue;

    const text = await file.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "text/html");

    const gpxScript = doc.querySelector(
      'script[type="application/gpx+xml"]'
    );
    if (!gpxScript) continue;

    const gpxDoc = parser.parseFromString(
      gpxScript.textContent,
      "application/xml"
    );

    const trkpt = gpxDoc.querySelector("trkpt");
    if (!trkpt) continue;

    const lat = parseFloat(trkpt.getAttribute("lat"));
    const lon = parseFloat(trkpt.getAttribute("lon"));

    const marker = L.marker([lat, lon])
      .addTo(map)
      .bindPopup(file.name);

    markers.push(marker);
  }

  if (markers.length > 0) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  document.getElementById("step-folder").style.display = "none";
  document.getElementById("step-map").style.display = "block";
});
</script>

</body>
</html>
