<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MyTrak – Carte des randonnées</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
header {
  padding: 10px;
  background: #2c3e50;
  color: white;
}
#controls {
  padding: 10px;
}
#map {
  width: 100%;
  height: calc(100vh - 120px);
}
button {
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
}
#status {
  margin-top: 8px;
  font-size: 14px;
}
</style>
</head>

<body>

<header>
  <h2>MyTrak – Carte des randonnées</h2>
</header>

<div id="controls">
  <button id="selectFolder">Sélectionner le dossier "mes traces de randos"</button>
  <div id="status">Aucun dossier sélectionné</div>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================================
   INITIALISATION DE LA CARTE
================================ */

const map = L.map('map').setView([46.6, 2.4], 6);

L.tileLayer(
  'https://data.geopf.fr/wmts?' +
  'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
  '&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' +
  '&STYLE=normal&FORMAT=image/png' +
  '&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}',
  {
    attribution: '© IGN – Plan V2',
    maxZoom: 19
  }
).addTo(map);

const markers = [];

/* ================================
   EXTRACTION ROBUSTE DES COORDONNÉES
================================ */

/*
  Principe :
  - On lit le fichier HTML comme TEXTE
  - On cherche la PREMIÈRE paire de coordonnées décimales
  - On accepte lat,lon ou lon,lat
*/

function extractFirstLatLon(text) {

  // Regex très tolérante (ex: 44.12345, 6.98765)
  const regex = /(-?\d{1,3}\.\d+)\s*,\s*(-?\d{1,3}\.\d+)/g;

  let match;
  while ((match = regex.exec(text)) !== null) {

    const a = parseFloat(match[1]);
    const b = parseFloat(match[2]);

    let lat, lon;

    // Test des plages valides
    if (Math.abs(a) <= 90 && Math.abs(b) <= 180) {
      lat = a;
      lon = b;
    } else if (Math.abs(b) <= 90 && Math.abs(a) <= 180) {
      lat = b;
      lon = a;
    } else {
      continue;
    }

    return { lat, lon };
  }

  return null;
}

/* ================================
   SÉLECTION DU DOSSIER
================================ */

document.getElementById('selectFolder').addEventListener('click', async () => {

  try {
    const dirHandle = await window.showDirectoryPicker();
    document.getElementById('status').textContent =
      `Dossier sélectionné : ${dirHandle.name}`;

    markers.forEach(m => map.removeLayer(m));
    markers.length = 0;

    let count = 0;

    for await (const entry of dirHandle.values()) {

      if (entry.kind === 'file' && entry.name.toLowerCase().endsWith('.html')) {

        const file = await entry.getFile();
        const text = await file.text();

        const coords = extractFirstLatLon(text);

        if (coords) {
          const marker = L.marker([coords.lat, coords.lon])
            .addTo(map)
            .bindPopup(entry.name);

          markers.push(marker);
          count++;
        }
      }
    }

    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), { padding: [30, 30] });
    }

    document.getElementById('status').textContent =
      `${count} randonnée(s) localisée(s)`;

  } catch (err) {
    console.error(err);
    document.getElementById('status').textContent =
      'Sélection annulée ou non autorisée';
  }
});
</script>

</body>
</html>
