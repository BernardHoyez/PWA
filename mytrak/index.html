<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MyTrak – Carte des randonnées</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body { margin:0; font-family: Arial, sans-serif; }
header { background:#2c3e50; color:white; padding:10px; }
#controls { padding:10px; }
#map { height: calc(100vh - 120px); }
button { padding:8px 14px; font-size:14px; }
#status { margin-top:8px; }
</style>
</head>

<body>

<header>
  <h2>MyTrak – Carte des randonnées</h2>
</header>

<div id="controls">
  <button id="selectFolder">Sélectionner le dossier "mes traces de randos"</button>
  <div id="status">Aucun dossier sélectionné</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================================
   CARTE IGN
================================ */
const map = L.map('map').setView([46.6, 2.4], 6);

L.tileLayer(
  'https://data.geopf.fr/wmts?' +
  'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
  '&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' +
  '&STYLE=normal&FORMAT=image/png' +
  '&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}',
  { attribution: '© IGN – Plan V2', maxZoom: 19 }
).addTo(map);

const markers = [];

/* ================================
   MÉTHODE 1 : const g = {...}
================================ */
function extractFromGeoJSON(html) {
  const match = html.match(/const\s+g\s*=\s*(\{[\s\S]*?\});/);
  if (!match) return null;

  try {
    const geojson = JSON.parse(match[1]);
    const coords = geojson.features?.[0]?.geometry?.coordinates;
    if (!coords || coords.length < 2) return null;

    return { lat: coords[1], lon: coords[0] };
  } catch {
    return null;
  }
}

/* ================================
   MÉTHODE 2 : coordonnées visibles
================================ */
function extractByRegex(html) {
  const regex = /(-?\d{1,3}\.\d+)\s*,\s*(-?\d{1,3}\.\d+)/g;
  let match;

  while ((match = regex.exec(html)) !== null) {
    const a = parseFloat(match[1]);
    const b = parseFloat(match[2]);

    if (Math.abs(a) <= 90 && Math.abs(b) <= 180)
      return { lat: a, lon: b };

    if (Math.abs(b) <= 90 && Math.abs(a) <= 180)
      return { lat: b, lon: a };
  }
  return null;
}

/* ================================
   TRAITEMENT DES FICHIERS
================================ */
document.getElementById('selectFolder').addEventListener('click', async () => {
  try {
    const dir = await window.showDirectoryPicker();
    markers.forEach(m => map.removeLayer(m));
    markers.length = 0;

    let total = 0;

    for await (const entry of dir.values()) {
      if (entry.kind !== 'file' || !entry.name.endsWith('.html')) continue;

      const file = await entry.getFile();
      const text = await file.text();

      let coords =
        extractFromGeoJSON(text) ||
        extractByRegex(text);

      if (coords) {
        const m = L.marker([coords.lat, coords.lon])
          .addTo(map)
          .bindPopup(entry.name);
        markers.push(m);
        total++;
      } else {
        console.warn('Aucune coordonnée trouvée :', entry.name);
      }
    }

    if (markers.length) {
      map.fitBounds(L.featureGroup(markers).getBounds(), { padding:[30,30] });
    }

    document.getElementById('status').textContent =
      `${total} randonnée(s) localisée(s)`;

  } catch (e) {
    document.getElementById('status').textContent = 'Sélection annulée';
  }
});
</script>

</body>
</html>
