<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>traceX – Drag & Drop</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body{margin:0;font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;height:100vh;display:flex;align-items:center;justify-content:center}
    #d{width:90%;max-width:600px;padding:60px;border:4px dashed #fff;border-radius:20px;text-align:center;cursor:not-allowed;transition:.3s;opacity:0.7}
    #d.ready{cursor:pointer;opacity:1}
    #d.dragover{background:#764ba2;transform:scale(1.05)}
    h1{font-size:3em;margin:0 0 20px}
    #s,#e{margin-top:20px;font-weight:bold}
    #e{color:#ffcccc;background:rgba(0,0,0,0.4);padding:5px 10px;border-radius:8px;display:inline-block}
  </style>
</head>
<body>

<div id="d">
  <h1>traceX</h1>
  <p id="msg">Chargement des outils…</p>
  <div id="s"></div>
  <div id="e"></div>
</div>

<input type="file" id="i" accept=".gpx,.kml" hidden>

<script src="app.js"></script>
<script>
  const d = document.getElementById('d');
  const i = document.getElementById('i');
  const s = document.getElementById('s');
  const e = document.getElementById('e');
  const msg = document.getElementById('msg');

  // On attend que window.generateHtml existe vraiment
  const waitForGenerateHtml = setInterval(() => {
    if (typeof window.generateHtml === 'function') {
      clearInterval(waitForGenerateHtml);
      msg.textContent = "Déposez un .gpx ou .kml ici – ou cliquez";
      d.classList.add('ready');
      activateDragAndDrop();
    }
  }, 50);

  function activateDragAndDrop() {
    d.ondragover = ev => { ev.preventDefault(); d.classList.add('dragover'); };
    d.ondragleave = () => d.classList.remove('dragover');
    d.ondrop = ev => {
      ev.preventDefault(); d.classList.remove('dragover');
      if (ev.dataTransfer.files[0]) go(ev.dataTransfer.files[0]);
    };
    d.onclick = () => i.click();
    i.onchange = () => { if (i.files[0]) go(i.files[0]); };
  }

  async function go(file) {
    if (!/\.(gpx|kml)$/i.test(file.name)) return e.textContent = "Seuls .gpx et .kml acceptés";
    s.textContent = "Conversion…"; e.textContent = "";
    try {
      await window.generateHtml(file);
      s.textContent = "Fichier généré et téléchargé !";
      setTimeout(() => s.textContent = "", 4000);
    } catch(err) {
      s.textContent = ""; e.textContent = "Erreur : " + err.message;
    }
  }
</script>
</body>
</html>